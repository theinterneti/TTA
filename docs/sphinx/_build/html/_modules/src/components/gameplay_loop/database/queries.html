

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.components.gameplay_loop.database.queries &mdash; TTA - Therapeutic Text Adventure 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom.css?v=c5250a58" />


      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../_static/copybutton.js?v=30646c52"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">mermaid.initialize({startOnLoad:true});</script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
</head>

<body class="wy-body-for-nav">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >



          <a href="../../../../../index.html" class="icon icon-home">
            TTA - Therapeutic Text Adventure
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../overview.html">Platform Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../api/modules.html">src</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../development/index.html">Development Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../testing/index.html">Testing Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../deployment/index.html">Deployment Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contributing.html">Contributing to TTA</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">TTA - Therapeutic Text Adventure</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">src.components.gameplay_loop.database.queries</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <h1>Source code for src.components.gameplay_loop.database.queries</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Neo4j Cypher Queries for Gameplay Loop</span>

<span class="sd">This module contains all Cypher queries used by the gameplay loop system,</span>
<span class="sd">organized by functional area for maintainability and reusability.</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="SessionQueries">
<a class="viewcode-back" href="../../../../../api/src.components.gameplay_loop.database.queries.html#src.components.gameplay_loop.database.SessionQueries">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SessionQueries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cypher queries for session management.&quot;&quot;&quot;</span>

    <span class="n">CREATE_SESSION</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    CREATE (s:Session {</span>
<span class="s2">        session_id: $session_id,</span>
<span class="s2">        user_id: $user_id,</span>
<span class="s2">        character_id: $character_id,</span>
<span class="s2">        world_id: $world_id,</span>
<span class="s2">        session_state: $session_state,</span>
<span class="s2">        therapeutic_goals: $therapeutic_goals,</span>
<span class="s2">        safety_level: $safety_level,</span>
<span class="s2">        created_at: $created_at,</span>
<span class="s2">        last_activity: $last_activity,</span>
<span class="s2">        session_metrics: $session_metrics</span>
<span class="s2">    })</span>
<span class="s2">    WITH s</span>
<span class="s2">    MATCH (u:User {user_id: $user_id})</span>
<span class="s2">    CREATE (u)-[:HAS_SESSION {created_at: $created_at}]-&gt;(s)</span>
<span class="s2">    RETURN s</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">UPDATE_SESSION_STATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (s:Session {session_id: $session_id})</span>
<span class="s2">    SET s.session_state = $new_state,</span>
<span class="s2">        s.last_activity = $last_activity</span>
<span class="s2">    SET s.completed_at = CASE WHEN $completed_at IS NOT NULL THEN $completed_at ELSE s.completed_at END</span>
<span class="s2">    RETURN s</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">GET_SESSION_BY_ID</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (s:Session {session_id: $session_id})</span>
<span class="s2">    RETURN s as session</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">GET_USER_SESSIONS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (u:User {user_id: $user_id})-[:HAS_SESSION]-&gt;(s:Session)</span>
<span class="s2">    RETURN s as session</span>
<span class="s2">    ORDER BY s.created_at DESC</span>
<span class="s2">    LIMIT $limit</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">GET_ACTIVE_SESSIONS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (s:Session)</span>
<span class="s2">    WHERE s.session_state IN [&#39;active&#39;, &#39;paused&#39;]</span>
<span class="s2">    RETURN s as session</span>
<span class="s2">    ORDER BY s.last_activity DESC</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">GET_SESSION_STATISTICS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (u:User {user_id: $user_id})-[:HAS_SESSION]-&gt;(s:Session)</span>
<span class="s2">    RETURN</span>
<span class="s2">        count(s) as total_sessions,</span>
<span class="s2">        count(CASE WHEN s.session_state = &#39;completed&#39; THEN 1 END) as completed_sessions,</span>
<span class="s2">        avg(duration.inSeconds(datetime(s.created_at), datetime(s.completed_at)).seconds) as avg_session_duration,</span>
<span class="s2">        max(s.created_at) as last_session_date</span>
<span class="s2">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="NarrativeQueries">
<a class="viewcode-back" href="../../../../../api/src.components.gameplay_loop.database.queries.html#src.components.gameplay_loop.database.NarrativeQueries">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NarrativeQueries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cypher queries for narrative management.&quot;&quot;&quot;</span>

    <span class="n">CREATE_SCENE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    CREATE (sc:Scene {</span>
<span class="s2">        scene_id: $scene_id,</span>
<span class="s2">        session_id: $session_id,</span>
<span class="s2">        title: $title,</span>
<span class="s2">        description: $description,</span>
<span class="s2">        narrative_content: $narrative_content,</span>
<span class="s2">        scene_type: $scene_type,</span>
<span class="s2">        therapeutic_focus: $therapeutic_focus,</span>
<span class="s2">        emotional_tone: $emotional_tone,</span>
<span class="s2">        scene_objectives: $scene_objectives,</span>
<span class="s2">        completion_criteria: $completion_criteria,</span>
<span class="s2">        safety_considerations: $safety_considerations,</span>
<span class="s2">        created_at: $created_at,</span>
<span class="s2">        completed_at: $completed_at</span>
<span class="s2">    })</span>
<span class="s2">    WITH sc</span>
<span class="s2">    MATCH (s:Session {session_id: $session_id})</span>
<span class="s2">    CREATE (s)-[:HAS_SCENE {created_at: $created_at}]-&gt;(sc)</span>
<span class="s2">    RETURN sc</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">CREATE_CHOICE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    CREATE (c:Choice {</span>
<span class="s2">        choice_id: $choice_id,</span>
<span class="s2">        scene_id: $scene_id,</span>
<span class="s2">        choice_text: $choice_text,</span>
<span class="s2">        choice_type: $choice_type,</span>
<span class="s2">        therapeutic_relevance: $therapeutic_relevance,</span>
<span class="s2">        emotional_weight: $emotional_weight,</span>
<span class="s2">        difficulty_level: $difficulty_level,</span>
<span class="s2">        prerequisites: $prerequisites,</span>
<span class="s2">        metadata: $metadata,</span>
<span class="s2">        timestamp: $timestamp</span>
<span class="s2">    })</span>
<span class="s2">    WITH c</span>
<span class="s2">    MATCH (sc:Scene {scene_id: $scene_id})</span>
<span class="s2">    CREATE (sc)-[:HAS_CHOICE {created_at: $timestamp}]-&gt;(c)</span>
<span class="s2">    RETURN c</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">CREATE_NARRATIVE_FLOW</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (from:Scene {scene_id: $from_scene_id})</span>
<span class="s2">    MATCH (to:Scene {scene_id: $to_scene_id})</span>
<span class="s2">    CREATE (from)-[r:LEADS_TO {</span>
<span class="s2">        created_at: $created_at,</span>
<span class="s2">        choice_id: $choice_id</span>
<span class="s2">    }]-&gt;(to)</span>
<span class="s2">    SET r += $flow_properties</span>
<span class="s2">    RETURN r</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">GET_SCENE_CHOICES</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (sc:Scene {scene_id: $scene_id})-[:HAS_CHOICE]-&gt;(c:Choice)</span>
<span class="s2">    RETURN c as choice</span>
<span class="s2">    ORDER BY c.timestamp ASC</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">GET_NARRATIVE_PATH</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (s:Session {session_id: $session_id})-[:HAS_SCENE]-&gt;(sc:Scene)</span>
<span class="s2">    OPTIONAL MATCH (sc)-[r:LEADS_TO]-&gt;(next:Scene)</span>
<span class="s2">    RETURN sc as scene, r as flow, next as next_scene</span>
<span class="s2">    ORDER BY sc.created_at ASC</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">GET_SCENE_THERAPEUTIC_CONTENT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (sc:Scene {scene_id: $scene_id})</span>
<span class="s2">    OPTIONAL MATCH (sc)-[:ADDRESSES_GOAL]-&gt;(tg:TherapeuticGoal)</span>
<span class="s2">    OPTIONAL MATCH (sc)-[:PRACTICES_SKILL]-&gt;(sk:Skill)</span>
<span class="s2">    RETURN sc as scene, collect(DISTINCT tg) as therapeutic_goals, collect(DISTINCT sk) as skills</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">FIND_SIMILAR_SCENES</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (sc:Scene {scene_id: $scene_id})</span>
<span class="s2">    MATCH (other:Scene)</span>
<span class="s2">    WHERE other.scene_id &lt;&gt; $scene_id</span>
<span class="s2">    AND any(focus IN sc.therapeutic_focus WHERE focus IN other.therapeutic_focus)</span>
<span class="s2">    WITH other,</span>
<span class="s2">         size([x IN sc.therapeutic_focus WHERE x IN other.therapeutic_focus]) as common_focus,</span>
<span class="s2">         size(sc.therapeutic_focus + other.therapeutic_focus) as total_focus</span>
<span class="s2">    RETURN other as scene,</span>
<span class="s2">           toFloat(common_focus) / total_focus as similarity_score</span>
<span class="s2">    ORDER BY similarity_score DESC</span>
<span class="s2">    LIMIT $limit</span>
<span class="s2">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="ProgressQueries">
<a class="viewcode-back" href="../../../../../api/src.components.gameplay_loop.database.queries.html#src.components.gameplay_loop.database.ProgressQueries">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ProgressQueries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cypher queries for progress tracking.&quot;&quot;&quot;</span>

    <span class="n">CREATE_PROGRESS_METRIC</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    CREATE (pm:ProgressMetric {</span>
<span class="s2">        metric_id: $metric_id,</span>
<span class="s2">        user_id: $user_id,</span>
<span class="s2">        metric_name: $metric_name,</span>
<span class="s2">        progress_type: $progress_type,</span>
<span class="s2">        current_value: $current_value,</span>
<span class="s2">        baseline_value: $baseline_value,</span>
<span class="s2">        target_value: $target_value,</span>
<span class="s2">        measurement_unit: $measurement_unit,</span>
<span class="s2">        measurement_method: $measurement_method,</span>
<span class="s2">        confidence_level: $confidence_level,</span>
<span class="s2">        last_updated: $last_updated</span>
<span class="s2">    })</span>
<span class="s2">    WITH pm</span>
<span class="s2">    MATCH (u:User {user_id: $user_id})</span>
<span class="s2">    CREATE (u)-[:TRACKS_PROGRESS {created_at: $last_updated}]-&gt;(pm)</span>
<span class="s2">    RETURN pm</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">UPDATE_PROGRESS_METRIC</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (pm:ProgressMetric {metric_id: $metric_id})</span>
<span class="s2">    SET pm.current_value = $new_value,</span>
<span class="s2">        pm.last_updated = $last_updated</span>
<span class="s2">    SET pm.confidence_level = CASE WHEN $confidence_level IS NOT NULL THEN $confidence_level ELSE pm.confidence_level END</span>
<span class="s2">    RETURN pm</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">GET_USER_PROGRESS_METRICS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (u:User {user_id: $user_id})-[:TRACKS_PROGRESS]-&gt;(pm:ProgressMetric)</span>
<span class="s2">    WHERE $progress_type IS NULL OR pm.progress_type = $progress_type</span>
<span class="s2">    RETURN pm as metric</span>
<span class="s2">    ORDER BY pm.last_updated DESC</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">CREATE_SKILL_DEVELOPMENT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    CREATE (sd:SkillDevelopment {</span>
<span class="s2">        skill_id: $skill_id,</span>
<span class="s2">        user_id: $user_id,</span>
<span class="s2">        skill_name: $skill_name,</span>
<span class="s2">        skill_category: $skill_category,</span>
<span class="s2">        current_level: $current_level,</span>
<span class="s2">        proficiency_score: $proficiency_score,</span>
<span class="s2">        practice_sessions: $practice_sessions,</span>
<span class="s2">        successful_applications: $successful_applications,</span>
<span class="s2">        learning_objectives: $learning_objectives,</span>
<span class="s2">        completed_objectives: $completed_objectives,</span>
<span class="s2">        created_at: $created_at,</span>
<span class="s2">        last_practiced: $last_practiced</span>
<span class="s2">    })</span>
<span class="s2">    WITH sd</span>
<span class="s2">    MATCH (u:User {user_id: $user_id})</span>
<span class="s2">    CREATE (u)-[:DEVELOPS_SKILL {created_at: $created_at}]-&gt;(sd)</span>
<span class="s2">    RETURN sd</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">UPDATE_SKILL_PROFICIENCY</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (sd:SkillDevelopment {skill_id: $skill_id})</span>
<span class="s2">    SET sd.proficiency_score = $new_proficiency,</span>
<span class="s2">        sd.current_level = $new_level,</span>
<span class="s2">        sd.practice_sessions = sd.practice_sessions + 1,</span>
<span class="s2">        sd.last_practiced = $practiced_at</span>
<span class="s2">    RETURN sd</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">GET_SKILL_PROGRESS_TREND</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (u:User {user_id: $user_id})-[:DEVELOPS_SKILL]-&gt;(sd:SkillDevelopment {skill_id: $skill_id})</span>
<span class="s2">    MATCH (sd)-[:MEASURED_BY]-&gt;(measurement)</span>
<span class="s2">    RETURN measurement.timestamp as timestamp, measurement.proficiency_score as score</span>
<span class="s2">    ORDER BY measurement.timestamp ASC</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">CREATE_MILESTONE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    CREATE (m:Milestone {</span>
<span class="s2">        milestone_id: $milestone_id,</span>
<span class="s2">        user_id: $user_id,</span>
<span class="s2">        milestone_type: $milestone_type,</span>
<span class="s2">        title: $title,</span>
<span class="s2">        description: $description,</span>
<span class="s2">        therapeutic_significance: $therapeutic_significance,</span>
<span class="s2">        achieved_at: $achieved_at,</span>
<span class="s2">        related_skills: $related_skills,</span>
<span class="s2">        related_goals: $related_goals</span>
<span class="s2">    })</span>
<span class="s2">    WITH m</span>
<span class="s2">    MATCH (u:User {user_id: $user_id})</span>
<span class="s2">    CREATE (u)-[:ACHIEVES_MILESTONE {achieved_at: $achieved_at}]-&gt;(m)</span>
<span class="s2">    RETURN m</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">GET_USER_MILESTONES</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (u:User {user_id: $user_id})-[:ACHIEVES_MILESTONE]-&gt;(m:Milestone)</span>
<span class="s2">    WHERE datetime(m.achieved_at) &gt;= datetime($since_date)</span>
<span class="s2">    RETURN m as milestone</span>
<span class="s2">    ORDER BY m.achieved_at DESC</span>
<span class="s2">    LIMIT $limit</span>
<span class="s2">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="ValidationQueries">
<a class="viewcode-back" href="../../../../../api/src.components.gameplay_loop.database.queries.html#src.components.gameplay_loop.database.ValidationQueries">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ValidationQueries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cypher queries for validation and safety checks.&quot;&quot;&quot;</span>

    <span class="n">CREATE_SAFETY_CHECK</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    CREATE (sc:SafetyCheck {</span>
<span class="s2">        check_id: $check_id,</span>
<span class="s2">        content_id: $content_id,</span>
<span class="s2">        safety_level: $safety_level,</span>
<span class="s2">        safety_score: $safety_score,</span>
<span class="s2">        risk_factors: $risk_factors,</span>
<span class="s2">        protective_factors: $protective_factors,</span>
<span class="s2">        crisis_indicators: $crisis_indicators,</span>
<span class="s2">        intervention_recommendations: $intervention_recommendations,</span>
<span class="s2">        requires_human_review: $requires_human_review,</span>
<span class="s2">        checked_at: $checked_at</span>
<span class="s2">    })</span>
<span class="s2">    RETURN sc</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">GET_CONTENT_SAFETY_HISTORY</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (sc:SafetyCheck {content_id: $content_id})</span>
<span class="s2">    RETURN sc as safety_check</span>
<span class="s2">    ORDER BY sc.checked_at DESC</span>
<span class="s2">    LIMIT $limit</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">CREATE_VALIDATION_RULE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    CREATE (vr:ValidationRule {</span>
<span class="s2">        rule_id: $rule_id,</span>
<span class="s2">        rule_name: $rule_name,</span>
<span class="s2">        rule_type: $rule_type,</span>
<span class="s2">        description: $description,</span>
<span class="s2">        validation_criteria: $validation_criteria,</span>
<span class="s2">        severity_level: $severity_level,</span>
<span class="s2">        is_active: $is_active,</span>
<span class="s2">        therapeutic_context: $therapeutic_context,</span>
<span class="s2">        created_at: $created_at</span>
<span class="s2">    })</span>
<span class="s2">    RETURN vr</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">GET_APPLICABLE_VALIDATION_RULES</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (vr:ValidationRule)</span>
<span class="s2">    WHERE vr.is_active = true</span>
<span class="s2">    AND ($therapeutic_context IS NULL OR any(ctx IN vr.therapeutic_context WHERE ctx IN $therapeutic_context))</span>
<span class="s2">    RETURN vr as rule</span>
<span class="s2">    ORDER BY vr.severity_level DESC</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">CREATE_THERAPEUTIC_ALIGNMENT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    CREATE (ta:TherapeuticAlignment {</span>
<span class="s2">        alignment_id: $alignment_id,</span>
<span class="s2">        content_id: $content_id,</span>
<span class="s2">        alignment_type: $alignment_type,</span>
<span class="s2">        alignment_score: $alignment_score,</span>
<span class="s2">        therapeutic_goals: $therapeutic_goals,</span>
<span class="s2">        supported_skills: $supported_skills,</span>
<span class="s2">        emotional_benefits: $emotional_benefits,</span>
<span class="s2">        contraindications: $contraindications,</span>
<span class="s2">        assessed_at: $assessed_at</span>
<span class="s2">    })</span>
<span class="s2">    RETURN ta</span>
<span class="s2">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="AnalyticsQueries">
<a class="viewcode-back" href="../../../../../api/src.components.gameplay_loop.database.queries.html#src.components.gameplay_loop.database.AnalyticsQueries">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AnalyticsQueries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cypher queries for analytics and insights.&quot;&quot;&quot;</span>

    <span class="n">GET_USER_ENGAGEMENT_METRICS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (u:User {user_id: $user_id})-[:HAS_SESSION]-&gt;(s:Session)</span>
<span class="s2">    OPTIONAL MATCH (s)-[:HAS_SCENE]-&gt;(sc:Scene)</span>
<span class="s2">    OPTIONAL MATCH (sc)-[:HAS_CHOICE]-&gt;(c:Choice)</span>
<span class="s2">    RETURN</span>
<span class="s2">        count(DISTINCT s) as total_sessions,</span>
<span class="s2">        count(DISTINCT sc) as total_scenes,</span>
<span class="s2">        count(DISTINCT c) as total_choices,</span>
<span class="s2">        avg(s.session_metrics.engagement_score) as avg_engagement,</span>
<span class="s2">        avg(s.session_metrics.therapeutic_alignment_score) as avg_therapeutic_alignment</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">GET_THERAPEUTIC_EFFECTIVENESS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (u:User {user_id: $user_id})-[:TRACKS_PROGRESS]-&gt;(pm:ProgressMetric)</span>
<span class="s2">    WITH u, pm,</span>
<span class="s2">         (pm.current_value - pm.baseline_value) / (pm.target_value - pm.baseline_value) as progress_ratio</span>
<span class="s2">    RETURN</span>
<span class="s2">        pm.progress_type as progress_type,</span>
<span class="s2">        avg(progress_ratio) as avg_progress,</span>
<span class="s2">        count(pm) as metric_count,</span>
<span class="s2">        sum(CASE WHEN progress_ratio &gt; 0 THEN 1 ELSE 0 END) as improving_metrics</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">GET_NARRATIVE_FLOW_ANALYSIS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (s:Session {session_id: $session_id})-[:HAS_SCENE]-&gt;(sc:Scene)</span>
<span class="s2">    OPTIONAL MATCH (sc)-[r:LEADS_TO]-&gt;(next:Scene)</span>
<span class="s2">    RETURN</span>
<span class="s2">        sc.scene_id as scene_id,</span>
<span class="s2">        sc.scene_type as scene_type,</span>
<span class="s2">        sc.therapeutic_focus as therapeutic_focus,</span>
<span class="s2">        collect(next.scene_id) as next_scenes,</span>
<span class="s2">        count(r) as outgoing_paths</span>
<span class="s2">    ORDER BY sc.created_at ASC</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">FIND_THERAPEUTIC_PATTERNS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (u:User {user_id: $user_id})-[:HAS_SESSION]-&gt;(s:Session)-[:HAS_SCENE]-&gt;(sc:Scene)</span>
<span class="s2">    WHERE any(focus IN sc.therapeutic_focus WHERE focus = $therapeutic_focus)</span>
<span class="s2">    MATCH (sc)-[:HAS_CHOICE]-&gt;(c:Choice)</span>
<span class="s2">    RETURN</span>
<span class="s2">        sc.scene_type as scene_type,</span>
<span class="s2">        c.choice_type as choice_type,</span>
<span class="s2">        avg(c.therapeutic_relevance) as avg_therapeutic_relevance,</span>
<span class="s2">        count(c) as choice_count</span>
<span class="s2">    ORDER BY avg_therapeutic_relevance DESC</span>
<span class="s2">    &quot;&quot;&quot;</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, TTA Development Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

</body>
</html>
