============================= test session starts ==============================
platform linux -- Python 3.11.12, pytest-8.4.1, pluggy-1.6.0 -- /home/thein/projects/projects/TTA/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /home/thein/projects/projects/TTA
configfile: pytest.ini
testpaths: tests
plugins: xdist-3.8.0, timeout-2.4.0, asyncio-1.1.0, anyio-4.10.0, rerunfailures-15.1, order-1.3.0, rich-0.2.0
asyncio: mode=Mode.STRICT, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 502 items

tests/test_api_integration.py::test_server_startup_and_basic_endpoints PASSED [  0%]
tests/test_api_integration.py::test_authentication_flow FAILED           [  0%]
tests/test_api_integration.py::test_protected_endpoints_require_auth PASSED [  0%]
tests/test_api_integration.py::test_middleware_functionality PASSED      [  0%]
tests/test_api_integration.py::test_cors_configuration PASSED            [  0%]
tests/test_api_integration.py::test_error_handling PASSED                [  1%]
tests/test_api_integration.py::test_async_functionality PASSED           [  1%]
tests/test_api_structure.py::test_root_endpoint PASSED                   [  1%]
tests/test_api_structure.py::test_health_endpoint PASSED                 [  1%]
tests/test_api_structure.py::test_security_headers PASSED                [  1%]
tests/test_api_structure.py::test_cors_headers PASSED                    [  2%]
tests/test_api_structure.py::test_rate_limiting_headers PASSED           [  2%]
tests/test_api_structure.py::test_processing_time_header PASSED          [  2%]
tests/test_api_structure.py::test_therapeutic_safety_headers PASSED      [  2%]
tests/test_api_structure.py::test_auth_router_included FAILED            [  2%]
tests/test_api_structure.py::test_players_router_included PASSED         [  3%]
tests/test_api_structure.py::test_characters_router_included PASSED      [  3%]
tests/test_api_structure.py::test_worlds_router_included PASSED          [  3%]
tests/test_api_structure.py::test_openapi_docs_available PASSED          [  3%]
tests/test_api_structure.py::test_authentication_middleware_public_routes PASSED [  3%]
tests/test_api_structure.py::test_authentication_middleware_protected_routes PASSED [  4%]
tests/test_api_structure.py::test_invalid_authorization_header PASSED    [  4%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManager::test_create_character_invalid_data PASSED [  4%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManager::test_create_character_limit_exceeded PASSED [  4%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManager::test_create_character_success PASSED [  4%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManager::test_delete_character PASSED [  5%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManager::test_extract_personality_traits PASSED [  5%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManager::test_get_character PASSED [  5%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManager::test_get_character_statistics PASSED [  5%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManager::test_get_character_therapeutic_profile PASSED [  5%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManager::test_get_player_characters PASSED [  6%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManager::test_update_character PASSED [  6%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManager::test_update_character_therapeutic_profile PASSED [  6%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManagerIntegration::test_adapt_therapeutic_content_for_character PASSED [  6%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManagerIntegration::test_create_character_calls_development_system PASSED [  6%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManagerIntegration::test_create_character_calls_personalization_engine PASSED [  7%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManagerIntegration::test_get_character_personalization_recommendations PASSED [  7%]
tests/test_character_avatar_manager.py::TestCharacterAvatarManagerIntegration::test_update_character_calls_personalization_engine PASSED [  7%]
tests/test_character_management_api.py::test_characters_root_requires_auth PASSED [  7%]
tests/test_character_management_api.py::test_list_characters_requires_auth PASSED [  7%]
tests/test_character_management_api.py::test_get_character_requires_auth PASSED [  8%]
tests/test_character_management_api.py::test_update_therapeutic_profile_requires_auth PASSED [  8%]
tests/test_compatibility_checker.py::TestCompatibilityChecker::test_comprehensive_compatibility_calculation PASSED [  8%]
tests/test_compatibility_checker.py::TestCompatibilityChecker::test_content_safety_compatibility PASSED [  8%]
tests/test_compatibility_checker.py::TestCompatibilityChecker::test_custom_weights PASSED [  8%]
tests/test_compatibility_checker.py::TestCompatibilityChecker::test_difficulty_appropriateness PASSED [  9%]
tests/test_compatibility_checker.py::TestCompatibilityChecker::test_edge_cases PASSED [  9%]
tests/test_compatibility_checker.py::TestCompatibilityChecker::test_initialization PASSED [  9%]
tests/test_compatibility_checker.py::TestCompatibilityChecker::test_prerequisite_fulfillment PASSED [  9%]
tests/test_compatibility_checker.py::TestCompatibilityChecker::test_recommendations_and_warnings_generation PASSED [  9%]
tests/test_compatibility_checker.py::TestCompatibilityChecker::test_therapeutic_approach_alignment PASSED [ 10%]
tests/test_compatibility_checker.py::TestCompatibilityChecker::test_therapeutic_readiness_compatibility PASSED [ 10%]
tests/test_compatibility_checker.py::TestCompatibilityChecker::test_world_recommendations PASSED [ 10%]
tests/test_compatibility_checker.py::TestCompatibilityChecker::test_world_suitability_assessment PASSED [ 10%]
tests/test_components.py::TestComponents::test_carbon_component PASSED   [ 10%]
tests/test_components.py::TestComponents::test_config_validation PASSED  [ 11%]
tests/test_components.py::TestComponents::test_docker_component PASSED   [ 11%]
tests/test_end_to_end_workflows.py::TestEndToEndUserWorkflows::test_complete_new_user_journey FAILED [ 11%]
tests/test_end_to_end_workflows.py::TestEndToEndUserWorkflows::test_multi_character_workflow FAILED [ 11%]
tests/test_end_to_end_workflows.py::TestEndToEndUserWorkflows::test_therapeutic_settings_adaptation_workflow FAILED [ 11%]
tests/test_end_to_end_workflows.py::TestConcurrentUserScenarios::test_concurrent_websocket_connections PASSED [ 12%]
tests/test_end_to_end_workflows.py::TestConcurrentUserScenarios::test_concurrent_api_requests FAILED [ 12%]
tests/test_end_to_end_workflows.py::TestConcurrentUserScenarios::test_session_state_consistency_under_load FAILED [ 12%]
tests/test_end_to_end_workflows.py::TestErrorHandlingAndRecovery::test_network_interruption_recovery PASSED [ 12%]
tests/test_end_to_end_workflows.py::TestErrorHandlingAndRecovery::test_invalid_data_handling FAILED [ 12%]
tests/test_end_to_end_workflows.py::TestErrorHandlingAndRecovery::test_authentication_failure_recovery FAILED [ 13%]
tests/test_enhanced_authentication.py::TestSecurityService::test_password_strength_validation PASSED [ 13%]
tests/test_enhanced_authentication.py::TestSecurityService::test_password_hashing PASSED [ 13%]
tests/test_enhanced_authentication.py::TestSecurityService::test_secure_token_generation PASSED [ 13%]
tests/test_enhanced_authentication.py::TestSecurityService::test_backup_codes_generation PASSED [ 13%]
tests/test_enhanced_authentication.py::TestMFAService::test_totp_secret_generation PASSED [ 14%]
tests/test_enhanced_authentication.py::TestMFAService::test_totp_code_verification PASSED [ 14%]
tests/test_enhanced_authentication.py::TestMFAService::test_mfa_challenge_creation PASSED [ 14%]
tests/test_enhanced_authentication.py::TestMFAService::test_mfa_challenge_cleanup PASSED [ 14%]
tests/test_enhanced_authentication.py::TestEnhancedAuthService::test_user_registration_validation PASSED [ 14%]
tests/test_enhanced_authentication.py::TestEnhancedAuthService::test_account_lockout PASSED [ 15%]
tests/test_enhanced_authentication.py::TestEnhancedAuthService::test_session_management PASSED [ 15%]
tests/test_enhanced_authentication.py::TestEnhancedAuthService::test_access_token_creation_and_verification PASSED [ 15%]
tests/test_enhanced_authentication.py::TestEnhancedAuthService::test_permission_checking PASSED [ 15%]
tests/test_enhanced_authentication.py::TestEnhancedAuthService::test_mfa_setup PASSED [ 15%]
tests/test_enhanced_authentication.py::TestEnhancedAuthService::test_session_cleanup PASSED [ 16%]
tests/test_enhanced_authentication.py::TestEnhancedAuthService::test_security_event_logging PASSED [ 16%]
tests/test_enhanced_authentication.py::TestAuthenticationAPI::test_register_endpoint PASSED [ 16%]
tests/test_enhanced_authentication.py::TestAuthenticationAPI::test_login_endpoint PASSED [ 16%]
tests/test_enhanced_authentication.py::TestAuthenticationAPI::test_mfa_setup_endpoint_requires_auth PASSED [ 16%]
tests/test_enhanced_authentication.py::TestAuthenticationAPI::test_permissions_endpoint_requires_auth PASSED [ 17%]
tests/test_enhanced_authentication.py::TestAuthenticationAPI::test_security_events_endpoint_requires_admin PASSED [ 17%]
tests/test_enhanced_authentication.py::TestRoleBasedAccessControl::test_default_role_permissions PASSED [ 17%]
tests/test_enhanced_authentication.py::TestRoleBasedAccessControl::test_authenticated_user_permission_methods PASSED [ 17%]
tests/test_enhanced_authentication.py::TestRoleBasedAccessControl::test_admin_user_permissions PASSED [ 17%]
tests/test_models_compatibility.py::test_narrative_coherence_models_importable PASSED [ 18%]
tests/test_models_compatibility.py::test_narrative_arc_models_importable PASSED [ 18%]
tests/test_narrative_arc_orchestrator_component.py::TestNarrativeArcOrchestratorComponent::test_component_configuration PASSED [ 18%]
tests/test_narrative_arc_orchestrator_component.py::TestNarrativeArcOrchestratorComponent::test_component_initialization PASSED [ 18%]
tests/test_narrative_arc_orchestrator_component.py::TestNarrativeArcOrchestratorComponent::test_component_start_stop PASSED [ 18%]
tests/test_narrative_arc_orchestrator_component.py::TestNarrativeArcOrchestratorComponent::test_emergent_event_creation PASSED [ 19%]
tests/test_narrative_arc_orchestrator_component.py::TestNarrativeArcOrchestratorComponent::test_narrative_response_creation PASSED [ 19%]
tests/test_narrative_arc_orchestrator_component.py::TestNarrativeArcOrchestratorComponent::test_narrative_status_creation PASSED [ 19%]
tests/test_narrative_arc_orchestrator_component.py::TestNarrativeArcOrchestratorComponent::test_player_choice_creation PASSED [ 19%]
tests/test_narrative_arc_orchestrator_component.py::TestNarrativeArcOrchestratorAsyncMethods::test_advance_narrative_scales PASSED [ 19%]
tests/test_narrative_arc_orchestrator_component.py::TestNarrativeArcOrchestratorAsyncMethods::test_emergent_event_nonexistent_session PASSED [ 20%]
tests/test_narrative_arc_orchestrator_component.py::TestNarrativeArcOrchestratorAsyncMethods::test_get_narrative_status PASSED [ 20%]
tests/test_narrative_arc_orchestrator_component.py::TestNarrativeArcOrchestratorAsyncMethods::test_get_status_nonexistent_session PASSED [ 20%]
tests/test_narrative_arc_orchestrator_component.py::TestNarrativeArcOrchestratorAsyncMethods::test_process_invalid_choice PASSED [ 20%]
tests/test_narrative_arc_orchestrator_component.py::TestNarrativeArcOrchestratorAsyncMethods::test_process_player_choice PASSED [ 20%]
tests/test_narrative_arc_orchestrator_component.py::TestNarrativeArcOrchestratorAsyncMethods::test_trigger_emergent_event PASSED [ 21%]
tests/test_narrative_coherence_engine.py::test_narrative_coherence_engine_imports PASSED [ 21%]
tests/test_narrative_coherence_engine.py::test_validation_severity_enum PASSED [ 21%]
tests/test_narrative_coherence_engine.py::test_narrative_content_creation PASSED [ 21%]
tests/test_narrative_coherence_engine.py::test_contradiction_creation PASSED [ 21%]
tests/test_narrative_coherence_engine.py::test_conflict_resolution_mechanisms PASSED [ 22%]
tests/test_narrative_coherence_engine.py::test_task_4_2_completion PASSED [ 22%]
tests/test_orchestrator.py::TestOrchestrator::test_component_dependencies PASSED [ 22%]
tests/test_orchestrator.py::TestOrchestrator::test_component_registration PASSED [ 22%]
tests/test_orchestrator.py::TestOrchestrator::test_config_initialization PASSED [ 22%]
tests/test_orchestrator.py::TestOrchestrator::test_orchestrator_initialization PASSED [ 23%]
tests/test_personalization_service_manager.py::TestCrisisDetectionSystem::test_crisis_detection_context_based PASSED [ 23%]
tests/test_personalization_service_manager.py::TestCrisisDetectionSystem::test_crisis_detection_no_crisis PASSED [ 23%]
tests/test_personalization_service_manager.py::TestCrisisDetectionSystem::test_crisis_detection_panic_attack PASSED [ 23%]
tests/test_personalization_service_manager.py::TestCrisisDetectionSystem::test_crisis_detection_self_harm PASSED [ 23%]
tests/test_personalization_service_manager.py::TestCrisisDetectionSystem::test_crisis_detection_suicidal_ideation PASSED [ 24%]
tests/test_personalization_service_manager.py::TestCrisisDetectionSystem::test_crisis_resources_initialization PASSED [ 24%]
tests/test_personalization_service_manager.py::TestCrisisDetectionSystem::test_get_crisis_resources_emergency_only PASSED [ 24%]
tests/test_personalization_service_manager.py::TestCrisisDetectionSystem::test_get_crisis_resources_suicidal PASSED [ 24%]
tests/test_personalization_service_manager.py::TestPlayerFeedback::test_feedback_auto_id_generation PASSED [ 24%]
tests/test_personalization_service_manager.py::TestPlayerFeedback::test_feedback_creation PASSED [ 25%]
tests/test_personalization_service_manager.py::TestAdaptationResult::test_adaptation_result_auto_id PASSED [ 25%]
tests/test_personalization_service_manager.py::TestAdaptationResult::test_adaptation_result_creation PASSED [ 25%]
tests/test_personalization_service_manager.py::TestAdaptationResult::test_adaptation_result_validation PASSED [ 25%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_adaptation_history_storage PASSED [ 25%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_detect_crisis_situation PASSED [ 26%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_detect_crisis_situation_no_crisis PASSED [ 26%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_feedback_history_storage PASSED [ 26%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_get_adaptive_recommendations_no_history PASSED [ 26%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_get_adaptive_recommendations_with_context PASSED [ 26%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_get_crisis_support_resources PASSED [ 27%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_get_crisis_support_resources_emergency_only PASSED [ 27%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_manager_initialization PASSED [ 27%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_process_crisis_feedback PASSED [ 27%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_process_preference_feedback PASSED [ 27%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_process_rating_feedback PASSED [ 28%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_process_text_feedback PASSED [ 28%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_recommendations_with_feedback_history PASSED [ 28%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_update_therapeutic_settings_critical_conflicts PASSED [ 28%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_update_therapeutic_settings_valid PASSED [ 28%]
tests/test_personalization_service_manager.py::TestPersonalizationServiceManager::test_update_therapeutic_settings_with_conflicts PASSED [ 29%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_component_decorators_integration PASSED [ 29%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_component_initialization PASSED [ 29%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_component_registration_in_orchestrator PASSED [ 29%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_component_start_integration FAILED [ 29%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_component_stop_integration FAILED [ 30%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_configuration_integration PASSED [ 30%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_configuration_validation PASSED [ 30%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_container_status_checking PASSED [ 30%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_dependency_health_checking PASSED [ 30%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_docker_compose_integration PASSED [ 31%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_error_handling_integration FAILED [ 31%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_health_status_integration PASSED [ 31%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_monitoring_metrics_integration PASSED [ 31%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_orchestrator_component_lifecycle FAILED [ 31%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceOrchestrationWorkflow::test_component_status_reporting PASSED [ 32%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceOrchestrationWorkflow::test_full_system_startup_workflow PASSED [ 32%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceOrchestrationWorkflow::test_orchestrator_start_component_integration FAILED [ 32%]
tests/test_player_experience_component_integration.py::TestPlayerExperienceOrchestrationWorkflow::test_orchestrator_stop_component_integration PASSED [ 32%]
tests/test_player_experience_manager.py::TestPlayerExperienceManager::test_crisis_detection_integration PASSED [ 32%]
tests/test_player_experience_manager.py::TestPlayerExperienceManager::test_dashboard_aggregation PASSED [ 33%]
tests/test_player_experience_manager.py::TestPlayerExperienceManager::test_feedback_processing PASSED [ 33%]
tests/test_player_experience_manager.py::TestPlayerExperienceManager::test_recommendations_combined PASSED [ 33%]
tests/test_player_experience_models.py::TestPlayerModels::test_player_character_management PASSED [ 33%]
tests/test_player_experience_models.py::TestPlayerModels::test_player_profile_creation PASSED [ 33%]
tests/test_player_experience_models.py::TestPlayerModels::test_player_profile_validation PASSED [ 34%]
tests/test_player_experience_models.py::TestPlayerModels::test_privacy_settings_creation PASSED [ 34%]
tests/test_player_experience_models.py::TestPlayerModels::test_privacy_settings_validation PASSED [ 34%]
tests/test_player_experience_models.py::TestPlayerModels::test_therapeutic_preferences_creation PASSED [ 34%]
tests/test_player_experience_models.py::TestPlayerModels::test_therapeutic_preferences_validation PASSED [ 34%]
tests/test_player_experience_models.py::TestCharacterModels::test_character_appearance_creation PASSED [ 35%]
tests/test_player_experience_models.py::TestCharacterModels::test_character_appearance_validation PASSED [ 35%]
tests/test_player_experience_models.py::TestCharacterModels::test_character_background_creation PASSED [ 35%]
tests/test_player_experience_models.py::TestCharacterModels::test_character_background_validation PASSED [ 35%]
tests/test_player_experience_models.py::TestCharacterModels::test_character_creation PASSED [ 35%]
tests/test_player_experience_models.py::TestCharacterModels::test_therapeutic_goal_creation PASSED [ 36%]
tests/test_player_experience_models.py::TestCharacterModels::test_therapeutic_goal_validation PASSED [ 36%]
tests/test_player_experience_models.py::TestCharacterModels::test_therapeutic_profile_creation PASSED [ 36%]
tests/test_player_experience_models.py::TestWorldModels::test_compatibility_report_creation PASSED [ 36%]
tests/test_player_experience_models.py::TestWorldModels::test_world_parameters_creation PASSED [ 36%]
tests/test_player_experience_models.py::TestWorldModels::test_world_parameters_validation PASSED [ 37%]
tests/test_player_experience_models.py::TestWorldModels::test_world_summary_creation PASSED [ 37%]
tests/test_player_experience_models.py::TestSessionModels::test_progress_marker_creation PASSED [ 37%]
tests/test_player_experience_models.py::TestSessionModels::test_session_context_creation PASSED [ 37%]
tests/test_player_experience_models.py::TestSessionModels::test_therapeutic_settings_creation PASSED [ 37%]
tests/test_player_experience_models.py::TestProgressModels::test_engagement_metrics_creation PASSED [ 38%]
tests/test_player_experience_models.py::TestProgressModels::test_milestone_creation PASSED [ 38%]
tests/test_player_experience_models.py::TestProgressModels::test_progress_summary_creation PASSED [ 38%]
tests/test_player_experience_models.py::TestSerialization::test_character_serialization PASSED [ 38%]
tests/test_player_experience_models.py::TestSerialization::test_player_profile_serialization PASSED [ 38%]
tests/test_player_experience_models.py::TestValidation::test_validate_model_failure PASSED [ 39%]
tests/test_player_experience_models.py::TestValidation::test_validate_model_success PASSED [ 39%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceOrchestrationIntegration::test_component_initialization PASSED [ 39%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceOrchestrationIntegration::test_component_configuration_access PASSED [ 39%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceOrchestrationIntegration::test_component_start_success PASSED [ 39%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceOrchestrationIntegration::test_component_start_failure PASSED [ 40%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceOrchestrationIntegration::test_component_stop_success PASSED [ 40%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceOrchestrationIntegration::test_health_status_monitoring PASSED [ 40%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceOrchestrationIntegration::test_monitoring_metrics PASSED [ 40%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceOrchestrationIntegration::test_orchestrator_integration FAILED [ 40%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceOrchestrationIntegration::test_component_dependencies PASSED [ 41%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceOrchestrationIntegration::test_docker_compose_command_execution PASSED [ 41%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceOrchestrationIntegration::test_container_status_checking PASSED [ 41%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceDeploymentValidation::test_deployment_health_check PASSED [ 41%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceDeploymentValidation::test_deployment_health_check_failure PASSED [ 41%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceDeploymentValidation::test_configuration_validation PASSED [ 42%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceDeploymentValidation::test_dependency_health_checking PASSED [ 42%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceDeploymentValidation::test_dependency_health_checking_failure PASSED [ 42%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceEndToEndIntegration::test_full_orchestration_lifecycle PASSED [ 42%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceEndToEndIntegration::test_orchestrated_component_startup PASSED [ 42%]
tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceEndToEndIntegration::test_configuration_integration PASSED [ 43%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_create_player_success PASSED [ 43%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_create_player_validation_error PASSED [ 43%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_create_player_username_exists PASSED [ 43%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_get_player_success FAILED [ 43%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_get_player_not_found FAILED [ 44%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_get_player_unauthorized PASSED [ 44%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_get_player_access_denied FAILED [ 44%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_update_player_success FAILED [ 44%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_update_player_validation_error FAILED [ 44%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_update_player_username_conflict FAILED [ 45%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_delete_player_success FAILED [ 45%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_delete_player_not_found FAILED [ 45%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_export_player_data_success FAILED [ 45%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_update_therapeutic_preferences_success FAILED [ 45%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_update_privacy_settings_success FAILED [ 46%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_privacy_settings_validation_error FAILED [ 46%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_therapeutic_preferences_validation_error FAILED [ 46%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_cross_player_access_denied FAILED [ 46%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_invalid_token_authentication PASSED [ 46%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_missing_authorization_header PASSED [ 47%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_malformed_authorization_header PASSED [ 47%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_api_documentation_generation PASSED [ 47%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_cors_headers FAILED [ 47%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_security_headers FAILED [ 47%]
tests/test_player_management_api.py::TestPlayerManagementAPI::test_rate_limiting_headers FAILED [ 48%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_connect_failure PASSED [ 48%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_connect_success PASSED [ 48%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_context_manager PASSED [ 48%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_create_player_profile_constraints_already_exists PASSED [ 48%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_create_player_profile_constraints_failure PASSED [ 49%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_create_player_profile_constraints_success PASSED [ 49%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_create_player_profile_indexes_success PASSED [ 49%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_disconnect PASSED [ 49%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_get_player_schema_version_not_found PASSED [ 49%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_get_player_schema_version_success PASSED [ 50%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_is_connected_false_exception PASSED [ 50%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_is_connected_false_no_driver PASSED [ 50%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_is_connected_true PASSED [ 50%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_schema_manager_initialization PASSED [ 50%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_setup_player_profile_schema_constraint_failure PASSED [ 50%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_setup_player_profile_schema_success PASSED [ 51%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_validate_player_profile_schema_missing_constraints PASSED [ 51%]
tests/test_player_profile_database.py::TestPlayerProfileSchemaManager::test_validate_player_profile_schema_success PASSED [ 51%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_connect_success PASSED [ 51%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_context_manager PASSED [ 51%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_create_player_profile_already_exists PASSED [ 52%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_create_player_profile_failure PASSED [ 52%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_create_player_profile_success PASSED [ 52%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_delete_player_profile_not_found PASSED [ 52%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_delete_player_profile_success PASSED [ 52%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_email_exists_false PASSED [ 53%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_email_exists_true PASSED [ 53%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_get_player_profile_not_found PASSED [ 53%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_get_player_profile_success PASSED [ 53%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_list_active_players PASSED [ 53%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_repository_initialization PASSED [ 54%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_serialize_privacy_settings PASSED [ 54%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_serialize_progress_summary PASSED [ 54%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_serialize_therapeutic_preferences PASSED [ 54%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_update_player_profile_not_found PASSED [ 54%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_update_player_profile_success PASSED [ 55%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_username_exists_false PASSED [ 55%]
tests/test_player_profile_database.py::TestPlayerProfileRepository::test_username_exists_true PASSED [ 55%]
tests/test_player_profile_database.py::TestPlayerProfileValidation::test_player_profile_character_limit PASSED [ 55%]
tests/test_player_profile_database.py::TestPlayerProfileValidation::test_player_profile_character_management PASSED [ 55%]
tests/test_player_profile_database.py::TestPlayerProfileValidation::test_player_profile_validation_empty_id PASSED [ 56%]
tests/test_player_profile_database.py::TestPlayerProfileValidation::test_player_profile_validation_invalid_email PASSED [ 56%]
tests/test_player_profile_database.py::TestPlayerProfileValidation::test_player_profile_validation_short_username PASSED [ 56%]
tests/test_player_profile_database.py::TestPlayerProfileValidation::test_privacy_settings_validation PASSED [ 56%]
tests/test_player_profile_database.py::TestPlayerProfileValidation::test_therapeutic_preferences_validation PASSED [ 56%]
tests/test_player_profile_database.py::TestPlayerProfileValidation::test_valid_player_profile_creation PASSED [ 57%]
tests/test_player_profile_database.py::TestUtilityFunctions::test_create_player_profile_repository PASSED [ 57%]
tests/test_player_profile_database.py::TestUtilityFunctions::test_setup_player_profile_schema_failure PASSED [ 57%]
tests/test_player_profile_database.py::TestUtilityFunctions::test_setup_player_profile_schema_success PASSED [ 57%]
tests/test_player_profile_database_param.py::test_schema_manager_setup_parametrized[mock] SKIPPED [ 57%]
tests/test_player_profile_database_param.py::test_schema_manager_setup_parametrized[container] SKIPPED [ 58%]
tests/test_player_profile_database_param.py::test_repository_crud_parametrized[mock] SKIPPED [ 58%]
tests/test_player_profile_database_param.py::test_repository_crud_parametrized[container] SKIPPED [ 58%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_create_player_profile_duplicate_email PASSED [ 58%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_create_player_profile_duplicate_username PASSED [ 58%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_create_player_profile_invalid_email PASSED [ 59%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_create_player_profile_invalid_privacy_settings PASSED [ 59%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_create_player_profile_invalid_username PASSED [ 59%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_create_player_profile_manager_utility PASSED [ 59%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_create_player_profile_success PASSED [ 59%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_delete_player_profile_not_found PASSED [ 60%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_delete_player_profile_success PASSED [ 60%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_delete_player_profile_unauthorized PASSED [ 60%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_export_player_data_success PASSED [ 60%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_export_player_data_unauthorized PASSED [ 60%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_get_access_log_success PASSED [ 61%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_get_access_log_unauthorized PASSED [ 61%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_get_player_by_email PASSED [ 61%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_get_player_by_username PASSED [ 61%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_get_player_profile_data_access_restricted PASSED [ 61%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_get_player_profile_not_found PASSED [ 62%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_get_player_profile_privacy_filtering PASSED [ 62%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_get_player_profile_success PASSED [ 62%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_repository_error_handling PASSED [ 62%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_update_player_profile_not_found PASSED [ 62%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_update_player_profile_restricted_fields PASSED [ 63%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_update_player_profile_success PASSED [ 63%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_update_player_profile_unauthorized PASSED [ 63%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_update_privacy_settings PASSED [ 63%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_update_privacy_settings_invalid PASSED [ 63%]
tests/test_player_profile_manager.py::TestPlayerProfileManager::test_update_therapeutic_preferences PASSED [ 64%]
tests/test_player_profile_manager.py::TestPlayerProfileManagerIntegration::test_full_profile_lifecycle PASSED [ 64%]
tests/test_player_profile_manager.py::TestPlayerProfileManagerIntegration::test_privacy_controls_enforcement PASSED [ 64%]
tests/test_privacy_api.py::TestPrivacyCompliance::test_consent_management_workflow PASSED [ 64%]
tests/test_privacy_api.py::TestPrivacyCompliance::test_data_anonymization_workflow PASSED [ 64%]
tests/test_privacy_api.py::TestPrivacyCompliance::test_data_deletion_workflow PASSED [ 65%]
tests/test_privacy_api.py::TestPrivacyCompliance::test_data_export_workflow PASSED [ 65%]
tests/test_privacy_api.py::TestPrivacyCompliance::test_data_processing_records_management PASSED [ 65%]
tests/test_privacy_api.py::TestPrivacyCompliance::test_data_retention_compliance_monitoring PASSED [ 65%]
tests/test_privacy_api.py::TestPrivacyCompliance::test_gdpr_rights_implementation PASSED [ 65%]
tests/test_privacy_api.py::TestPrivacyCompliance::test_privacy_by_design_principles PASSED [ 66%]
tests/test_privacy_api.py::TestPrivacyCompliance::test_privacy_settings_management PASSED [ 66%]
tests/test_privacy_api.py::TestPrivacyCompliance::test_therapeutic_data_protection_integration PASSED [ 66%]
tests/test_privacy_service.py::TestEncryptionService::test_decrypt_with_missing_key PASSED [ 66%]
tests/test_privacy_service.py::TestEncryptionService::test_encrypt_bytes_data PASSED [ 66%]
tests/test_privacy_service.py::TestEncryptionService::test_encrypt_decrypt_data PASSED [ 67%]
tests/test_privacy_service.py::TestEncryptionService::test_generate_data_key PASSED [ 67%]
tests/test_privacy_service.py::TestEncryptionService::test_key_rotation PASSED [ 67%]
tests/test_privacy_service.py::TestEncryptionService::test_key_rotation_nonexistent_key PASSED [ 67%]
tests/test_privacy_service.py::TestAnonymizationService::test_anonymize_therapeutic_content PASSED [ 67%]
tests/test_privacy_service.py::TestAnonymizationService::test_anonymize_user_id PASSED [ 68%]
tests/test_privacy_service.py::TestAnonymizationService::test_k_anonymize_dataset PASSED [ 68%]
tests/test_privacy_service.py::TestAnonymizationService::test_k_anonymize_empty_dataset PASSED [ 68%]
tests/test_privacy_service.py::TestAnonymizationService::test_pseudonymize_user_id PASSED [ 68%]
tests/test_privacy_service.py::TestDataPrivacyService::test_anonymize_user_data PASSED [ 68%]
tests/test_privacy_service.py::TestDataPrivacyService::test_check_data_retention_compliance PASSED [ 69%]
tests/test_privacy_service.py::TestDataPrivacyService::test_check_data_retention_compliance_no_issues PASSED [ 69%]
tests/test_privacy_service.py::TestDataPrivacyService::test_decrypt_nonexistent_content PASSED [ 69%]
tests/test_privacy_service.py::TestDataPrivacyService::test_decrypt_therapeutic_content PASSED [ 69%]
tests/test_privacy_service.py::TestDataPrivacyService::test_delete_user_data PASSED [ 69%]
tests/test_privacy_service.py::TestDataPrivacyService::test_encrypt_therapeutic_content PASSED [ 70%]
tests/test_privacy_service.py::TestDataPrivacyService::test_export_user_data PASSED [ 70%]
tests/test_privacy_service.py::TestDataPrivacyService::test_export_user_data_csv_format PASSED [ 70%]
tests/test_privacy_service.py::TestDataPrivacyService::test_record_consent PASSED [ 70%]
tests/test_privacy_service.py::TestDataPrivacyService::test_record_data_processing PASSED [ 70%]
tests/test_privacy_service.py::TestDataPrivacyService::test_update_privacy_settings PASSED [ 71%]
tests/test_privacy_service.py::TestDataPrivacyService::test_withdraw_consent PASSED [ 71%]
tests/test_privacy_service.py::TestDataPrivacyService::test_withdraw_nonexistent_consent PASSED [ 71%]
tests/test_privacy_service.py::TestPrivacyServiceIntegration::test_automated_decision_making_transparency PASSED [ 71%]
tests/test_privacy_service.py::TestPrivacyServiceIntegration::test_complete_gdpr_workflow PASSED [ 71%]
tests/test_privacy_service.py::TestPrivacyServiceIntegration::test_cross_border_data_transfer_compliance PASSED [ 72%]
tests/test_privacy_service.py::TestPrivacyServiceIntegration::test_privacy_by_design_principles PASSED [ 72%]
tests/test_process_utils.py::test_run_success_echo PASSED                [ 72%]
tests/test_process_utils.py::test_run_timeout PASSED                     [ 72%]
tests/test_process_utils.py::test_run_nonzero_no_check PASSED            [ 72%]
tests/test_process_utils.py::test_run_nonzero_with_check PASSED          [ 73%]
tests/test_process_utils.py::test_no_shell_injection PASSED              [ 73%]
tests/test_progress_tracking_service.py::TestProgressTrackingService::test_comprehensive_milestone_detection PASSED [ 73%]
tests/test_progress_tracking_service.py::TestProgressTrackingService::test_compute_progress_summary PASSED [ 73%]
tests/test_progress_tracking_service.py::TestProgressTrackingService::test_detect_and_update_milestones PASSED [ 73%]
tests/test_progress_tracking_service.py::TestProgressTrackingService::test_dropout_risk_calculation PASSED [ 74%]
tests/test_progress_tracking_service.py::TestProgressTrackingService::test_enhanced_progress_insights_generation PASSED [ 74%]
tests/test_progress_tracking_service.py::TestProgressTrackingService::test_enhanced_progress_summary_with_therapeutic_integration PASSED [ 74%]
tests/test_progress_tracking_service.py::TestProgressTrackingService::test_generate_progress_insights PASSED [ 74%]
tests/test_progress_tracking_service.py::TestProgressTrackingService::test_get_visualization_data PASSED [ 74%]
tests/test_progress_tracking_service.py::TestProgressTrackingService::test_milestone_celebration PASSED [ 75%]
tests/test_progress_tracking_service.py::TestProgressTrackingService::test_streak_calculation_accuracy PASSED [ 75%]
tests/test_progress_tracking_service.py::TestProgressTrackingService::test_therapeutic_effectiveness_report PASSED [ 75%]
tests/test_progress_tracking_service.py::TestProgressTrackingService::test_therapeutic_value_assessment PASSED [ 75%]
tests/test_progress_tracking_service.py::TestProgressTrackingService::test_visualization_data_accuracy PASSED [ 75%]
tests/test_redis_integration.py::test_redis_container_basic SKIPPED      [ 76%]
tests/test_redis_integration.py::test_redis_container_expiry SKIPPED     [ 76%]
tests/test_scale_manager_extraction.py::test_scale_manager_evaluate_choice_impact_smoke PASSED [ 76%]
tests/test_scale_manager_extraction.py::test_scale_manager_creates_event_when_magnitude_threshold FAILED [ 76%]
tests/test_session_integration_manager_simple.py::TestSessionIntegrationManagerCore::test_context_switching_logic PASSED [ 76%]
tests/test_session_integration_manager_simple.py::TestSessionIntegrationManagerCore::test_error_handling PASSED [ 77%]
tests/test_session_integration_manager_simple.py::TestSessionIntegrationManagerCore::test_progress_marker_addition PASSED [ 77%]
tests/test_session_integration_manager_simple.py::TestSessionIntegrationManagerCore::test_session_continuity_data PASSED [ 77%]
tests/test_session_integration_manager_simple.py::TestSessionIntegrationManagerCore::test_session_creation_data_structure PASSED [ 77%]
tests/test_session_integration_manager_simple.py::TestSessionIntegrationManagerCore::test_session_interaction_updates PASSED [ 77%]
tests/test_session_integration_manager_simple.py::TestSessionIntegrationManagerCore::test_session_state_preservation PASSED [ 78%]
tests/test_session_integration_manager_simple.py::TestSessionIntegrationManagerCore::test_therapeutic_settings_update PASSED [ 78%]
tests/test_session_management.py::TestSessionRepository::test_create_session PASSED [ 78%]
tests/test_session_management.py::TestSessionRepository::test_deserialize_session_context PASSED [ 78%]
tests/test_session_management.py::TestSessionRepository::test_end_session PASSED [ 78%]
tests/test_session_management.py::TestSessionRepository::test_get_session_from_cache PASSED [ 79%]
tests/test_session_management.py::TestSessionRepository::test_pause_session PASSED [ 79%]
tests/test_session_management.py::TestSessionRepository::test_serialize_session_context PASSED [ 79%]
tests/test_session_management.py::TestSessionIntegrationManager::test_add_progress_marker PASSED [ 79%]
tests/test_session_management.py::TestSessionIntegrationManager::test_create_session PASSED [ 79%]
tests/test_session_management.py::TestSessionIntegrationManager::test_end_session PASSED [ 80%]
tests/test_session_management.py::TestSessionIntegrationManager::test_get_session_continuity_data PASSED [ 80%]
tests/test_session_management.py::TestSessionIntegrationManager::test_pause_session PASSED [ 80%]
tests/test_session_management.py::TestSessionIntegrationManager::test_resume_session PASSED [ 80%]
tests/test_session_management.py::TestSessionIntegrationManager::test_switch_character_world_context_existing_session PASSED [ 80%]
tests/test_session_management.py::TestSessionIntegrationManager::test_switch_character_world_context_new_session PASSED [ 81%]
tests/test_session_management.py::TestSessionIntegrationManager::test_update_session_interaction PASSED [ 81%]
tests/test_session_management.py::TestSessionIntegrationManager::test_update_therapeutic_settings PASSED [ 81%]
tests/test_session_management.py::TestSessionLifecycleIntegration::test_complete_session_lifecycle PASSED [ 81%]
tests/test_session_narrative_integration.py::TestSessionNarrativeIntegration::test_context_switching_with_narrative_continuity PASSED [ 81%]
tests/test_session_narrative_integration.py::TestSessionNarrativeIntegration::test_session_continuity_data_includes_narrative_state PASSED [ 82%]
tests/test_session_narrative_integration.py::TestSessionNarrativeIntegration::test_session_creation_with_narrative_initialization PASSED [ 82%]
tests/test_session_narrative_integration.py::TestSessionNarrativeIntegration::test_session_ending_with_narrative_finalization PASSED [ 82%]
tests/test_session_narrative_integration.py::TestSessionNarrativeIntegration::test_session_pause_and_resume_with_state_preservation PASSED [ 82%]
tests/test_session_narrative_integration.py::TestSessionNarrativeIntegration::test_therapeutic_settings_update_with_narrative_engine PASSED [ 82%]
tests/test_session_repository_redis_integration.py::test_session_repository_redis_cache_roundtrip SKIPPED [ 83%]
tests/test_therapeutic_effectiveness_integration.py::test_placeholder_integration_runs PASSED [ 83%]
tests/test_therapeutic_profile_integration.py::TestTherapeuticProfileIntegrationService::test_adapt_content_for_anxious_character PASSED [ 83%]
tests/test_therapeutic_profile_integration.py::TestTherapeuticProfileIntegrationService::test_adapt_content_for_high_intensity_character PASSED [ 83%]
tests/test_therapeutic_profile_integration.py::TestTherapeuticProfileIntegrationService::test_adapt_therapeutic_content PASSED [ 83%]
tests/test_therapeutic_profile_integration.py::TestTherapeuticProfileIntegrationService::test_calculate_readiness_adjustment PASSED [ 84%]
tests/test_therapeutic_profile_integration.py::TestTherapeuticProfileIntegrationService::test_create_personalization_context PASSED [ 84%]
tests/test_therapeutic_profile_integration.py::TestTherapeuticProfileIntegrationService::test_create_therapeutic_profile_from_character PASSED [ 84%]
tests/test_therapeutic_profile_integration.py::TestTherapeuticProfileIntegrationService::test_extract_therapeutic_insights PASSED [ 84%]
tests/test_therapeutic_profile_integration.py::TestTherapeuticProfileIntegrationService::test_generate_personalization_recommendations PASSED [ 84%]
tests/test_therapeutic_profile_integration.py::TestTherapeuticProfileIntegrationService::test_generate_therapeutic_goals PASSED [ 85%]
tests/test_therapeutic_profile_integration.py::TestTherapeuticProfileIntegrationService::test_get_character_adaptations PASSED [ 85%]
tests/test_therapeutic_profile_integration.py::TestTherapeuticProfileIntegrationService::test_get_character_recommendations PASSED [ 85%]
tests/test_therapeutic_profile_integration.py::TestTherapeuticProfileIntegrationService::test_recommend_intensity_adjustments PASSED [ 85%]
tests/test_therapeutic_profile_integration.py::TestTherapeuticProfileIntegrationService::test_recommend_therapeutic_approaches PASSED [ 85%]
tests/test_therapeutic_profile_integration.py::TestTherapeuticProfileIntegrationService::test_update_adaptation_effectiveness PASSED [ 86%]
tests/test_therapeutic_settings.py::TestTherapeuticBoundary::test_boundary_auto_id_generation PASSED [ 86%]
tests/test_therapeutic_settings.py::TestTherapeuticBoundary::test_boundary_creation PASSED [ 86%]
tests/test_therapeutic_settings.py::TestTherapeuticBoundary::test_boundary_invalid_severity PASSED [ 86%]
tests/test_therapeutic_settings.py::TestEnhancedTherapeuticSettings::test_add_boundary PASSED [ 86%]
tests/test_therapeutic_settings.py::TestEnhancedTherapeuticSettings::test_add_preferred_approach PASSED [ 87%]
tests/test_therapeutic_settings.py::TestEnhancedTherapeuticSettings::test_create_new_version PASSED [ 87%]
tests/test_therapeutic_settings.py::TestEnhancedTherapeuticSettings::test_get_active_boundaries PASSED [ 87%]
tests/test_therapeutic_settings.py::TestEnhancedTherapeuticSettings::test_get_all_approaches PASSED [ 87%]
tests/test_therapeutic_settings.py::TestEnhancedTherapeuticSettings::test_remove_boundary PASSED [ 87%]
tests/test_therapeutic_settings.py::TestEnhancedTherapeuticSettings::test_remove_preferred_approach PASSED [ 88%]
tests/test_therapeutic_settings.py::TestEnhancedTherapeuticSettings::test_settings_auto_id_generation PASSED [ 88%]
tests/test_therapeutic_settings.py::TestEnhancedTherapeuticSettings::test_settings_creation PASSED [ 88%]
tests/test_therapeutic_settings.py::TestEnhancedTherapeuticSettings::test_settings_validation PASSED [ 88%]
tests/test_therapeutic_settings.py::TestEnhancedTherapeuticSettings::test_update_intensity PASSED [ 88%]
tests/test_therapeutic_settings.py::TestTherapeuticPreferencesValidator::test_contradictory_preferences PASSED [ 89%]
tests/test_therapeutic_settings.py::TestTherapeuticPreferencesValidator::test_intensity_approach_mismatch PASSED [ 89%]
tests/test_therapeutic_settings.py::TestTherapeuticPreferencesValidator::test_non_resolvable_conflict PASSED [ 89%]
tests/test_therapeutic_settings.py::TestTherapeuticPreferencesValidator::test_resolve_conflict PASSED [ 89%]
tests/test_therapeutic_settings.py::TestTherapeuticPreferencesValidator::test_unsafe_combinations PASSED [ 89%]
tests/test_therapeutic_settings.py::TestTherapeuticPreferencesValidator::test_valid_settings PASSED [ 90%]
tests/test_therapeutic_settings.py::TestSettingsMigrationManager::test_migrate_float_intensity_conversion PASSED [ 90%]
tests/test_therapeutic_settings.py::TestSettingsMigrationManager::test_migrate_invalid_approaches_filtering PASSED [ 90%]
tests/test_therapeutic_settings.py::TestSettingsMigrationManager::test_migrate_to_v1_from_basic_settings PASSED [ 90%]
tests/test_therapeutic_settings.py::TestSettingsMigrationManager::test_migrate_unsupported_version PASSED [ 90%]
tests/test_wave3_facades.py::test_facades_importable PASSED              [ 91%]
tests/test_wave3_facades.py::test_arc_facades_importable PASSED          [ 91%]
tests/test_websocket_chat_backend.py::test_ws_rejects_without_token PASSED [ 91%]
tests/test_websocket_chat_backend.py::test_ws_connects_with_token_and_welcome PASSED [ 91%]
tests/test_websocket_chat_backend.py::test_user_message_roundtrip PASSED [ 91%]
tests/test_websocket_chat_backend.py::test_feedback_processing_ack PASSED [ 92%]
tests/test_websocket_chat_backend_task8_2.py::test_user_message_includes_recommendations_and_no_crisis_by_default PASSED [ 92%]
tests/test_websocket_chat_backend_task8_2.py::test_crisis_detection_includes_resources PASSED [ 92%]
tests/test_websocket_chat_backend_task8_2.py::test_feedback_triggers_recommendations PASSED [ 92%]
tests/test_websocket_chat_interactive.py::test_interactive_buttons_suggested_on_anxiety PASSED [ 92%]
tests/test_websocket_chat_interactive.py::test_guided_exercise_flow_records_progress PASSED [ 93%]
tests/test_websocket_chat_typing_and_metrics.py::test_typing_events_emitted_when_opt_in PASSED [ 93%]
tests/test_websocket_chat_typing_and_metrics.py::test_metrics_incremented PASSED [ 93%]
tests/test_world_management_api.py::test_worlds_root_requires_auth PASSED [ 93%]
tests/test_world_management_api.py::test_get_world_requires_auth PASSED  [ 93%]
tests/test_world_management_api.py::test_check_compatibility_requires_auth PASSED [ 94%]
tests/test_world_management_api.py::test_customize_requires_auth PASSED  [ 94%]
tests/test_world_management_api.py::test_list_worlds_happy_path FAILED   [ 94%]
tests/test_world_management_api.py::test_get_world_details_happy_path FAILED [ 94%]
tests/test_world_management_api.py::test_compatibility_happy_path FAILED [ 94%]
tests/test_world_management_api.py::test_customize_world_happy_path FAILED [ 95%]
tests/test_world_management_api.py::test_get_world_not_found FAILED      [ 95%]
tests/test_world_management_api.py::test_customize_world_not_found FAILED [ 95%]
tests/test_world_management_api.py::test_customize_world_invalid_params FAILED [ 95%]
tests/test_world_management_api.py::test_list_worlds_pagination FAILED   [ 95%]
tests/test_world_management_module.py::TestWorldManagementModule::test_advanced_compatibility_checking_with_character_object PASSED [ 96%]
tests/test_world_management_module.py::TestWorldManagementModule::test_assess_world_suitability_for_character PASSED [ 96%]
tests/test_world_management_module.py::TestWorldManagementModule::test_assess_world_suitability_nonexistent_world PASSED [ 96%]
tests/test_world_management_module.py::TestWorldManagementModule::test_basic_compatibility_score_calculation PASSED [ 96%]
tests/test_world_management_module.py::TestWorldManagementModule::test_check_world_compatibility_existing_world PASSED [ 96%]
tests/test_world_management_module.py::TestWorldManagementModule::test_check_world_compatibility_nonexistent_world PASSED [ 97%]
tests/test_world_management_module.py::TestWorldManagementModule::test_compatibility_factors_calculation PASSED [ 97%]
tests/test_world_management_module.py::TestWorldManagementModule::test_customize_world_parameters_invalid_parameters PASSED [ 97%]
tests/test_world_management_module.py::TestWorldManagementModule::test_customize_world_parameters_invalid_world PASSED [ 97%]
tests/test_world_management_module.py::TestWorldManagementModule::test_customize_world_parameters_valid PASSED [ 97%]
tests/test_world_management_module.py::TestWorldManagementModule::test_get_available_worlds_with_character PASSED [ 98%]
tests/test_world_management_module.py::TestWorldManagementModule::test_get_available_worlds_without_character PASSED [ 98%]
tests/test_world_management_module.py::TestWorldManagementModule::test_get_world_details_existing_world PASSED [ 98%]
tests/test_world_management_module.py::TestWorldManagementModule::test_get_world_details_nonexistent_world PASSED [ 98%]
tests/test_world_management_module.py::TestWorldManagementModule::test_get_world_recommendations PASSED [ 98%]
tests/test_world_management_module.py::TestWorldManagementModule::test_initialization PASSED [ 99%]
tests/test_world_management_module.py::TestWorldManagementModule::test_initialize_character_in_world_basic PASSED [ 99%]
tests/test_world_management_module.py::TestWorldManagementModule::test_initialize_character_in_world_nonexistent_world PASSED [ 99%]
tests/test_world_management_module.py::TestWorldManagementModule::test_initialize_character_in_world_with_parameters PASSED [ 99%]
tests/test_world_management_module.py::TestWorldManagementModule::test_initialize_character_with_external_components PASSED [ 99%]
tests/test_world_management_module.py::TestWorldManagementModule::test_world_parameters_validation PASSED [100%]

=================================== FAILURES ===================================
___________________________ test_authentication_flow ___________________________

client = <starlette.testclient.TestClient object at 0x7ff157ff08d0>

    def test_authentication_flow(client):
        """Test the authentication endpoints."""
        # Test login endpoint (should fail with invalid credentials)
        response = client.post("/api/v1/auth/login", json={
            "username": "testuser",
            "password": "testpass"
        })
>       assert response.status_code == 401
E       assert 500 == 401
E        +  where 500 = <Response [500 Internal Server Error]>.status_code

tests/test_api_integration.py:58: AssertionError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: POST /api/v1/auth/login
INFO     src.player_experience.api.middleware::0 Request completed: 500
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request ae1b996d-5b7d-4bfb-adf4-9325e87a09b2 completed in 0.003s
__________________________ test_auth_router_included ___________________________

client = <starlette.testclient.TestClient object at 0x7ff156a12b90>

    def test_auth_router_included(client):
        """Test that authentication router is included."""
        # Test a public auth endpoint
        response = client.post("/api/v1/auth/login", json={
            "username": "test",
            "password": "test"
        })
        # Should return 401 for invalid credentials, not 404
>       assert response.status_code == 401
E       assert 422 == 401
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code

tests/test_api_structure.py:100: AssertionError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: POST /api/v1/auth/login
INFO     src.player_experience.api.middleware::0 Request completed: 422
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request f7b714e3-a329-40e2-b78a-e8ebd2c60c6a completed in 0.002s
___________ TestEndToEndUserWorkflows.test_complete_new_user_journey ___________

self = <tests.test_end_to_end_workflows.TestEndToEndUserWorkflows object at 0x7ff15cbd7990>
client = <starlette.testclient.TestClient object at 0x7ff156d45d90>

    def test_complete_new_user_journey(self, client):
        """Test complete journey for a new user from registration to therapeutic interaction."""
        player_id = "new-user-123"
        token = create_auth_token(player_id, "newuser", "newuser@example.com")
        headers = {"Authorization": f"Bearer {token}"}
    
        # Step 1: Create player profile
        profile_data = {
            "username": "newuser",
            "email": "newuser@example.com",
            "therapeutic_preferences": {
                "intensity_level": "medium",
                "preferred_approaches": ["cbt", "mindfulness"],
                "trigger_warnings": ["violence"],
                "comfort_topics": ["relationships"],
                "avoid_topics": ["trauma"]
            },
            "privacy_settings": {
                "data_sharing_consent": True,
                "research_participation": False,
                "contact_preferences": ["email"]
            }
        }
    
        response = client.post("/api/v1/players/", json=profile_data, headers=headers)
>       assert response.status_code == 201
E       assert 422 == 201
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code

tests/test_end_to_end_workflows.py:113: AssertionError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: POST /api/v1/players/
INFO     src.player_experience.api.middleware::0 Request completed: 422
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request e8e439d6-3be1-4228-9b89-c30766bb3b3d completed in 0.004s
___________ TestEndToEndUserWorkflows.test_multi_character_workflow ____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 251, in test_multi_character_workflow
    |     response = client.post("/api/v1/characters/", json=char_data, headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 251, in test_multi_character_workflow
    response = client.post("/api/v1/characters/", json=char_data, headers=headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_end_to_end_workflows.TestEndToEndUserWorkflows object at 0x7ff15cc44650>
client = <starlette.testclient.TestClient object at 0x7ff157fad710>

    def test_multi_character_workflow(self, client):
        """Test workflow with multiple characters and world switching."""
        player_id = "multi-char-user"
        token = create_auth_token(player_id)
        headers = {"Authorization": f"Bearer {token}"}
    
        # Create player profile
        profile_data = {
            "username": "multiuser",
            "email": "multi@example.com",
            "therapeutic_preferences": {
                "intensity_level": "medium",
                "preferred_approaches": ["cbt", "narrative_therapy"],
                "trigger_warnings": [],
                "comfort_topics": ["personal_growth"],
                "avoid_topics": []
            }
        }
        client.post("/api/v1/players/", json=profile_data, headers=headers)
    
        # Create multiple characters
        characters = []
        for i, name in enumerate(["Character1", "Character2", "Character3"]):
            char_data = create_test_character_data(name)
            # Vary therapeutic approaches
            char_data["therapeutic_profile"]["therapeutic_approaches"] = [
                ["cbt"], ["narrative_therapy"], ["mindfulness"]
            ][i]
    
>           response = client.post("/api/v1/characters/", json=char_data, headers=headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_end_to_end_workflows.py:251: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.11/site-packages/httpx/_client.py:1157: in post
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='multi-char-user', username='testuser', email='test@example.com', exp=datetime.datetime(2025, 8, 17, 19, 25, 46, tzinfo=datetime.timezone.utc))
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: POST /api/v1/players/
INFO     src.player_experience.api.middleware::0 Request completed: 422
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request 482b9dab-2ea9-4fc9-815d-594b3c7877b6 completed in 0.002s
INFO     src.player_experience.api.middleware::0 Request started: POST /api/v1/characters/
___ TestEndToEndUserWorkflows.test_therapeutic_settings_adaptation_workflow ____
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 346, in test_therapeutic_settings_adaptation_workflow
    |     response = client.post("/api/v1/characters/", json=char_data, headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 346, in test_therapeutic_settings_adaptation_workflow
    response = client.post("/api/v1/characters/", json=char_data, headers=headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_end_to_end_workflows.TestEndToEndUserWorkflows object at 0x7ff15cc468d0>
client = <starlette.testclient.TestClient object at 0x7ff156b54a10>

    def test_therapeutic_settings_adaptation_workflow(self, client):
        """Test workflow where therapeutic settings are adapted based on user feedback."""
        player_id = "adaptive-user"
        token = create_auth_token(player_id)
        headers = {"Authorization": f"Bearer {token}"}
    
        # Create player and character
        profile_data = {
            "username": "adaptiveuser",
            "email": "adaptive@example.com",
            "therapeutic_preferences": {
                "intensity_level": "low",  # Start with low intensity
                "preferred_approaches": ["mindfulness"],
                "trigger_warnings": ["anxiety"],
                "comfort_topics": ["relaxation"],
                "avoid_topics": ["stress"]
            }
        }
        client.post("/api/v1/players/", json=profile_data, headers=headers)
    
        char_data = create_test_character_data("Adaptive Character")
        char_data["therapeutic_profile"]["preferred_intensity"] = "low"
>       response = client.post("/api/v1/characters/", json=char_data, headers=headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_end_to_end_workflows.py:346: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.11/site-packages/httpx/_client.py:1157: in post
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='adaptive-user', username='testuser', email='test@example.com', exp=datetime.datetime(2025, 8, 17, 19, 25, 46, tzinfo=datetime.timezone.utc))
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: POST /api/v1/players/
INFO     src.player_experience.api.middleware::0 Request completed: 422
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request a39daca1-ad47-459d-a57f-d8237fb945cc completed in 0.002s
INFO     src.player_experience.api.middleware::0 Request started: POST /api/v1/characters/
___________ TestConcurrentUserScenarios.test_concurrent_api_requests ___________

self = <tests.test_end_to_end_workflows.TestConcurrentUserScenarios object at 0x7ff15cc471d0>
client = <starlette.testclient.TestClient object at 0x7ff156d72310>

    def test_concurrent_api_requests(self, client):
        """Test concurrent API requests performance."""
        num_requests = 20
        request_results = []
    
        def make_api_request(request_id: int):
            """Make a concurrent API request."""
            try:
                player_id = f"api-user-{request_id}"
                token = create_auth_token(player_id)
                headers = {"Authorization": f"Bearer {token}"}
    
                start_time = time.time()
    
                # Test different endpoints
                endpoints = [
                    ("/api/v1/worlds/", "GET"),
                    ("/health", "GET"),
                    ("/", "GET")
                ]
    
                endpoint, method = endpoints[request_id % len(endpoints)]
    
                if method == "GET":
                    response = client.get(endpoint, headers=headers if endpoint.startswith("/api/") else None)
    
                request_time = time.time() - start_time
    
                return {
                    "request_id": request_id,
                    "endpoint": endpoint,
                    "success": response.status_code < 400,
                    "status_code": response.status_code,
                    "request_time": request_time
                }
    
            except Exception as e:
                return {
                    "request_id": request_id,
                    "success": False,
                    "error": str(e),
                    "request_time": None
                }
    
        # Execute concurrent requests
        with ThreadPoolExecutor(max_workers=num_requests) as executor:
            futures = [executor.submit(make_api_request, i) for i in range(num_requests)]
    
            for future in as_completed(futures):
                result = future.result()
                request_results.append(result)
    
        # Analyze results
        successful_requests = [r for r in request_results if r["success"]]
        failed_requests = [r for r in request_results if not r["success"]]
    
        # Performance assertions
>       assert len(successful_requests) >= num_requests * 0.95  # 95% success rate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AssertionError: assert 13 >= (20 * 0.95)
E        +  where 13 = len([{'endpoint': '/', 'request_id': 2, 'request_time': 0.01842498779296875, 'status_code': 200, ...}, {'endpoint': '/health', 'request_id': 1, 'request_time': 0.02682328224182129, 'status_code': 200, ...}, {'endpoint': '/health', 'request_id': 4, 'request_time': 0.05405449867248535, 'status_code': 200, ...}, {'endpoint': '/', 'request_id': 8, 'request_time': 0.03721332550048828, 'status_code': 200, ...}, {'endpoint': '/', 'request_id': 5, 'request_time': 0.04957222938537598, 'status_code': 200, ...}, {'endpoint': '/health', 'request_id': 7, 'request_time': 0.05639243125915527, 'status_code': 200, ...}, ...])

tests/test_end_to_end_workflows.py:573: AssertionError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: GET /
INFO     src.player_experience.api.middleware::0 Request completed: 200
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request 4158e474-5ec4-4e6e-9537-46b9d25d2ecb completed in 0.001s
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/worlds/
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/worlds/
INFO     src.player_experience.api.middleware::0 Request started: GET /health
INFO     src.player_experience.api.middleware::0 Request completed: 200
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request 62ea2564-cc64-4619-8cde-97099f8295b2 completed in 0.003s
INFO     src.player_experience.api.middleware::0 Request started: GET /
INFO     src.player_experience.api.middleware::0 Request completed: 200
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request 49c5a017-edb9-4a01-bf28-07261501ca5e completed in 0.002s
INFO     src.player_experience.api.middleware::0 Request started: GET /health
INFO     src.player_experience.api.middleware::0 Request completed: 200
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request 76b8d8d4-8ba7-4a1b-bde3-c2e79c4645e2 completed in 0.002s
INFO     src.player_experience.api.middleware::0 Request started: GET /
INFO     src.player_experience.api.middleware::0 Request completed: 200
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request 0788e5ca-41fc-48c5-bb51-14c53ef137d2 completed in 0.001s
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/worlds/
INFO     src.player_experience.api.middleware::0 Request started: GET /health
INFO     src.player_experience.api.middleware::0 Request completed: 200
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request 959f86f0-76af-4d24-a9da-1d669c9250a0 completed in 0.001s
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/worlds/
INFO     src.player_experience.api.middleware::0 Request started: GET /
INFO     src.player_experience.api.middleware::0 Request completed: 200
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request 37909a82-bbfc-480e-a2de-5768ff66baba completed in 0.003s
INFO     src.player_experience.api.middleware::0 Request started: GET /health
INFO     src.player_experience.api.middleware::0 Request completed: 200
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request 4c9898e2-1614-40cd-941b-15d61dec120b completed in 0.005s
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/worlds/
INFO     src.player_experience.api.middleware::0 Request started: GET /health
INFO     src.player_experience.api.middleware::0 Request completed: 200
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request 6c0873e8-da14-4bf1-b7cb-19f373bdc50a completed in 0.001s
INFO     src.player_experience.api.middleware::0 Request started: GET /
INFO     src.player_experience.api.middleware::0 Request completed: 200
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request 18efa87b-5b89-4e14-9bb4-a34d19d3111d completed in 0.001s
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/worlds/
INFO     src.player_experience.api.middleware::0 Request started: GET /health
INFO     src.player_experience.api.middleware::0 Request completed: 200
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request cdec5b8e-b0ab-45c6-a9d0-78a3ffc2a052 completed in 0.001s
INFO     src.player_experience.api.middleware::0 Request started: GET /
INFO     src.player_experience.api.middleware::0 Request completed: 200
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request 0ad8737a-6a7a-43d4-819f-12f41df059ef completed in 0.002s
INFO     src.player_experience.api.middleware::0 Request started: GET /health
INFO     src.player_experience.api.middleware::0 Request completed: 200
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request a01f405b-8e6a-4ad4-a893-8abaf89a57a5 completed in 0.001s
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/worlds/
____ TestConcurrentUserScenarios.test_session_state_consistency_under_load _____
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 607, in test_session_state_consistency_under_load
    |     response = client.post("/api/v1/characters/", json=char_data, headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 607, in test_session_state_consistency_under_load
    response = client.post("/api/v1/characters/", json=char_data, headers=headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_end_to_end_workflows.TestConcurrentUserScenarios object at 0x7ff15cc475d0>
client = <starlette.testclient.TestClient object at 0x7ff15c99bb50>

    def test_session_state_consistency_under_load(self, client):
        """Test that session state remains consistent under concurrent access."""
        player_id = "consistency-test-user"
        token = create_auth_token(player_id)
        headers = {"Authorization": f"Bearer {token}"}
    
        # Create player and character
        profile_data = {
            "username": "consistencyuser",
            "email": "consistency@example.com",
            "therapeutic_preferences": {
                "intensity_level": "medium",
                "preferred_approaches": ["cbt"],
                "trigger_warnings": [],
                "comfort_topics": ["personal_growth"],
                "avoid_topics": []
            }
        }
        client.post("/api/v1/players/", json=profile_data, headers=headers)
    
        char_data = create_test_character_data("Consistency Character")
>       response = client.post("/api/v1/characters/", json=char_data, headers=headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_end_to_end_workflows.py:607: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.11/site-packages/httpx/_client.py:1157: in post
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='consistency-test-user', username='testuser', email='test@example.com', exp=datetime.datetime(2025, 8, 17, 19, 25, 47, tzinfo=datetime.timezone.utc))
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: POST /api/v1/players/
INFO     src.player_experience.api.middleware::0 Request completed: 422
DEBUG    src.player_experience.monitoring.performance_monitor::0 Request b8d17932-30b3-469e-8858-d035177a9eb5 completed in 0.002s
INFO     src.player_experience.api.middleware::0 Request started: POST /api/v1/characters/
___________ TestErrorHandlingAndRecovery.test_invalid_data_handling ____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 739, in test_invalid_data_handling
    |     response = client.post("/api/v1/characters/", json=invalid_char_data, headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 739, in test_invalid_data_handling
    response = client.post("/api/v1/characters/", json=invalid_char_data, headers=headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_end_to_end_workflows.TestErrorHandlingAndRecovery object at 0x7ff15cc5c210>
client = <starlette.testclient.TestClient object at 0x7ff156ef3a10>

    def test_invalid_data_handling(self, client):
        """Test handling of invalid data in end-to-end workflows."""
        player_id = "invalid-data-user"
        token = create_auth_token(player_id)
        headers = {"Authorization": f"Bearer {token}"}
    
        # Test invalid character creation data
        invalid_char_data = {
            "name": "",  # Invalid: empty name
            "appearance": {"physical_description": ""},
            "background": {
                "name": "Different Name",  # Invalid: doesn't match character name
                "age": -5,  # Invalid: negative age
                "personality_traits": []
            },
            "therapeutic_profile": {
                "readiness_level": 2.0,  # Invalid: out of range
                "preferred_intensity": "invalid_intensity",
                "therapeutic_approaches": ["invalid_approach"]
            }
        }
    
>       response = client.post("/api/v1/characters/", json=invalid_char_data, headers=headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_end_to_end_workflows.py:739: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.11/site-packages/httpx/_client.py:1157: in post
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='invalid-data-user', username='testuser', email='test@example.com', exp=datetime.datetime(2025, 8, 17, 19, 25, 47, tzinfo=datetime.timezone.utc))
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: POST /api/v1/characters/
______ TestErrorHandlingAndRecovery.test_authentication_failure_recovery _______
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 763, in test_authentication_failure_recovery
    |     response = client.get("/api/v1/worlds/", headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 763, in test_authentication_failure_recovery
    response = client.get("/api/v1/worlds/", headers=headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_end_to_end_workflows.TestErrorHandlingAndRecovery object at 0x7ff15cc5ca10>
client = <starlette.testclient.TestClient object at 0x7ff156d0d150>

    def test_authentication_failure_recovery(self, client):
        """Test recovery from authentication failures."""
        # Test with expired token
        expired_payload = {
            "sub": "expired-user",
            "username": "expireduser",
            "email": "expired@example.com",
            "exp": datetime.utcnow() - timedelta(hours=1)  # Expired
        }
        expired_token = jwt.encode(expired_payload, SECRET_KEY, algorithm=ALGORITHM)
    
        # Should fail with expired token
        headers = {"Authorization": f"Bearer {expired_token}"}
        response = client.get("/api/v1/worlds/", headers=headers)
        assert response.status_code == 401
    
        # Should succeed with valid token
        valid_token = create_auth_token("valid-user")
        headers = {"Authorization": f"Bearer {valid_token}"}
>       response = client.get("/api/v1/worlds/", headers=headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_end_to_end_workflows.py:763: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='valid-user', username='testuser', email='test@example.com', exp=datetime.datetime(2025, 8, 17, 19, 25, 47, tzinfo=datetime.timezone.utc))
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/worlds/
__ TestPlayerExperienceComponentIntegration.test_component_start_integration ___

self = <tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration testMethod=test_component_start_integration>
mock_requests = <MagicMock name='get' id='140674520265168'>
mock_subprocess = <MagicMock name='run' id='140674520829840'>

    @patch('subprocess.run')
    @patch('requests.get')
    def test_component_start_integration(self, mock_requests, mock_subprocess):
        """Test that the component starts correctly through orchestration."""
        # Mock successful Docker Compose execution
        mock_subprocess.return_value = Mock(returncode=0, stdout="", stderr="")
    
        # Mock successful health check
        mock_health_response = Mock()
        mock_health_response.status_code = 200
        mock_health_response.json.return_value = {"status": "healthy"}
        mock_requests.return_value = mock_health_response
    
        # Test starting the component
        result = self.player_experience.start()
        self.assertTrue(result)
        self.assertEqual(self.player_experience.status, ComponentStatus.RUNNING)
    
        # Verify Docker Compose was called
>       mock_subprocess.assert_called()

tests/test_player_experience_component_integration.py:98: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <MagicMock name='run' id='140674520829840'>

    def assert_called(self):
        """assert that the mock was called at least once
        """
        if self.call_count == 0:
            msg = ("Expected '%s' to have been called." %
                   (self._mock_name or 'mock'))
>           raise AssertionError(msg)
E           AssertionError: Expected 'run' to have been called.

../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/mock.py:908: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  src.orchestration.orchestrator:orchestrator.py:188 No components imported from tta.dev; falling back to core components
WARNING  src.orchestration.orchestrator:orchestrator.py:188 No components imported from tta.prototype; falling back to core components
___ TestPlayerExperienceComponentIntegration.test_component_stop_integration ___

self = <tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration testMethod=test_component_stop_integration>
mock_requests = <MagicMock name='get' id='140674540169360'>
mock_subprocess = <MagicMock name='run' id='140674540175312'>

    @patch('subprocess.run')
    @patch('requests.get')
    def test_component_stop_integration(self, mock_requests, mock_subprocess):
        """Test that the component stops correctly through orchestration."""
        # First start the component (mocked)
        mock_subprocess.return_value = Mock(returncode=0, stdout="", stderr="")
        mock_health_response = Mock()
        mock_health_response.status_code = 200
        mock_requests.return_value = mock_health_response
    
        self.player_experience.start()
    
        # Mock stopping
        mock_requests.side_effect = [
            mock_health_response,  # Initial health check (running)
            Exception("Connection refused")  # After stop (not running)
        ]
    
        # Test stopping the component
        result = self.player_experience.stop()
>       self.assertTrue(result)
E       AssertionError: False is not true

tests/test_player_experience_component_integration.py:123: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  src.orchestration.orchestrator:orchestrator.py:188 No components imported from tta.dev; falling back to core components
WARNING  src.orchestration.orchestrator:orchestrator.py:188 No components imported from tta.prototype; falling back to core components
ERROR    src.components.player_experience_component:player_experience_component.py:170 Error stopping Player Experience services: Connection refused
ERROR    src.orchestration.component:component.py:157 Failed to stop component player_experience
___ TestPlayerExperienceComponentIntegration.test_error_handling_integration ___

self = <tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration testMethod=test_error_handling_integration>

    def test_error_handling_integration(self):
        """Test error handling in component integration."""
        # Test with invalid Docker Compose path
        invalid_component = PlayerExperienceComponent(self.config)
        invalid_component.player_experience_dir = Path("/nonexistent/path")
    
        # Starting should fail gracefully
        result = invalid_component.start()
        self.assertFalse(result)
>       self.assertEqual(invalid_component.status, ComponentStatus.STOPPED)
E       AssertionError: <ComponentStatus.ERROR: 'error'> != <ComponentStatus.STOPPED: 'stopped'>

tests/test_player_experience_component_integration.py:256: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  src.orchestration.orchestrator:orchestrator.py:188 No components imported from tta.dev; falling back to core components
WARNING  src.orchestration.orchestrator:orchestrator.py:188 No components imported from tta.prototype; falling back to core components
ERROR    src.common.process_utils:process_utils.py:94 Command failed to start after 0.00s: docker-compose -f /nonexistent/path/docker-compose.yml up -d | err=[Errno 2] No such file or directory: '/nonexistent/path'
ERROR    src.components.player_experience_component:player_experience_component.py:128 Error starting Player Experience services: [Errno 2] No such file or directory: '/nonexistent/path'
ERROR    src.orchestration.component:component.py:118 Failed to start component player_experience
_ TestPlayerExperienceComponentIntegration.test_orchestrator_component_lifecycle _

self = <tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration testMethod=test_orchestrator_component_lifecycle>

    def test_orchestrator_component_lifecycle(self):
        """Test component lifecycle through orchestrator."""
        # Test that orchestrator can find the component
>       self.assertTrue(self.orchestrator.has_component("player_experience"))
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'TTAOrchestrator' object has no attribute 'has_component'

tests/test_player_experience_component_integration.py:203: AttributeError
------------------------------ Captured log call -------------------------------
WARNING  src.orchestration.orchestrator:orchestrator.py:188 No components imported from tta.dev; falling back to core components
WARNING  src.orchestration.orchestrator:orchestrator.py:188 No components imported from tta.prototype; falling back to core components
_ TestPlayerExperienceOrchestrationWorkflow.test_orchestrator_start_component_integration _

self = <tests.test_player_experience_component_integration.TestPlayerExperienceOrchestrationWorkflow testMethod=test_orchestrator_start_component_integration>
mock_start = <MagicMock name='start' id='140674540159568'>

    @patch('src.components.player_experience_component.PlayerExperienceComponent.start')
    def test_orchestrator_start_component_integration(self, mock_start):
        """Test starting player experience through orchestrator."""
        mock_start.return_value = True
    
        # Test starting through orchestrator
        result = self.orchestrator.start_component("player_experience")
>       self.assertTrue(result)
E       AssertionError: False is not true

tests/test_player_experience_component_integration.py:297: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  src.orchestration.orchestrator:orchestrator.py:188 No components imported from tta.dev; falling back to core components
WARNING  src.orchestration.orchestrator:orchestrator.py:188 No components imported from tta.prototype; falling back to core components
ERROR    src.orchestration.orchestrator:orchestrator.py:300 Dependency redis not found for player_experience
__ TestPlayerExperienceOrchestrationIntegration.test_orchestrator_integration __

self = <tests.test_player_experience_orchestration_integration.TestPlayerExperienceOrchestrationIntegration object at 0x7ff15cb2e0d0>
mock_validate = <MagicMock name='_validate_repositories' id='140674519429648'>
mock_import_repo = <MagicMock name='_import_repository_components' id='140674519410192'>
mock_import_core = <MagicMock name='_import_core_components' id='140674518080144'>
mock_config = <MagicMock name='TTAConfig()' spec='function' id='140674618764304'>

    @patch('src.orchestration.orchestrator.TTAOrchestrator._import_core_components')
    @patch('src.orchestration.orchestrator.TTAOrchestrator._import_repository_components')
    @patch('src.orchestration.orchestrator.TTAOrchestrator._validate_repositories')
    def test_orchestrator_integration(self, mock_validate, mock_import_repo, mock_import_core, mock_config):
        """Test that the orchestrator properly integrates the player experience component."""
        # Mock the import methods to avoid actual file system operations
        mock_validate.return_value = None
        mock_import_repo.return_value = None
    
        # Create a mock component for the orchestrator to find
        mock_component = Mock(spec=PlayerExperienceComponent)
        mock_component.name = "player_experience"
        mock_component.dependencies = ["redis", "neo4j"]
        mock_component.status = ComponentStatus.STOPPED
    
        def mock_import_core_side_effect(orchestrator_self):
            orchestrator_self.components["player_experience"] = mock_component
    
        mock_import_core.side_effect = mock_import_core_side_effect
    
        # Create orchestrator with mock config
        with patch('src.orchestration.orchestrator.TTAConfig') as mock_config_class:
            mock_config_class.return_value = mock_config
>           orchestrator = TTAOrchestrator()
                           ^^^^^^^^^^^^^^^^^

tests/test_player_experience_orchestration_integration.py:201: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/orchestration/orchestrator.py:89: in __init__
    self._import_components()
src/orchestration/decorators.py:36: in wrapper
    result = func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^
src/orchestration/decorators.py:59: in wrapper
    result = func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^
src/orchestration/orchestrator.py:126: in _import_components
    self._import_core_components()
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/mock.py:1124: in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/mock.py:1128: in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <MagicMock name='_import_core_components' id='140674518080144'>
args = (), kwargs = {}
effect = <function TestPlayerExperienceOrchestrationIntegration.test_orchestrator_integration.<locals>.mock_import_core_side_effect at 0x7ff15c939260>

    def _execute_mock_call(self, /, *args, **kwargs):
        # separate from _increment_mock_call so that awaited functions are
        # executed separately from their call, also AsyncMock overrides this method
    
        effect = self.side_effect
        if effect is not None:
            if _is_exception(effect):
                raise effect
            elif not _callable(effect):
                result = next(effect)
                if _is_exception(result):
                    raise result
            else:
>               result = effect(*args, **kwargs)
                         ^^^^^^^^^^^^^^^^^^^^^^^
E               TypeError: TestPlayerExperienceOrchestrationIntegration.test_orchestrator_integration.<locals>.mock_import_core_side_effect() missing 1 required positional argument: 'orchestrator_self'

../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/mock.py:1189: TypeError
------------------------------ Captured log call -------------------------------
ERROR    src.orchestration.decorators:decorators.py:40 Exception in _import_components: TestPlayerExperienceOrchestrationIntegration.test_orchestrator_integration.<locals>.mock_import_core_side_effect() missing 1 required positional argument: 'orchestrator_self'
_______________ TestPlayerManagementAPI.test_get_player_success ________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 168, in test_get_player_success
    |     response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 168, in test_get_player_success
    response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb4d6d0>
client = <starlette.testclient.TestClient object at 0x7ff156c13150>
mock_player_manager = <MagicMock id='140674519346192'>
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_get_player_success(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test successful player profile retrieval."""
        mock_player_manager.get_player_profile.return_value = sample_player_profile
    
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
>           response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:168: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/players/test-player-123
______________ TestPlayerManagementAPI.test_get_player_not_found _______________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 187, in test_get_player_not_found
    |     response = client.get("/api/v1/players/nonexistent-player", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 187, in test_get_player_not_found
    response = client.get("/api/v1/players/nonexistent-player", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb31010>
client = <starlette.testclient.TestClient object at 0x7ff154564cd0>
mock_player_manager = <MagicMock id='140674521416592'>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_get_player_not_found(self, client, mock_player_manager, auth_headers):
        """Test player retrieval when player doesn't exist."""
        mock_player_manager.get_player_profile.return_value = None
    
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
>           response = client.get("/api/v1/players/nonexistent-player", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:187: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/players/nonexistent-player
____________ TestPlayerManagementAPI.test_get_player_access_denied _____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 206, in test_get_player_access_denied
    |     response = client.get("/api/v1/players/other-player-id", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 206, in test_get_player_access_denied
    response = client.get("/api/v1/players/other-player-id", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb4dd50>
client = <starlette.testclient.TestClient object at 0x7ff15c94d090>
mock_player_manager = <MagicMock id='140674617110288'>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_get_player_access_denied(self, client, mock_player_manager, auth_headers):
        """Test player retrieval with access denied."""
        mock_player_manager.get_player_profile.side_effect = DataAccessRestrictedError("Access denied")
    
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
>           response = client.get("/api/v1/players/other-player-id", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:206: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/players/other-player-id
______________ TestPlayerManagementAPI.test_update_player_success ______________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 227, in test_update_player_success
    |     response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 583, in put
    |     return super().put(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1194, in put
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 227, in test_update_player_success
    response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 583, in put
    return super().put(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1194, in put
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb4e090>
client = <starlette.testclient.TestClient object at 0x7ff15c9870d0>
mock_player_manager = <MagicMock id='140674521497296'>
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_update_player_success(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test successful player profile update."""
        mock_player_manager.update_player_profile.return_value = True
        mock_player_manager.get_player_profile.return_value = sample_player_profile
    
        request_data = {
            "username": "updateduser",
            "therapeutic_preferences": {
                "intensity_level": "high",
                "preferred_approaches": ["mindfulness"],
                "session_duration_preference": 60
            }
        }
    
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
>           response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:227: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:583: in put
    return super().put(
.venv/lib/python3.11/site-packages/httpx/_client.py:1194: in put
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: PUT /api/v1/players/test-player-123
_________ TestPlayerManagementAPI.test_update_player_validation_error __________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 249, in test_update_player_validation_error
    |     response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 583, in put
    |     return super().put(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1194, in put
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 249, in test_update_player_validation_error
    response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 583, in put
    return super().put(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1194, in put
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb4e3d0>
client = <starlette.testclient.TestClient object at 0x7ff15c97ae50>
mock_player_manager = <MagicMock id='140674617294224'>
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_update_player_validation_error(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test player update with validation errors."""
        request_data = {
            "username": "ab",  # Too short
            "email": "invalid-email"  # Invalid format
        }
    
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
>           response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:249: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:583: in put
    return super().put(
.venv/lib/python3.11/site-packages/httpx/_client.py:1194: in put
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: PUT /api/v1/players/test-player-123
_________ TestPlayerManagementAPI.test_update_player_username_conflict _________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 265, in test_update_player_username_conflict
    |     response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 583, in put
    |     return super().put(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1194, in put
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 265, in test_update_player_username_conflict
    response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 583, in put
    return super().put(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1194, in put
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb4e6d0>
client = <starlette.testclient.TestClient object at 0x7ff156d9f290>
mock_player_manager = <MagicMock id='140674520971600'>
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_update_player_username_conflict(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test player update with username conflict."""
        mock_player_manager.update_player_profile.side_effect = PlayerProfileManagerError("Username 'existinguser' already exists")
    
        request_data = {
            "username": "existinguser"
        }
    
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
>           response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:265: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:583: in put
    return super().put(
.venv/lib/python3.11/site-packages/httpx/_client.py:1194: in put
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: PUT /api/v1/players/test-player-123
______________ TestPlayerManagementAPI.test_delete_player_success ______________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 276, in test_delete_player_success
    |     response = client.delete(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 641, in delete
    |     return super().delete(
    |            ^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1264, in delete
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 276, in test_delete_player_success
    response = client.delete(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 641, in delete
    return super().delete(
           ^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1264, in delete
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb4ec50>
client = <starlette.testclient.TestClient object at 0x7ff156edf490>
mock_player_manager = <MagicMock id='140674522272848'>
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_delete_player_success(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test successful player profile deletion."""
        mock_player_manager.delete_player_profile.return_value = True
    
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
>           response = client.delete(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:276: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:641: in delete
    return super().delete(
.venv/lib/python3.11/site-packages/httpx/_client.py:1264: in delete
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: DELETE /api/v1/players/test-player-123
_____________ TestPlayerManagementAPI.test_delete_player_not_found _____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 291, in test_delete_player_not_found
    |     response = client.delete(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 641, in delete
    |     return super().delete(
    |            ^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1264, in delete
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 291, in test_delete_player_not_found
    response = client.delete(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 641, in delete
    return super().delete(
           ^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1264, in delete
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb4f250>
client = <starlette.testclient.TestClient object at 0x7ff156eb2250>
mock_player_manager = <MagicMock id='140674522098640'>
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_delete_player_not_found(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test player deletion when player doesn't exist."""
        mock_player_manager.delete_player_profile.return_value = False
    
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
>           response = client.delete(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:291: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:641: in delete
    return super().delete(
.venv/lib/python3.11/site-packages/httpx/_client.py:1264: in delete
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: DELETE /api/v1/players/test-player-123
___________ TestPlayerManagementAPI.test_export_player_data_success ____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 314, in test_export_player_data_success
    |     response = client.get(f"/api/v1/players/{sample_player_profile.player_id}/export", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 314, in test_export_player_data_success
    response = client.get(f"/api/v1/players/{sample_player_profile.player_id}/export", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb4f850>
client = <starlette.testclient.TestClient object at 0x7ff156c4d310>
mock_player_manager = <MagicMock id='140674519589904'>
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_export_player_data_success(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test successful player data export."""
        export_data = {
            "player_profile": {
                "player_id": sample_player_profile.player_id,
                "username": sample_player_profile.username,
                "email": sample_player_profile.email,
            },
            "export_metadata": {
                "export_date": datetime.now().isoformat(),
                "export_requested_by": sample_player_profile.player_id,
                "data_format_version": "1.0",
            }
        }
        mock_player_manager.export_player_data.return_value = export_data
    
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
>           response = client.get(f"/api/v1/players/{sample_player_profile.player_id}/export", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:314: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/players/test-player-123/export
_____ TestPlayerManagementAPI.test_update_therapeutic_preferences_success ______
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 342, in test_update_therapeutic_preferences_success
    |     response = client.patch(
    |                ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    |     return super().patch(
    |            ^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 342, in test_update_therapeutic_preferences_success
    response = client.patch(
               ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    return super().patch(
           ^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb4fe50>
client = <starlette.testclient.TestClient object at 0x7ff15516fcd0>
mock_player_manager = <MagicMock id='140674491238608'>
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_update_therapeutic_preferences_success(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test successful therapeutic preferences update."""
        mock_player_manager.update_therapeutic_preferences.return_value = True
        mock_player_manager.get_player_profile.return_value = sample_player_profile
    
        request_data = {
            "intensity_level": "high",
            "preferred_approaches": ["mindfulness", "acceptance_commitment_therapy"],
            "trigger_warnings": ["violence"],
            "session_duration_preference": 60,
            "reminder_frequency": "daily"
        }
    
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
>           response = client.patch(
                f"/api/v1/players/{sample_player_profile.player_id}/therapeutic-preferences",
                json=request_data,
                headers=auth_headers
            )

tests/test_player_management_api.py:342: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:614: in patch
    return super().patch(
.venv/lib/python3.11/site-packages/httpx/_client.py:1231: in patch
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: PATCH /api/v1/players/test-player-123/therapeutic-preferences
_________ TestPlayerManagementAPI.test_update_privacy_settings_success _________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 368, in test_update_privacy_settings_success
    |     response = client.patch(
    |                ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    |     return super().patch(
    |            ^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 368, in test_update_privacy_settings_success
    response = client.patch(
               ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    return super().patch(
           ^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb54490>
client = <starlette.testclient.TestClient object at 0x7ff183fe5950>
mock_player_manager = <MagicMock id='140674478793616'>
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_update_privacy_settings_success(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test successful privacy settings update."""
        mock_player_manager.update_privacy_settings.return_value = True
        mock_player_manager.get_player_profile.return_value = sample_player_profile
    
        request_data = {
            "data_collection_consent": False,
            "research_participation_consent": True,
            "progress_sharing_enabled": False,
            "data_retention_period_days": 180
        }
    
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
>           response = client.patch(
                f"/api/v1/players/{sample_player_profile.player_id}/privacy-settings",
                json=request_data,
                headers=auth_headers
            )

tests/test_player_management_api.py:368: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:614: in patch
    return super().patch(
.venv/lib/python3.11/site-packages/httpx/_client.py:1231: in patch
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: PATCH /api/v1/players/test-player-123/privacy-settings
________ TestPlayerManagementAPI.test_privacy_settings_validation_error ________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 388, in test_privacy_settings_validation_error
    |     response = client.patch(
    |                ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    |     return super().patch(
    |            ^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 388, in test_privacy_settings_validation_error
    response = client.patch(
               ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    return super().patch(
           ^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb54a90>
client = <starlette.testclient.TestClient object at 0x7ff156854ad0>
mock_player_manager = <MagicMock id='140674520096592'>
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_privacy_settings_validation_error(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test privacy settings update with validation error."""
        request_data = {
            "data_retention_period_days": 10  # Too short, minimum is 30
        }
    
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
>           response = client.patch(
                f"/api/v1/players/{sample_player_profile.player_id}/privacy-settings",
                json=request_data,
                headers=auth_headers
            )

tests/test_player_management_api.py:388: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:614: in patch
    return super().patch(
.venv/lib/python3.11/site-packages/httpx/_client.py:1231: in patch
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: PATCH /api/v1/players/test-player-123/privacy-settings
____ TestPlayerManagementAPI.test_therapeutic_preferences_validation_error _____
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 407, in test_therapeutic_preferences_validation_error
    |     response = client.patch(
    |                ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    |     return super().patch(
    |            ^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 407, in test_therapeutic_preferences_validation_error
    response = client.patch(
               ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    return super().patch(
           ^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb550d0>
client = <starlette.testclient.TestClient object at 0x7ff15416ebd0>
mock_player_manager = <MagicMock id='140674474629392'>
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_therapeutic_preferences_validation_error(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test therapeutic preferences update with validation error."""
        request_data = {
            "session_duration_preference": 200,  # Too long, maximum is 120
            "preferred_approaches": ["invalid_approach"]  # Invalid approach
        }
    
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
>           response = client.patch(
                f"/api/v1/players/{sample_player_profile.player_id}/therapeutic-preferences",
                json=request_data,
                headers=auth_headers
            )

tests/test_player_management_api.py:407: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:614: in patch
    return super().patch(
.venv/lib/python3.11/site-packages/httpx/_client.py:1231: in patch
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: PATCH /api/v1/players/test-player-123/therapeutic-preferences
___________ TestPlayerManagementAPI.test_cross_player_access_denied ____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 423, in test_cross_player_access_denied
    |     response = client.get(f"/api/v1/players/{other_player_id}", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 423, in test_cross_player_access_denied
    response = client.get(f"/api/v1/players/{other_player_id}", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb557d0>
client = <starlette.testclient.TestClient object at 0x7ff15516fe90>
mock_player_manager = <MagicMock id='140674491401872'>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_cross_player_access_denied(self, client, mock_player_manager, auth_headers):
        """Test that players cannot access other players' profiles."""
        # Try to access a different player's profile
        other_player_id = "other-player-456"
    
>       response = client.get(f"/api/v1/players/{other_player_id}", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:423: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/players/other-player-456
__________________ TestPlayerManagementAPI.test_cors_headers ___________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 483, in test_cors_headers
    |     response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 483, in test_cors_headers
    response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb4ffd0>
client = <starlette.testclient.TestClient object at 0x7ff1541c7150>
mock_player_manager = <MagicMock id='140674474995728'>
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_cors_headers(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test that CORS headers are properly set."""
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
            mock_player_manager.get_player_profile.return_value = sample_player_profile
    
>           response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:483: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/players/test-player-123
________________ TestPlayerManagementAPI.test_security_headers _________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 494, in test_security_headers
    |     response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 494, in test_security_headers
    response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb33310>
client = <starlette.testclient.TestClient object at 0x7ff15cae0790>
mock_player_manager = <MagicMock id='140674540176336'>
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_security_headers(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test that security headers are properly set."""
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
            mock_player_manager.get_player_profile.return_value = sample_player_profile
    
>           response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:494: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/players/test-player-123
______________ TestPlayerManagementAPI.test_rate_limiting_headers ______________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 508, in test_rate_limiting_headers
    |     response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 508, in test_rate_limiting_headers
    response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = <tests.test_player_management_api.TestPlayerManagementAPI object at 0x7ff15cb56f50>
client = <starlette.testclient.TestClient object at 0x7ff156959410>
mock_player_manager = <MagicMock id='140674516497104'>
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_rate_limiting_headers(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test that rate limiting headers are properly set."""
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
            mock_player_manager.get_player_profile.return_value = sample_player_profile
    
>           response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:508: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/players/test-player-123
__________ test_scale_manager_creates_event_when_magnitude_threshold ___________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7ff1569a6010>

    def test_scale_manager_creates_event_when_magnitude_threshold(monkeypatch):
        sm = ScaleManager(config={})
        choice = PlayerChoice(choice_id="c2", session_id="s1", choice_text="Test", metadata={})
    
        async def fake_assess(choice, scale):
            from src.components.narrative_arc_orchestrator.models import ImpactAssessment
            return ImpactAssessment(scale=scale, magnitude=0.9)
    
        monkeypatch.setattr(sm, "_assess_scale_impact", fake_assess)
    
        import asyncio
    
        events_before = len(sm.get_active_events())
>       asyncio.get_event_loop().run_until_complete(
        ^^^^^^^^^^^^^^^^^^^^^^^^
            sm.evaluate_choice_impact(choice, [NarrativeScale.SHORT_TERM])
        )

tests/test_scale_manager_extraction.py:30: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <asyncio.unix_events._UnixDefaultEventLoopPolicy object at 0x7ff15cc55550>

    def get_event_loop(self):
        """Get the event loop for the current context.
    
        Returns an instance of EventLoop or raises an exception.
        """
        if (self._local._loop is None and
                not self._local._set_called and
                threading.current_thread() is threading.main_thread()):
            self.set_event_loop(self.new_event_loop())
    
        if self._local._loop is None:
>           raise RuntimeError('There is no current event loop in thread %r.'
                               % threading.current_thread().name)
E           RuntimeError: There is no current event loop in thread 'MainThread'.

../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/asyncio/events.py:681: RuntimeError
_________________________ test_list_worlds_happy_path __________________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 52, in test_list_worlds_happy_path
    |     resp = client.get("/api/v1/worlds/?limit=1&offset=0", headers=auth_headers)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 52, in test_list_worlds_happy_path
    resp = client.get("/api/v1/worlds/?limit=1&offset=0", headers=auth_headers)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7ff1551210d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_list_worlds_happy_path(client: TestClient, auth_headers: Dict[str, str]) -> None:
>       resp = client.get("/api/v1/worlds/?limit=1&offset=0", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_world_management_api.py:52: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/worlds/
______________________ test_get_world_details_happy_path _______________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 61, in test_get_world_details_happy_path
    |     resp = client.get("/api/v1/worlds/world_mindfulness_garden", headers=auth_headers)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 61, in test_get_world_details_happy_path
    resp = client.get("/api/v1/worlds/world_mindfulness_garden", headers=auth_headers)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7ff156cd0290>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_get_world_details_happy_path(client: TestClient, auth_headers: Dict[str, str]) -> None:
>       resp = client.get("/api/v1/worlds/world_mindfulness_garden", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_world_management_api.py:61: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/worlds/world_mindfulness_garden
________________________ test_compatibility_happy_path _________________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 69, in test_compatibility_happy_path
    |     resp = client.get(
    |            ^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 69, in test_compatibility_happy_path
    resp = client.get(
           ^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7ff1541c63d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_compatibility_happy_path(client: TestClient, auth_headers: Dict[str, str]) -> None:
>       resp = client.get(
            "/api/v1/worlds/world_mindfulness_garden/compatibility/char-xyz",
            headers=auth_headers,
        )

tests/test_world_management_api.py:69: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/worlds/world_mindfulness_garden/compatibility/char-xyz
_______________________ test_customize_world_happy_path ________________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 81, in test_customize_world_happy_path
    |     resp = client.post(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 81, in test_customize_world_happy_path
    resp = client.post(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7ff156ab4b90>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_customize_world_happy_path(client: TestClient, auth_headers: Dict[str, str]) -> None:
        payload = {"therapeutic_intensity": 0.7, "session_length_preference": 45}
>       resp = client.post(
            "/api/v1/worlds/world_mindfulness_garden/customize",
            headers=auth_headers,
            json=payload,
        )

tests/test_world_management_api.py:81: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.11/site-packages/httpx/_client.py:1157: in post
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: POST /api/v1/worlds/world_mindfulness_garden/customize
___________________________ test_get_world_not_found ___________________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 95, in test_get_world_not_found
    |     resp = client.get("/api/v1/worlds/does-not-exist", headers=auth_headers)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 95, in test_get_world_not_found
    resp = client.get("/api/v1/worlds/does-not-exist", headers=auth_headers)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7ff156a135d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_get_world_not_found(client: TestClient, auth_headers: Dict[str, str]) -> None:
>       resp = client.get("/api/v1/worlds/does-not-exist", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_world_management_api.py:95: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/worlds/does-not-exist
________________________ test_customize_world_not_found ________________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 100, in test_customize_world_not_found
    |     resp = client.post(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 100, in test_customize_world_not_found
    resp = client.post(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7ff154565f50>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_customize_world_not_found(client: TestClient, auth_headers: Dict[str, str]) -> None:
>       resp = client.post(
            "/api/v1/worlds/does-not-exist/customize",
            headers=auth_headers,
            json={},
        )

tests/test_world_management_api.py:100: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.11/site-packages/httpx/_client.py:1157: in post
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: POST /api/v1/worlds/does-not-exist/customize
_____________________ test_customize_world_invalid_params ______________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 111, in test_customize_world_invalid_params
    |     resp = client.post(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 111, in test_customize_world_invalid_params
    resp = client.post(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7ff156c27e10>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_customize_world_invalid_params(client: TestClient, auth_headers: Dict[str, str]) -> None:
        # invalid session length < 10
        payload = {"session_length_preference": 5}
>       resp = client.post(
            "/api/v1/worlds/world_mindfulness_garden/customize",
            headers=auth_headers,
            json=payload,
        )

tests/test_world_management_api.py:111: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.11/site-packages/httpx/_client.py:1157: in post
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: POST /api/v1/worlds/world_mindfulness_garden/customize
_________________________ test_list_worlds_pagination __________________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 120, in test_list_worlds_pagination
    |     resp_all = client.get("/api/v1/worlds/", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 120, in test_list_worlds_pagination
    resp_all = client.get("/api/v1/worlds/", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7ff156d00450>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_list_worlds_pagination(client: TestClient, auth_headers: Dict[str, str]) -> None:
>       resp_all = client.get("/api/v1/worlds/", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_world_management_api.py:120: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None)
item = 'get'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.player_experience.api.middleware::0 Request started: GET /api/v1/worlds/
=============================== warnings summary ===============================
.venv/lib/python3.11/site-packages/passlib/utils/__init__.py:854
  /home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
    from crypt import crypt as _crypt

.venv/lib/python3.11/site-packages/pythonjsonlogger/jsonlogger.py:11
  /home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pythonjsonlogger/jsonlogger.py:11: DeprecationWarning: pythonjsonlogger.jsonlogger has been moved to pythonjsonlogger.json
    warnings.warn(

src/player_experience/api/config.py:124
  /home/thein/projects/projects/TTA/src/player_experience/api/config.py:124: PytestCollectionWarning: cannot collect test class 'TestingSettings' because it has a __init__ constructor (from: tests/test_api_integration.py)
    class TestingSettings(APISettings):

src/player_experience/api/config.py:124
  /home/thein/projects/projects/TTA/src/player_experience/api/config.py:124: PytestCollectionWarning: cannot collect test class 'TestingSettings' because it has a __init__ constructor (from: tests/test_api_structure.py)
    class TestingSettings(APISettings):

src/player_experience/api/config.py:124
  /home/thein/projects/projects/TTA/src/player_experience/api/config.py:124: PytestCollectionWarning: cannot collect test class 'TestingSettings' because it has a __init__ constructor (from: tests/test_character_management_api.py)
    class TestingSettings(APISettings):

src/player_experience/api/config.py:124
  /home/thein/projects/projects/TTA/src/player_experience/api/config.py:124: PytestCollectionWarning: cannot collect test class 'TestingSettings' because it has a __init__ constructor (from: tests/test_end_to_end_workflows.py)
    class TestingSettings(APISettings):

tests/test_player_experience_orchestration_integration.py:359
  /home/thein/projects/projects/TTA/tests/test_player_experience_orchestration_integration.py:359: PytestUnknownMarkWarning: Unknown pytest.mark.integration - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.integration

src/player_experience/api/config.py:124
  /home/thein/projects/projects/TTA/src/player_experience/api/config.py:124: PytestCollectionWarning: cannot collect test class 'TestingSettings' because it has a __init__ constructor (from: tests/test_websocket_chat_backend.py)
    class TestingSettings(APISettings):

src/player_experience/api/config.py:124
  /home/thein/projects/projects/TTA/src/player_experience/api/config.py:124: PytestCollectionWarning: cannot collect test class 'TestingSettings' because it has a __init__ constructor (from: tests/test_websocket_chat_backend_task8_2.py)
    class TestingSettings(APISettings):

src/player_experience/api/config.py:124
  /home/thein/projects/projects/TTA/src/player_experience/api/config.py:124: PytestCollectionWarning: cannot collect test class 'TestingSettings' because it has a __init__ constructor (from: tests/test_websocket_chat_interactive.py)
    class TestingSettings(APISettings):

src/player_experience/api/config.py:124
  /home/thein/projects/projects/TTA/src/player_experience/api/config.py:124: PytestCollectionWarning: cannot collect test class 'TestingSettings' because it has a __init__ constructor (from: tests/test_websocket_chat_typing_and_metrics.py)
    class TestingSettings(APISettings):

src/player_experience/api/config.py:124
  /home/thein/projects/projects/TTA/src/player_experience/api/config.py:124: PytestCollectionWarning: cannot collect test class 'TestingSettings' because it has a __init__ constructor (from: tests/test_world_management_api.py)
    class TestingSettings(APISettings):

tests/test_session_management.py::TestSessionRepository::test_create_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:579: RuntimeWarning: coroutine 'TestSessionRepository.test_create_session' was never awaited
    if method() is not None:
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_session_management.py::TestSessionRepository::test_create_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:678: DeprecationWarning: It is deprecated to return a value that is not None from a test case (<bound method TestSessionRepository.test_create_session of <tests.test_session_management.TestSessionRepository testMethod=test_create_session>>)
    return self.run(*args, **kwds)

tests/test_session_management.py::TestSessionRepository::test_end_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:579: RuntimeWarning: coroutine 'TestSessionRepository.test_end_session' was never awaited
    if method() is not None:
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_session_management.py::TestSessionRepository::test_end_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:678: DeprecationWarning: It is deprecated to return a value that is not None from a test case (<bound method TestSessionRepository.test_end_session of <tests.test_session_management.TestSessionRepository testMethod=test_end_session>>)
    return self.run(*args, **kwds)

tests/test_session_management.py::TestSessionRepository::test_get_session_from_cache
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:579: RuntimeWarning: coroutine 'TestSessionRepository.test_get_session_from_cache' was never awaited
    if method() is not None:
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_session_management.py::TestSessionRepository::test_get_session_from_cache
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:678: DeprecationWarning: It is deprecated to return a value that is not None from a test case (<bound method TestSessionRepository.test_get_session_from_cache of <tests.test_session_management.TestSessionRepository testMethod=test_get_session_from_cache>>)
    return self.run(*args, **kwds)

tests/test_session_management.py::TestSessionRepository::test_pause_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:579: RuntimeWarning: coroutine 'TestSessionRepository.test_pause_session' was never awaited
    if method() is not None:
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_session_management.py::TestSessionRepository::test_pause_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:678: DeprecationWarning: It is deprecated to return a value that is not None from a test case (<bound method TestSessionRepository.test_pause_session of <tests.test_session_management.TestSessionRepository testMethod=test_pause_session>>)
    return self.run(*args, **kwds)

tests/test_session_management.py::TestSessionIntegrationManager::test_add_progress_marker
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:579: RuntimeWarning: coroutine 'TestSessionIntegrationManager.test_add_progress_marker' was never awaited
    if method() is not None:
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_session_management.py::TestSessionIntegrationManager::test_add_progress_marker
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:678: DeprecationWarning: It is deprecated to return a value that is not None from a test case (<bound method TestSessionIntegrationManager.test_add_progress_marker of <tests.test_session_management.TestSessionIntegrationManager testMethod=test_add_progress_marker>>)
    return self.run(*args, **kwds)

tests/test_session_management.py::TestSessionIntegrationManager::test_create_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:579: RuntimeWarning: coroutine 'TestSessionIntegrationManager.test_create_session' was never awaited
    if method() is not None:
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_session_management.py::TestSessionIntegrationManager::test_create_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:678: DeprecationWarning: It is deprecated to return a value that is not None from a test case (<bound method TestSessionIntegrationManager.test_create_session of <tests.test_session_management.TestSessionIntegrationManager testMethod=test_create_session>>)
    return self.run(*args, **kwds)

tests/test_session_management.py::TestSessionIntegrationManager::test_end_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:579: RuntimeWarning: coroutine 'TestSessionIntegrationManager.test_end_session' was never awaited
    if method() is not None:
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_session_management.py::TestSessionIntegrationManager::test_end_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:678: DeprecationWarning: It is deprecated to return a value that is not None from a test case (<bound method TestSessionIntegrationManager.test_end_session of <tests.test_session_management.TestSessionIntegrationManager testMethod=test_end_session>>)
    return self.run(*args, **kwds)

tests/test_session_management.py::TestSessionIntegrationManager::test_pause_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:579: RuntimeWarning: coroutine 'TestSessionIntegrationManager.test_pause_session' was never awaited
    if method() is not None:
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_session_management.py::TestSessionIntegrationManager::test_pause_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:678: DeprecationWarning: It is deprecated to return a value that is not None from a test case (<bound method TestSessionIntegrationManager.test_pause_session of <tests.test_session_management.TestSessionIntegrationManager testMethod=test_pause_session>>)
    return self.run(*args, **kwds)

tests/test_session_management.py::TestSessionIntegrationManager::test_resume_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:579: RuntimeWarning: coroutine 'TestSessionIntegrationManager.test_resume_session' was never awaited
    if method() is not None:
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_session_management.py::TestSessionIntegrationManager::test_resume_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:678: DeprecationWarning: It is deprecated to return a value that is not None from a test case (<bound method TestSessionIntegrationManager.test_resume_session of <tests.test_session_management.TestSessionIntegrationManager testMethod=test_resume_session>>)
    return self.run(*args, **kwds)

tests/test_session_management.py::TestSessionIntegrationManager::test_switch_character_world_context_existing_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:579: RuntimeWarning: coroutine 'TestSessionIntegrationManager.test_switch_character_world_context_existing_session' was never awaited
    if method() is not None:
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_session_management.py::TestSessionIntegrationManager::test_switch_character_world_context_existing_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:678: DeprecationWarning: It is deprecated to return a value that is not None from a test case (<bound method TestSessionIntegrationManager.test_switch_character_world_context_existing_session of <tests.test_session_management.TestSessionIntegrationManager testMethod=test_switch_character_world_context_existing_session>>)
    return self.run(*args, **kwds)

tests/test_session_management.py::TestSessionIntegrationManager::test_switch_character_world_context_new_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:579: RuntimeWarning: coroutine 'TestSessionIntegrationManager.test_switch_character_world_context_new_session' was never awaited
    if method() is not None:
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_session_management.py::TestSessionIntegrationManager::test_switch_character_world_context_new_session
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:678: DeprecationWarning: It is deprecated to return a value that is not None from a test case (<bound method TestSessionIntegrationManager.test_switch_character_world_context_new_session of <tests.test_session_management.TestSessionIntegrationManager testMethod=test_switch_character_world_context_new_session>>)
    return self.run(*args, **kwds)

tests/test_session_management.py::TestSessionIntegrationManager::test_update_session_interaction
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:579: RuntimeWarning: coroutine 'TestSessionIntegrationManager.test_update_session_interaction' was never awaited
    if method() is not None:
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_session_management.py::TestSessionIntegrationManager::test_update_session_interaction
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:678: DeprecationWarning: It is deprecated to return a value that is not None from a test case (<bound method TestSessionIntegrationManager.test_update_session_interaction of <tests.test_session_management.TestSessionIntegrationManager testMethod=test_update_session_interaction>>)
    return self.run(*args, **kwds)

tests/test_session_management.py::TestSessionIntegrationManager::test_update_therapeutic_settings
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:579: RuntimeWarning: coroutine 'TestSessionIntegrationManager.test_update_therapeutic_settings' was never awaited
    if method() is not None:
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_session_management.py::TestSessionIntegrationManager::test_update_therapeutic_settings
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:678: DeprecationWarning: It is deprecated to return a value that is not None from a test case (<bound method TestSessionIntegrationManager.test_update_therapeutic_settings of <tests.test_session_management.TestSessionIntegrationManager testMethod=test_update_therapeutic_settings>>)
    return self.run(*args, **kwds)

tests/test_session_management.py::TestSessionLifecycleIntegration::test_complete_session_lifecycle
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:579: RuntimeWarning: coroutine 'TestSessionLifecycleIntegration.test_complete_session_lifecycle' was never awaited
    if method() is not None:
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_session_management.py::TestSessionLifecycleIntegration::test_complete_session_lifecycle
  /home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/case.py:678: DeprecationWarning: It is deprecated to return a value that is not None from a test case (<bound method TestSessionLifecycleIntegration.test_complete_session_lifecycle of <tests.test_session_management.TestSessionLifecycleIntegration testMethod=test_complete_session_lifecycle>>)
    return self.run(*args, **kwds)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
SKIPPED [2] tests/test_player_profile_database_param.py:10: Neo4j container not requested; use --neo4j or RUN_NEO4J_TESTS=1
SKIPPED [2] tests/test_player_profile_database_param.py:37: Neo4j container not requested; use --neo4j or RUN_NEO4J_TESTS=1
SKIPPED [1] tests/test_redis_integration.py:5: Redis container not requested; use --redis or RUN_REDIS_TESTS=1
SKIPPED [1] tests/test_redis_integration.py:12: Redis container not requested; use --redis or RUN_REDIS_TESTS=1
SKIPPED [1] tests/test_session_repository_redis_integration.py:10: Redis container not requested; use --redis or RUN_REDIS_TESTS=1
FAILED tests/test_api_integration.py::test_authentication_flow - assert 500 =...
FAILED tests/test_api_structure.py::test_auth_router_included - assert 422 ==...
FAILED tests/test_end_to_end_workflows.py::TestEndToEndUserWorkflows::test_complete_new_user_journey
FAILED tests/test_end_to_end_workflows.py::TestEndToEndUserWorkflows::test_multi_character_workflow
FAILED tests/test_end_to_end_workflows.py::TestEndToEndUserWorkflows::test_therapeutic_settings_adaptation_workflow
FAILED tests/test_end_to_end_workflows.py::TestConcurrentUserScenarios::test_concurrent_api_requests
FAILED tests/test_end_to_end_workflows.py::TestConcurrentUserScenarios::test_session_state_consistency_under_load
FAILED tests/test_end_to_end_workflows.py::TestErrorHandlingAndRecovery::test_invalid_data_handling
FAILED tests/test_end_to_end_workflows.py::TestErrorHandlingAndRecovery::test_authentication_failure_recovery
FAILED tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_component_start_integration
FAILED tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_component_stop_integration
FAILED tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_error_handling_integration
FAILED tests/test_player_experience_component_integration.py::TestPlayerExperienceComponentIntegration::test_orchestrator_component_lifecycle
FAILED tests/test_player_experience_component_integration.py::TestPlayerExperienceOrchestrationWorkflow::test_orchestrator_start_component_integration
FAILED tests/test_player_experience_orchestration_integration.py::TestPlayerExperienceOrchestrationIntegration::test_orchestrator_integration
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_get_player_success
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_get_player_not_found
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_get_player_access_denied
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_update_player_success
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_update_player_validation_error
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_update_player_username_conflict
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_delete_player_success
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_delete_player_not_found
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_export_player_data_success
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_update_therapeutic_preferences_success
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_update_privacy_settings_success
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_privacy_settings_validation_error
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_therapeutic_preferences_validation_error
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_cross_player_access_denied
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_cors_headers
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_security_headers
FAILED tests/test_player_management_api.py::TestPlayerManagementAPI::test_rate_limiting_headers
FAILED tests/test_scale_manager_extraction.py::test_scale_manager_creates_event_when_magnitude_threshold
FAILED tests/test_world_management_api.py::test_list_worlds_happy_path - Attr...
FAILED tests/test_world_management_api.py::test_get_world_details_happy_path
FAILED tests/test_world_management_api.py::test_compatibility_happy_path - At...
FAILED tests/test_world_management_api.py::test_customize_world_happy_path - ...
FAILED tests/test_world_management_api.py::test_get_world_not_found - Attribu...
FAILED tests/test_world_management_api.py::test_customize_world_not_found - A...
FAILED tests/test_world_management_api.py::test_customize_world_invalid_params
FAILED tests/test_world_management_api.py::test_list_worlds_pagination - Attr...
=========== 41 failed, 454 passed, 7 skipped, 40 warnings in 20.93s ============
