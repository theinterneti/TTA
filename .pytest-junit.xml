<?xml version="1.0" encoding="utf-8"?><testsuites name="pytest tests"><testsuite name="pytest" errors="0" failures="51" skipped="7" tests="498" time="19.551" timestamp="2025-08-16T23:41:43.256362-07:00" hostname="Gamepower"><testcase classname="tests.test_api_integration" name="test_server_startup_and_basic_endpoints" time="0.092" /><testcase classname="tests.test_api_integration" name="test_authentication_flow" time="0.030"><failure message="assert 500 == 401&#10; +  where 500 = &lt;Response [500 Internal Server Error]&gt;.status_code">client = &lt;starlette.testclient.TestClient object at 0x7f0ab9d14710&gt;

    def test_authentication_flow(client):
        """Test the authentication endpoints."""
        # Test login endpoint (should fail with invalid credentials)
        response = client.post("/api/v1/auth/login", json={
            "username": "testuser",
            "password": "testpass"
        })
&gt;       assert response.status_code == 401
E       assert 500 == 401
E        +  where 500 = &lt;Response [500 Internal Server Error]&gt;.status_code

tests/test_api_integration.py:58: AssertionError</failure></testcase><testcase classname="tests.test_api_integration" name="test_protected_endpoints_require_auth" time="0.032" /><testcase classname="tests.test_api_integration" name="test_middleware_functionality" time="0.029" /><testcase classname="tests.test_api_integration" name="test_cors_configuration" time="0.035" /><testcase classname="tests.test_api_integration" name="test_error_handling" time="0.036" /><testcase classname="tests.test_api_integration" name="test_async_functionality" time="0.039" /><testcase classname="tests.test_api_structure" name="test_root_endpoint" time="0.030" /><testcase classname="tests.test_api_structure" name="test_health_endpoint" time="0.030" /><testcase classname="tests.test_api_structure" name="test_security_headers" time="0.035" /><testcase classname="tests.test_api_structure" name="test_cors_headers" time="0.032" /><testcase classname="tests.test_api_structure" name="test_rate_limiting_headers" time="0.032" /><testcase classname="tests.test_api_structure" name="test_processing_time_header" time="0.031" /><testcase classname="tests.test_api_structure" name="test_therapeutic_safety_headers" time="0.028" /><testcase classname="tests.test_api_structure" name="test_auth_router_included" time="0.031"><failure message="assert 422 == 401&#10; +  where 422 = &lt;Response [422 Unprocessable Entity]&gt;.status_code">client = &lt;starlette.testclient.TestClient object at 0x7f0ab89e0390&gt;

    def test_auth_router_included(client):
        """Test that authentication router is included."""
        # Test a public auth endpoint
        response = client.post("/api/v1/auth/login", json={
            "username": "test",
            "password": "test"
        })
        # Should return 401 for invalid credentials, not 404
&gt;       assert response.status_code == 401
E       assert 422 == 401
E        +  where 422 = &lt;Response [422 Unprocessable Entity]&gt;.status_code

tests/test_api_structure.py:100: AssertionError</failure></testcase><testcase classname="tests.test_api_structure" name="test_players_router_included" time="0.027" /><testcase classname="tests.test_api_structure" name="test_characters_router_included" time="0.032" /><testcase classname="tests.test_api_structure" name="test_worlds_router_included" time="0.027" /><testcase classname="tests.test_api_structure" name="test_openapi_docs_available" time="0.154" /><testcase classname="tests.test_api_structure" name="test_authentication_middleware_public_routes" time="0.085" /><testcase classname="tests.test_api_structure" name="test_authentication_middleware_protected_routes" time="0.033" /><testcase classname="tests.test_api_structure" name="test_invalid_authorization_header" time="0.028" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManager" name="test_create_character_invalid_data" time="0.001" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManager" name="test_create_character_limit_exceeded" time="0.002" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManager" name="test_create_character_success" time="0.001" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManager" name="test_delete_character" time="0.001" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManager" name="test_extract_personality_traits" time="0.001" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManager" name="test_get_character" time="0.001" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManager" name="test_get_character_statistics" time="0.001" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManager" name="test_get_character_therapeutic_profile" time="0.001" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManager" name="test_get_player_characters" time="0.001" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManager" name="test_update_character" time="0.001" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManager" name="test_update_character_therapeutic_profile" time="0.001" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManagerIntegration" name="test_adapt_therapeutic_content_for_character" time="0.003" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManagerIntegration" name="test_create_character_calls_development_system" time="0.002" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManagerIntegration" name="test_create_character_calls_personalization_engine" time="0.003" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManagerIntegration" name="test_get_character_personalization_recommendations" time="0.002" /><testcase classname="tests.test_character_avatar_manager.TestCharacterAvatarManagerIntegration" name="test_update_character_calls_personalization_engine" time="0.004" /><testcase classname="tests.test_character_management_api" name="test_characters_root_requires_auth" time="0.028" /><testcase classname="tests.test_character_management_api" name="test_list_characters_requires_auth" time="0.028" /><testcase classname="tests.test_character_management_api" name="test_get_character_requires_auth" time="0.029" /><testcase classname="tests.test_character_management_api" name="test_update_therapeutic_profile_requires_auth" time="0.028" /><testcase classname="tests.test_compatibility_checker.TestCompatibilityChecker" name="test_comprehensive_compatibility_calculation" time="0.001" /><testcase classname="tests.test_compatibility_checker.TestCompatibilityChecker" name="test_content_safety_compatibility" time="0.000" /><testcase classname="tests.test_compatibility_checker.TestCompatibilityChecker" name="test_custom_weights" time="0.000" /><testcase classname="tests.test_compatibility_checker.TestCompatibilityChecker" name="test_difficulty_appropriateness" time="0.001" /><testcase classname="tests.test_compatibility_checker.TestCompatibilityChecker" name="test_edge_cases" time="0.001" /><testcase classname="tests.test_compatibility_checker.TestCompatibilityChecker" name="test_initialization" time="0.001" /><testcase classname="tests.test_compatibility_checker.TestCompatibilityChecker" name="test_prerequisite_fulfillment" time="0.001" /><testcase classname="tests.test_compatibility_checker.TestCompatibilityChecker" name="test_recommendations_and_warnings_generation" time="0.001" /><testcase classname="tests.test_compatibility_checker.TestCompatibilityChecker" name="test_therapeutic_approach_alignment" time="0.000" /><testcase classname="tests.test_compatibility_checker.TestCompatibilityChecker" name="test_therapeutic_readiness_compatibility" time="0.000" /><testcase classname="tests.test_compatibility_checker.TestCompatibilityChecker" name="test_world_recommendations" time="0.001" /><testcase classname="tests.test_compatibility_checker.TestCompatibilityChecker" name="test_world_suitability_assessment" time="0.001" /><testcase classname="tests.test_components.TestComponents" name="test_carbon_component" time="3.763" /><testcase classname="tests.test_components.TestComponents" name="test_config_validation" time="0.000" /><testcase classname="tests.test_components.TestComponents" name="test_docker_component" time="0.001" /><testcase classname="tests.test_end_to_end_workflows.TestEndToEndUserWorkflows" name="test_complete_new_user_journey" time="0.036"><failure message="assert 422 == 201&#10; +  where 422 = &lt;Response [422 Unprocessable Entity]&gt;.status_code">self = &lt;tests.test_end_to_end_workflows.TestEndToEndUserWorkflows object at 0x7f0aba8b4450&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0aba5e7e90&gt;

    def test_complete_new_user_journey(self, client):
        """Test complete journey for a new user from registration to therapeutic interaction."""
        player_id = "new-user-123"
        token = create_auth_token(player_id, "newuser", "newuser@example.com")
        headers = {"Authorization": f"Bearer {token}"}

        # Step 1: Create player profile
        profile_data = {
            "username": "newuser",
            "email": "newuser@example.com",
            "therapeutic_preferences": {
                "intensity_level": "medium",
                "preferred_approaches": ["cbt", "mindfulness"],
                "trigger_warnings": ["violence"],
                "comfort_topics": ["relationships"],
                "avoid_topics": ["trauma"]
            },
            "privacy_settings": {
                "data_sharing_consent": True,
                "research_participation": False,
                "contact_preferences": ["email"]
            }
        }

        response = client.post("/api/v1/players/", json=profile_data, headers=headers)
&gt;       assert response.status_code == 201
E       assert 422 == 201
E        +  where 422 = &lt;Response [422 Unprocessable Entity]&gt;.status_code

tests/test_end_to_end_workflows.py:113: AssertionError</failure></testcase><testcase classname="tests.test_end_to_end_workflows.TestEndToEndUserWorkflows" name="test_multi_character_workflow" time="0.036"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 251, in test_multi_character_workflow
    |     response = client.post("/api/v1/characters/", json=char_data, headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 251, in test_multi_character_workflow
    response = client.post("/api/v1/characters/", json=char_data, headers=headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_end_to_end_workflows.TestEndToEndUserWorkflows object at 0x7f0aba8b47d0&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0aba53a210&gt;

    def test_multi_character_workflow(self, client):
        """Test workflow with multiple characters and world switching."""
        player_id = "multi-char-user"
        token = create_auth_token(player_id)
        headers = {"Authorization": f"Bearer {token}"}

        # Create player profile
        profile_data = {
            "username": "multiuser",
            "email": "multi@example.com",
            "therapeutic_preferences": {
                "intensity_level": "medium",
                "preferred_approaches": ["cbt", "narrative_therapy"],
                "trigger_warnings": [],
                "comfort_topics": ["personal_growth"],
                "avoid_topics": []
            }
        }
        client.post("/api/v1/players/", json=profile_data, headers=headers)

        # Create multiple characters
        characters = []
        for i, name in enumerate(["Character1", "Character2", "Character3"]):
            char_data = create_test_character_data(name)
            # Vary therapeutic approaches
            char_data["therapeutic_profile"]["therapeutic_approaches"] = [
                ["cbt"], ["narrative_therapy"], ["mindfulness"]
            ][i]

&gt;           response = client.post("/api/v1/characters/", json=char_data, headers=headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_end_to_end_workflows.py:251:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.11/site-packages/httpx/_client.py:1157: in post
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='multi-char-user', username='testuser', email='test@example.com', exp=datetime.datetime(2025, 8, 17, 7, 41, 49, tzinfo=datetime.timezone.utc))
item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_end_to_end_workflows.TestEndToEndUserWorkflows" name="test_therapeutic_settings_adaptation_workflow" time="0.034"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 346, in test_therapeutic_settings_adaptation_workflow
    |     response = client.post("/api/v1/characters/", json=char_data, headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 346, in test_therapeutic_settings_adaptation_workflow
    response = client.post("/api/v1/characters/", json=char_data, headers=headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_end_to_end_workflows.TestEndToEndUserWorkflows object at 0x7f0aba8b4a90&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab8a0cad0&gt;

    def test_therapeutic_settings_adaptation_workflow(self, client):
        """Test workflow where therapeutic settings are adapted based on user feedback."""
        player_id = "adaptive-user"
        token = create_auth_token(player_id)
        headers = {"Authorization": f"Bearer {token}"}

        # Create player and character
        profile_data = {
            "username": "adaptiveuser",
            "email": "adaptive@example.com",
            "therapeutic_preferences": {
                "intensity_level": "low",  # Start with low intensity
                "preferred_approaches": ["mindfulness"],
                "trigger_warnings": ["anxiety"],
                "comfort_topics": ["relaxation"],
                "avoid_topics": ["stress"]
            }
        }
        client.post("/api/v1/players/", json=profile_data, headers=headers)

        char_data = create_test_character_data("Adaptive Character")
        char_data["therapeutic_profile"]["preferred_intensity"] = "low"
&gt;       response = client.post("/api/v1/characters/", json=char_data, headers=headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_end_to_end_workflows.py:346:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.11/site-packages/httpx/_client.py:1157: in post
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='adaptive-user', username='testuser', email='test@example.com', exp=datetime.datetime(2025, 8, 17, 7, 41, 50, tzinfo=datetime.timezone.utc))
item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_end_to_end_workflows.TestConcurrentUserScenarios" name="test_concurrent_websocket_connections" time="0.085"><failure message="assert 0 &gt;= (10 * 0.9)&#10; +  where 0 = len([])">self = &lt;tests.test_end_to_end_workflows.TestConcurrentUserScenarios object at 0x7f0aba8b5110&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab8975390&gt;

    def test_concurrent_websocket_connections(self, client):
        """Test multiple concurrent WebSocket connections."""
        num_users = 10
        connection_results = []

        def create_user_connection(user_id: int):
            """Create a WebSocket connection for a user and perform basic interaction."""
            try:
                player_id = f"concurrent-user-{user_id}"
                token = create_auth_token(player_id)

                start_time = time.time()

                with client.websocket_connect(f"/ws/chat?token={token}") as websocket:
                    # Receive welcome message
                    welcome_msg = json.loads(websocket.receive_text())
                    assert welcome_msg["role"] == "system"

                    # Send test message
                    user_message = {
                        "type": "user_message",
                        "content": {"text": f"Hello from user {user_id}"},
                        "metadata": {
                            "character_id": f"char-{user_id}",
                            "world_id": "world-1"
                        }
                    }
                    websocket.send_text(json.dumps(user_message))

                    # Receive response
                    response_msg = json.loads(websocket.receive_text())
                    assert response_msg["role"] == "assistant"

                    connection_time = time.time() - start_time

                    return {
                        "user_id": user_id,
                        "success": True,
                        "connection_time": connection_time,
                        "response_received": True
                    }

            except Exception as e:
                return {
                    "user_id": user_id,
                    "success": False,
                    "error": str(e),
                    "connection_time": None
                }

        # Execute concurrent connections
        with ThreadPoolExecutor(max_workers=num_users) as executor:
            futures = [executor.submit(create_user_connection, i) for i in range(num_users)]

            for future in as_completed(futures):
                result = future.result()
                connection_results.append(result)

        # Analyze results
        successful_connections = [r for r in connection_results if r["success"]]
        failed_connections = [r for r in connection_results if not r["success"]]

        # Assert performance requirements
&gt;       assert len(successful_connections) &gt;= num_users * 0.9  # 90% success rate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       assert 0 &gt;= (10 * 0.9)
E        +  where 0 = len([])

tests/test_end_to_end_workflows.py:503: AssertionError</failure></testcase><testcase classname="tests.test_end_to_end_workflows.TestConcurrentUserScenarios" name="test_concurrent_api_requests" time="0.133"><failure message="AssertionError: assert 13 &gt;= (20 * 0.95)&#10; +  where 13 = len([{'endpoint': '/', 'request_id': 5, 'request_time': 0.034700632095336914, 'status_code': 200, ...}, {'endpoint': '/', ...ode': 200, ...}, {'endpoint': '/', 'request_id': 8, 'request_time': 0.04347348213195801, 'status_code': 200, ...}, ...])">self = &lt;tests.test_end_to_end_workflows.TestConcurrentUserScenarios object at 0x7f0aba8b5490&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab88f1fd0&gt;

    def test_concurrent_api_requests(self, client):
        """Test concurrent API requests performance."""
        num_requests = 20
        request_results = []

        def make_api_request(request_id: int):
            """Make a concurrent API request."""
            try:
                player_id = f"api-user-{request_id}"
                token = create_auth_token(player_id)
                headers = {"Authorization": f"Bearer {token}"}

                start_time = time.time()

                # Test different endpoints
                endpoints = [
                    ("/api/v1/worlds/", "GET"),
                    ("/health", "GET"),
                    ("/", "GET")
                ]

                endpoint, method = endpoints[request_id % len(endpoints)]

                if method == "GET":
                    response = client.get(endpoint, headers=headers if endpoint.startswith("/api/") else None)

                request_time = time.time() - start_time

                return {
                    "request_id": request_id,
                    "endpoint": endpoint,
                    "success": response.status_code &lt; 400,
                    "status_code": response.status_code,
                    "request_time": request_time
                }

            except Exception as e:
                return {
                    "request_id": request_id,
                    "success": False,
                    "error": str(e),
                    "request_time": None
                }

        # Execute concurrent requests
        with ThreadPoolExecutor(max_workers=num_requests) as executor:
            futures = [executor.submit(make_api_request, i) for i in range(num_requests)]

            for future in as_completed(futures):
                result = future.result()
                request_results.append(result)

        # Analyze results
        successful_requests = [r for r in request_results if r["success"]]
        failed_requests = [r for r in request_results if not r["success"]]

        # Performance assertions
&gt;       assert len(successful_requests) &gt;= num_requests * 0.95  # 95% success rate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AssertionError: assert 13 &gt;= (20 * 0.95)
E        +  where 13 = len([{'endpoint': '/', 'request_id': 5, 'request_time': 0.034700632095336914, 'status_code': 200, ...}, {'endpoint': '/', ...ode': 200, ...}, {'endpoint': '/', 'request_id': 8, 'request_time': 0.04347348213195801, 'status_code': 200, ...}, ...])

tests/test_end_to_end_workflows.py:573: AssertionError</failure></testcase><testcase classname="tests.test_end_to_end_workflows.TestConcurrentUserScenarios" name="test_session_state_consistency_under_load" time="0.033"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 607, in test_session_state_consistency_under_load
    |     response = client.post("/api/v1/characters/", json=char_data, headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 607, in test_session_state_consistency_under_load
    response = client.post("/api/v1/characters/", json=char_data, headers=headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_end_to_end_workflows.TestConcurrentUserScenarios object at 0x7f0aba8b57d0&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab9cc3190&gt;

    def test_session_state_consistency_under_load(self, client):
        """Test that session state remains consistent under concurrent access."""
        player_id = "consistency-test-user"
        token = create_auth_token(player_id)
        headers = {"Authorization": f"Bearer {token}"}

        # Create player and character
        profile_data = {
            "username": "consistencyuser",
            "email": "consistency@example.com",
            "therapeutic_preferences": {
                "intensity_level": "medium",
                "preferred_approaches": ["cbt"],
                "trigger_warnings": [],
                "comfort_topics": ["personal_growth"],
                "avoid_topics": []
            }
        }
        client.post("/api/v1/players/", json=profile_data, headers=headers)

        char_data = create_test_character_data("Consistency Character")
&gt;       response = client.post("/api/v1/characters/", json=char_data, headers=headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_end_to_end_workflows.py:607:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.11/site-packages/httpx/_client.py:1157: in post
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='consistency-test-user', username='testuser', email='test@example.com', exp=datetime.datetime(2025, 8, 17, 7, 41, 50, tzinfo=datetime.timezone.utc))
item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_end_to_end_workflows.TestErrorHandlingAndRecovery" name="test_network_interruption_recovery" time="0.032"><failure message="starlette.websockets.WebSocketDisconnect">self = &lt;tests.test_end_to_end_workflows.TestErrorHandlingAndRecovery object at 0x7f0aba8b69d0&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab8b349d0&gt;

    def test_network_interruption_recovery(self, client):
        """Test recovery from network interruptions during WebSocket sessions."""
        player_id = "network-test-user"
        token = create_auth_token(player_id)

        # Simulate network interruption by closing and reopening connection
        with client.websocket_connect(f"/ws/chat?token={token}") as websocket:
            websocket.receive_text()  # Welcome message

            # Send initial message
            user_message = {
                "type": "user_message",
                "content": {"text": "Testing network recovery"},
                "metadata": {"character_id": "char-1", "world_id": "world-1"}
            }
            websocket.send_text(json.dumps(user_message))
&gt;           websocket.receive_text()  # Response
            ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_end_to_end_workflows.py:697:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:187: in receive_text
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = &lt;starlette.testclient.WebSocketTestSession object at 0x7f0ab9ccdbd0&gt;
message = {'code': 1011, 'reason': '', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -&gt; None:
        if message["type"] == "websocket.close":
&gt;           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

.venv/lib/python3.11/site-packages/starlette/testclient.py:150: WebSocketDisconnect</failure></testcase><testcase classname="tests.test_end_to_end_workflows.TestErrorHandlingAndRecovery" name="test_invalid_data_handling" time="0.030"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 739, in test_invalid_data_handling
    |     response = client.post("/api/v1/characters/", json=invalid_char_data, headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 739, in test_invalid_data_handling
    response = client.post("/api/v1/characters/", json=invalid_char_data, headers=headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_end_to_end_workflows.TestErrorHandlingAndRecovery object at 0x7f0aba8b64d0&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab891dc10&gt;

    def test_invalid_data_handling(self, client):
        """Test handling of invalid data in end-to-end workflows."""
        player_id = "invalid-data-user"
        token = create_auth_token(player_id)
        headers = {"Authorization": f"Bearer {token}"}

        # Test invalid character creation data
        invalid_char_data = {
            "name": "",  # Invalid: empty name
            "appearance": {"physical_description": ""},
            "background": {
                "name": "Different Name",  # Invalid: doesn't match character name
                "age": -5,  # Invalid: negative age
                "personality_traits": []
            },
            "therapeutic_profile": {
                "readiness_level": 2.0,  # Invalid: out of range
                "preferred_intensity": "invalid_intensity",
                "therapeutic_approaches": ["invalid_approach"]
            }
        }

&gt;       response = client.post("/api/v1/characters/", json=invalid_char_data, headers=headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_end_to_end_workflows.py:739:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.11/site-packages/httpx/_client.py:1157: in post
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='invalid-data-user', username='testuser', email='test@example.com', exp=datetime.datetime(2025, 8, 17, 7, 41, 50, tzinfo=datetime.timezone.utc))
item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_end_to_end_workflows.TestErrorHandlingAndRecovery" name="test_authentication_failure_recovery" time="0.042"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 763, in test_authentication_failure_recovery
    |     response = client.get("/api/v1/worlds/", headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_end_to_end_workflows.py", line 763, in test_authentication_failure_recovery
    response = client.get("/api/v1/worlds/", headers=headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_end_to_end_workflows.TestErrorHandlingAndRecovery object at 0x7f0aba8b7750&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab899bc50&gt;

    def test_authentication_failure_recovery(self, client):
        """Test recovery from authentication failures."""
        # Test with expired token
        expired_payload = {
            "sub": "expired-user",
            "username": "expireduser",
            "email": "expired@example.com",
            "exp": datetime.utcnow() - timedelta(hours=1)  # Expired
        }
        expired_token = jwt.encode(expired_payload, SECRET_KEY, algorithm=ALGORITHM)

        # Should fail with expired token
        headers = {"Authorization": f"Bearer {expired_token}"}
        response = client.get("/api/v1/worlds/", headers=headers)
        assert response.status_code == 401

        # Should succeed with valid token
        valid_token = create_auth_token("valid-user")
        headers = {"Authorization": f"Bearer {valid_token}"}
&gt;       response = client.get("/api/v1/worlds/", headers=headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_end_to_end_workflows.py:763:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='valid-user', username='testuser', email='test@example.com', exp=datetime.datetime(2025, 8, 17, 7, 41, 51, tzinfo=datetime.timezone.utc))
item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_enhanced_authentication.TestSecurityService" name="test_password_strength_validation" time="0.001" /><testcase classname="tests.test_enhanced_authentication.TestSecurityService" name="test_password_hashing" time="0.718" /><testcase classname="tests.test_enhanced_authentication.TestSecurityService" name="test_secure_token_generation" time="0.001" /><testcase classname="tests.test_enhanced_authentication.TestSecurityService" name="test_backup_codes_generation" time="0.001" /><testcase classname="tests.test_enhanced_authentication.TestMFAService" name="test_totp_secret_generation" time="0.019" /><testcase classname="tests.test_enhanced_authentication.TestMFAService" name="test_totp_code_verification" time="0.001" /><testcase classname="tests.test_enhanced_authentication.TestMFAService" name="test_mfa_challenge_creation" time="0.001" /><testcase classname="tests.test_enhanced_authentication.TestMFAService" name="test_mfa_challenge_cleanup" time="0.001" /><testcase classname="tests.test_enhanced_authentication.TestEnhancedAuthService" name="test_user_registration_validation" time="0.229" /><testcase classname="tests.test_enhanced_authentication.TestEnhancedAuthService" name="test_account_lockout" time="0.001" /><testcase classname="tests.test_enhanced_authentication.TestEnhancedAuthService" name="test_session_management" time="0.001" /><testcase classname="tests.test_enhanced_authentication.TestEnhancedAuthService" name="test_access_token_creation_and_verification" time="0.001" /><testcase classname="tests.test_enhanced_authentication.TestEnhancedAuthService" name="test_permission_checking" time="0.001" /><testcase classname="tests.test_enhanced_authentication.TestEnhancedAuthService" name="test_mfa_setup" time="0.014" /><testcase classname="tests.test_enhanced_authentication.TestEnhancedAuthService" name="test_session_cleanup" time="0.001" /><testcase classname="tests.test_enhanced_authentication.TestEnhancedAuthService" name="test_security_event_logging" time="0.001" /><testcase classname="tests.test_enhanced_authentication.TestAuthenticationAPI" name="test_register_endpoint" time="0.244" /><testcase classname="tests.test_enhanced_authentication.TestAuthenticationAPI" name="test_login_endpoint" time="0.088" /><testcase classname="tests.test_enhanced_authentication.TestAuthenticationAPI" name="test_mfa_setup_endpoint_requires_auth" time="0.012" /><testcase classname="tests.test_enhanced_authentication.TestAuthenticationAPI" name="test_permissions_endpoint_requires_auth" time="0.011" /><testcase classname="tests.test_enhanced_authentication.TestAuthenticationAPI" name="test_security_events_endpoint_requires_admin" time="0.014" /><testcase classname="tests.test_enhanced_authentication.TestRoleBasedAccessControl" name="test_default_role_permissions" time="0.001" /><testcase classname="tests.test_enhanced_authentication.TestRoleBasedAccessControl" name="test_authenticated_user_permission_methods" time="0.001" /><testcase classname="tests.test_enhanced_authentication.TestRoleBasedAccessControl" name="test_admin_user_permissions" time="0.001" /><testcase classname="tests.test_models_compatibility" name="test_narrative_coherence_models_importable" time="0.001" /><testcase classname="tests.test_models_compatibility" name="test_narrative_arc_models_importable" time="0.000" /><testcase classname="tests.test_narrative_arc_orchestrator_component.TestNarrativeArcOrchestratorComponent" name="test_component_configuration" time="0.001" /><testcase classname="tests.test_narrative_arc_orchestrator_component.TestNarrativeArcOrchestratorComponent" name="test_component_initialization" time="0.001" /><testcase classname="tests.test_narrative_arc_orchestrator_component.TestNarrativeArcOrchestratorComponent" name="test_component_start_stop" time="0.001" /><testcase classname="tests.test_narrative_arc_orchestrator_component.TestNarrativeArcOrchestratorComponent" name="test_emergent_event_creation" time="0.000" /><testcase classname="tests.test_narrative_arc_orchestrator_component.TestNarrativeArcOrchestratorComponent" name="test_narrative_response_creation" time="0.001" /><testcase classname="tests.test_narrative_arc_orchestrator_component.TestNarrativeArcOrchestratorComponent" name="test_narrative_status_creation" time="0.001" /><testcase classname="tests.test_narrative_arc_orchestrator_component.TestNarrativeArcOrchestratorComponent" name="test_player_choice_creation" time="0.001" /><testcase classname="tests.test_narrative_arc_orchestrator_component.TestNarrativeArcOrchestratorAsyncMethods" name="test_advance_narrative_scales" time="0.004" /><testcase classname="tests.test_narrative_arc_orchestrator_component.TestNarrativeArcOrchestratorAsyncMethods" name="test_emergent_event_nonexistent_session" time="0.003" /><testcase classname="tests.test_narrative_arc_orchestrator_component.TestNarrativeArcOrchestratorAsyncMethods" name="test_get_narrative_status" time="0.004" /><testcase classname="tests.test_narrative_arc_orchestrator_component.TestNarrativeArcOrchestratorAsyncMethods" name="test_get_status_nonexistent_session" time="0.003" /><testcase classname="tests.test_narrative_arc_orchestrator_component.TestNarrativeArcOrchestratorAsyncMethods" name="test_process_invalid_choice" time="0.003" /><testcase classname="tests.test_narrative_arc_orchestrator_component.TestNarrativeArcOrchestratorAsyncMethods" name="test_process_player_choice" time="0.003" /><testcase classname="tests.test_narrative_arc_orchestrator_component.TestNarrativeArcOrchestratorAsyncMethods" name="test_trigger_emergent_event" time="0.002" /><testcase classname="tests.test_narrative_coherence_engine" name="test_narrative_coherence_engine_imports" time="0.008" /><testcase classname="tests.test_narrative_coherence_engine" name="test_validation_severity_enum" time="0.000" /><testcase classname="tests.test_narrative_coherence_engine" name="test_narrative_content_creation" time="0.000" /><testcase classname="tests.test_narrative_coherence_engine" name="test_contradiction_creation" time="0.000" /><testcase classname="tests.test_narrative_coherence_engine" name="test_conflict_resolution_mechanisms" time="0.002" /><testcase classname="tests.test_narrative_coherence_engine" name="test_task_4_2_completion" time="0.001" /><testcase classname="tests.test_orchestrator.TestOrchestrator" name="test_component_dependencies" time="0.001" /><testcase classname="tests.test_orchestrator.TestOrchestrator" name="test_component_registration" time="0.001" /><testcase classname="tests.test_orchestrator.TestOrchestrator" name="test_config_initialization" time="0.001" /><testcase classname="tests.test_orchestrator.TestOrchestrator" name="test_orchestrator_initialization" time="0.001" /><testcase classname="tests.test_personalization_service_manager.TestCrisisDetectionSystem" name="test_crisis_detection_context_based" time="0.001" /><testcase classname="tests.test_personalization_service_manager.TestCrisisDetectionSystem" name="test_crisis_detection_no_crisis" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestCrisisDetectionSystem" name="test_crisis_detection_panic_attack" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestCrisisDetectionSystem" name="test_crisis_detection_self_harm" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestCrisisDetectionSystem" name="test_crisis_detection_suicidal_ideation" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestCrisisDetectionSystem" name="test_crisis_resources_initialization" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestCrisisDetectionSystem" name="test_get_crisis_resources_emergency_only" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestCrisisDetectionSystem" name="test_get_crisis_resources_suicidal" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestPlayerFeedback" name="test_feedback_auto_id_generation" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestPlayerFeedback" name="test_feedback_creation" time="0.001" /><testcase classname="tests.test_personalization_service_manager.TestAdaptationResult" name="test_adaptation_result_auto_id" time="0.001" /><testcase classname="tests.test_personalization_service_manager.TestAdaptationResult" name="test_adaptation_result_creation" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestAdaptationResult" name="test_adaptation_result_validation" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_adaptation_history_storage" time="0.001" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_detect_crisis_situation" time="0.001" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_detect_crisis_situation_no_crisis" time="0.001" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_feedback_history_storage" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_get_adaptive_recommendations_no_history" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_get_adaptive_recommendations_with_context" time="0.001" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_get_crisis_support_resources" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_get_crisis_support_resources_emergency_only" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_manager_initialization" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_process_crisis_feedback" time="0.001" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_process_preference_feedback" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_process_rating_feedback" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_process_text_feedback" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_recommendations_with_feedback_history" time="0.000" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_update_therapeutic_settings_critical_conflicts" time="0.001" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_update_therapeutic_settings_valid" time="0.001" /><testcase classname="tests.test_personalization_service_manager.TestPersonalizationServiceManager" name="test_update_therapeutic_settings_with_conflicts" time="0.001" /><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration" name="test_component_decorators_integration" time="0.001" /><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration" name="test_component_initialization" time="0.001" /><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration" name="test_component_registration_in_orchestrator" time="0.001" /><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration" name="test_component_start_integration" time="0.002"><failure message="AssertionError: Expected 'run' to have been called.">self = &lt;tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration testMethod=test_component_start_integration&gt;
mock_requests = &lt;MagicMock name='get' id='139684021648272'&gt;, mock_subprocess = &lt;MagicMock name='run' id='139684023852112'&gt;

    @patch('subprocess.run')
    @patch('requests.get')
    def test_component_start_integration(self, mock_requests, mock_subprocess):
        """Test that the component starts correctly through orchestration."""
        # Mock successful Docker Compose execution
        mock_subprocess.return_value = Mock(returncode=0, stdout="", stderr="")

        # Mock successful health check
        mock_health_response = Mock()
        mock_health_response.status_code = 200
        mock_health_response.json.return_value = {"status": "healthy"}
        mock_requests.return_value = mock_health_response

        # Test starting the component
        result = self.player_experience.start()
        self.assertTrue(result)
        self.assertEqual(self.player_experience.status, ComponentStatus.RUNNING)

        # Verify Docker Compose was called
&gt;       mock_subprocess.assert_called()

tests/test_player_experience_component_integration.py:98:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = &lt;MagicMock name='run' id='139684023852112'&gt;

    def assert_called(self):
        """assert that the mock was called at least once
        """
        if self.call_count == 0:
            msg = ("Expected '%s' to have been called." %
                   (self._mock_name or 'mock'))
&gt;           raise AssertionError(msg)
E           AssertionError: Expected 'run' to have been called.

../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/mock.py:908: AssertionError</failure></testcase><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration" name="test_component_stop_integration" time="0.002"><failure message="AssertionError: False is not true">self = &lt;tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration testMethod=test_component_stop_integration&gt;
mock_requests = &lt;MagicMock name='get' id='139684021123344'&gt;, mock_subprocess = &lt;MagicMock name='run' id='139684021119440'&gt;

    @patch('subprocess.run')
    @patch('requests.get')
    def test_component_stop_integration(self, mock_requests, mock_subprocess):
        """Test that the component stops correctly through orchestration."""
        # First start the component (mocked)
        mock_subprocess.return_value = Mock(returncode=0, stdout="", stderr="")
        mock_health_response = Mock()
        mock_health_response.status_code = 200
        mock_requests.return_value = mock_health_response

        self.player_experience.start()

        # Mock stopping
        mock_requests.side_effect = [
            mock_health_response,  # Initial health check (running)
            Exception("Connection refused")  # After stop (not running)
        ]

        # Test stopping the component
        result = self.player_experience.stop()
&gt;       self.assertTrue(result)
E       AssertionError: False is not true

tests/test_player_experience_component_integration.py:123: AssertionError</failure></testcase><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration" name="test_configuration_integration" time="0.001" /><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration" name="test_configuration_validation" time="0.001" /><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration" name="test_container_status_checking" time="0.001" /><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration" name="test_dependency_health_checking" time="0.004" /><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration" name="test_docker_compose_integration" time="0.001" /><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration" name="test_error_handling_integration" time="0.023"><failure message="AssertionError: &lt;ComponentStatus.ERROR: 'error'&gt; != &lt;ComponentStatus.STOPPED: 'stopped'&gt;">self = &lt;tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration testMethod=test_error_handling_integration&gt;

    def test_error_handling_integration(self):
        """Test error handling in component integration."""
        # Test with invalid Docker Compose path
        invalid_component = PlayerExperienceComponent(self.config)
        invalid_component.player_experience_dir = Path("/nonexistent/path")

        # Starting should fail gracefully
        result = invalid_component.start()
        self.assertFalse(result)
&gt;       self.assertEqual(invalid_component.status, ComponentStatus.STOPPED)
E       AssertionError: &lt;ComponentStatus.ERROR: 'error'&gt; != &lt;ComponentStatus.STOPPED: 'stopped'&gt;

tests/test_player_experience_component_integration.py:256: AssertionError</failure></testcase><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration" name="test_health_status_integration" time="0.072" /><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration" name="test_monitoring_metrics_integration" time="0.098" /><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration" name="test_orchestrator_component_lifecycle" time="0.001"><failure message="AttributeError: 'TTAOrchestrator' object has no attribute 'has_component'">self = &lt;tests.test_player_experience_component_integration.TestPlayerExperienceComponentIntegration testMethod=test_orchestrator_component_lifecycle&gt;

    def test_orchestrator_component_lifecycle(self):
        """Test component lifecycle through orchestrator."""
        # Test that orchestrator can find the component
&gt;       self.assertTrue(self.orchestrator.has_component("player_experience"))
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'TTAOrchestrator' object has no attribute 'has_component'

tests/test_player_experience_component_integration.py:203: AttributeError</failure></testcase><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceOrchestrationWorkflow" name="test_component_status_reporting" time="0.005" /><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceOrchestrationWorkflow" name="test_full_system_startup_workflow" time="0.001" /><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceOrchestrationWorkflow" name="test_orchestrator_start_component_integration" time="0.002"><failure message="AssertionError: False is not true">self = &lt;tests.test_player_experience_component_integration.TestPlayerExperienceOrchestrationWorkflow testMethod=test_orchestrator_start_component_integration&gt;
mock_start = &lt;MagicMock name='start' id='139684024748816'&gt;

    @patch('src.components.player_experience_component.PlayerExperienceComponent.start')
    def test_orchestrator_start_component_integration(self, mock_start):
        """Test starting player experience through orchestrator."""
        mock_start.return_value = True

        # Test starting through orchestrator
        result = self.orchestrator.start_component("player_experience")
&gt;       self.assertTrue(result)
E       AssertionError: False is not true

tests/test_player_experience_component_integration.py:297: AssertionError</failure></testcase><testcase classname="tests.test_player_experience_component_integration.TestPlayerExperienceOrchestrationWorkflow" name="test_orchestrator_stop_component_integration" time="0.002" /><testcase classname="tests.test_player_experience_manager.TestPlayerExperienceManager" name="test_crisis_detection_integration" time="0.001" /><testcase classname="tests.test_player_experience_manager.TestPlayerExperienceManager" name="test_dashboard_aggregation" time="0.001" /><testcase classname="tests.test_player_experience_manager.TestPlayerExperienceManager" name="test_feedback_processing" time="0.001" /><testcase classname="tests.test_player_experience_manager.TestPlayerExperienceManager" name="test_recommendations_combined" time="0.001" /><testcase classname="tests.test_player_experience_models.TestPlayerModels" name="test_player_character_management" time="0.001" /><testcase classname="tests.test_player_experience_models.TestPlayerModels" name="test_player_profile_creation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestPlayerModels" name="test_player_profile_validation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestPlayerModels" name="test_privacy_settings_creation" time="0.001" /><testcase classname="tests.test_player_experience_models.TestPlayerModels" name="test_privacy_settings_validation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestPlayerModels" name="test_therapeutic_preferences_creation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestPlayerModels" name="test_therapeutic_preferences_validation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestCharacterModels" name="test_character_appearance_creation" time="0.001" /><testcase classname="tests.test_player_experience_models.TestCharacterModels" name="test_character_appearance_validation" time="0.001" /><testcase classname="tests.test_player_experience_models.TestCharacterModels" name="test_character_background_creation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestCharacterModels" name="test_character_background_validation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestCharacterModels" name="test_character_creation" time="0.001" /><testcase classname="tests.test_player_experience_models.TestCharacterModels" name="test_therapeutic_goal_creation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestCharacterModels" name="test_therapeutic_goal_validation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestCharacterModels" name="test_therapeutic_profile_creation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestWorldModels" name="test_compatibility_report_creation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestWorldModels" name="test_world_parameters_creation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestWorldModels" name="test_world_parameters_validation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestWorldModels" name="test_world_summary_creation" time="0.001" /><testcase classname="tests.test_player_experience_models.TestSessionModels" name="test_progress_marker_creation" time="0.001" /><testcase classname="tests.test_player_experience_models.TestSessionModels" name="test_session_context_creation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestSessionModels" name="test_therapeutic_settings_creation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestProgressModels" name="test_engagement_metrics_creation" time="0.000" /><testcase classname="tests.test_player_experience_models.TestProgressModels" name="test_milestone_creation" time="0.001" /><testcase classname="tests.test_player_experience_models.TestProgressModels" name="test_progress_summary_creation" time="0.001" /><testcase classname="tests.test_player_experience_models.TestSerialization" name="test_character_serialization" time="0.001" /><testcase classname="tests.test_player_experience_models.TestSerialization" name="test_player_profile_serialization" time="0.001" /><testcase classname="tests.test_player_experience_models.TestValidation" name="test_validate_model_failure" time="0.001" /><testcase classname="tests.test_player_experience_models.TestValidation" name="test_validate_model_success" time="0.001" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceOrchestrationIntegration" name="test_component_initialization" time="0.002" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceOrchestrationIntegration" name="test_component_configuration_access" time="0.002" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceOrchestrationIntegration" name="test_component_start_success" time="0.007" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceOrchestrationIntegration" name="test_component_start_failure" time="0.003" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceOrchestrationIntegration" name="test_component_stop_success" time="0.002" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceOrchestrationIntegration" name="test_health_status_monitoring" time="0.050" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceOrchestrationIntegration" name="test_monitoring_metrics" time="0.051" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceOrchestrationIntegration" name="test_orchestrator_integration" time="0.002"><failure message="TypeError: TestPlayerExperienceOrchestrationIntegration.test_orchestrator_integration.&lt;locals&gt;.mock_import_core_side_effect() missing 1 required positional argument: 'orchestrator_self'">self = &lt;tests.test_player_experience_orchestration_integration.TestPlayerExperienceOrchestrationIntegration object at 0x7f0aba7a3750&gt;
mock_validate = &lt;MagicMock name='_validate_repositories' id='139683792966608'&gt;
mock_import_repo = &lt;MagicMock name='_import_repository_components' id='139684021596368'&gt;
mock_import_core = &lt;MagicMock name='_import_core_components' id='139684023233552'&gt;
mock_config = &lt;MagicMock name='TTAConfig()' spec='function' id='139683792973392'&gt;

    @patch('src.orchestration.orchestrator.TTAOrchestrator._import_core_components')
    @patch('src.orchestration.orchestrator.TTAOrchestrator._import_repository_components')
    @patch('src.orchestration.orchestrator.TTAOrchestrator._validate_repositories')
    def test_orchestrator_integration(self, mock_validate, mock_import_repo, mock_import_core, mock_config):
        """Test that the orchestrator properly integrates the player experience component."""
        # Mock the import methods to avoid actual file system operations
        mock_validate.return_value = None
        mock_import_repo.return_value = None

        # Create a mock component for the orchestrator to find
        mock_component = Mock(spec=PlayerExperienceComponent)
        mock_component.name = "player_experience"
        mock_component.dependencies = ["redis", "neo4j"]
        mock_component.status = ComponentStatus.STOPPED

        def mock_import_core_side_effect(orchestrator_self):
            orchestrator_self.components["player_experience"] = mock_component

        mock_import_core.side_effect = mock_import_core_side_effect

        # Create orchestrator with mock config
        with patch('src.orchestration.orchestrator.TTAConfig') as mock_config_class:
            mock_config_class.return_value = mock_config
&gt;           orchestrator = TTAOrchestrator()
                           ^^^^^^^^^^^^^^^^^

tests/test_player_experience_orchestration_integration.py:201:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src/orchestration/orchestrator.py:89: in __init__
    self._import_components()
src/orchestration/decorators.py:36: in wrapper
    result = func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^
src/orchestration/decorators.py:59: in wrapper
    result = func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^
src/orchestration/orchestrator.py:126: in _import_components
    self._import_core_components()
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/mock.py:1124: in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/mock.py:1128: in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = &lt;MagicMock name='_import_core_components' id='139684023233552'&gt;, args = (), kwargs = {}
effect = &lt;function TestPlayerExperienceOrchestrationIntegration.test_orchestrator_integration.&lt;locals&gt;.mock_import_core_side_effect at 0x7f0ab883bb00&gt;

    def _execute_mock_call(self, /, *args, **kwargs):
        # separate from _increment_mock_call so that awaited functions are
        # executed separately from their call, also AsyncMock overrides this method

        effect = self.side_effect
        if effect is not None:
            if _is_exception(effect):
                raise effect
            elif not _callable(effect):
                result = next(effect)
                if _is_exception(result):
                    raise result
            else:
&gt;               result = effect(*args, **kwargs)
                         ^^^^^^^^^^^^^^^^^^^^^^^
E               TypeError: TestPlayerExperienceOrchestrationIntegration.test_orchestrator_integration.&lt;locals&gt;.mock_import_core_side_effect() missing 1 required positional argument: 'orchestrator_self'

../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/unittest/mock.py:1189: TypeError</failure></testcase><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceOrchestrationIntegration" name="test_component_dependencies" time="0.001" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceOrchestrationIntegration" name="test_docker_compose_command_execution" time="0.001" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceOrchestrationIntegration" name="test_container_status_checking" time="0.002" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceDeploymentValidation" name="test_deployment_health_check" time="0.002" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceDeploymentValidation" name="test_deployment_health_check_failure" time="0.021" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceDeploymentValidation" name="test_configuration_validation" time="0.002" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceDeploymentValidation" name="test_dependency_health_checking" time="0.003" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceDeploymentValidation" name="test_dependency_health_checking_failure" time="0.002" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceEndToEndIntegration" name="test_full_orchestration_lifecycle" time="0.002" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceEndToEndIntegration" name="test_orchestrated_component_startup" time="0.008" /><testcase classname="tests.test_player_experience_orchestration_integration.TestPlayerExperienceEndToEndIntegration" name="test_configuration_integration" time="0.002" /><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_create_player_success" time="0.040" /><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_create_player_validation_error" time="0.035" /><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_create_player_username_exists" time="0.136" /><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_get_player_success" time="0.030"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 168, in test_get_player_success
    |     response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 168, in test_get_player_success
    response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7baa90&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab89f44d0&gt;, mock_player_manager = &lt;MagicMock id='139684023856144'&gt;
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_get_player_success(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test successful player profile retrieval."""
        mock_player_manager.get_player_profile.return_value = sample_player_profile

        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
&gt;           response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:168:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_get_player_not_found" time="0.040"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 187, in test_get_player_not_found
    |     response = client.get("/api/v1/players/nonexistent-player", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 187, in test_get_player_not_found
    response = client.get("/api/v1/players/nonexistent-player", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7badd0&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab86db690&gt;, mock_player_manager = &lt;MagicMock id='139684020593680'&gt;
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_get_player_not_found(self, client, mock_player_manager, auth_headers):
        """Test player retrieval when player doesn't exist."""
        mock_player_manager.get_player_profile.return_value = None

        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
&gt;           response = client.get("/api/v1/players/nonexistent-player", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:187:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_get_player_unauthorized" time="0.034" /><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_get_player_access_denied" time="0.045"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 206, in test_get_player_access_denied
    |     response = client.get("/api/v1/players/other-player-id", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 206, in test_get_player_access_denied
    response = client.get("/api/v1/players/other-player-id", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7bb7d0&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab8b52590&gt;, mock_player_manager = &lt;MagicMock id='139684025274128'&gt;
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_get_player_access_denied(self, client, mock_player_manager, auth_headers):
        """Test player retrieval with access denied."""
        mock_player_manager.get_player_profile.side_effect = DataAccessRestrictedError("Access denied")

        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
&gt;           response = client.get("/api/v1/players/other-player-id", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:206:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_update_player_success" time="0.031"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 227, in test_update_player_success
    |     response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 583, in put
    |     return super().put(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1194, in put
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 227, in test_update_player_success
    response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 583, in put
    return super().put(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1194, in put
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7bbdd0&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab8a17050&gt;, mock_player_manager = &lt;MagicMock id='139684013882128'&gt;
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_update_player_success(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test successful player profile update."""
        mock_player_manager.update_player_profile.return_value = True
        mock_player_manager.get_player_profile.return_value = sample_player_profile

        request_data = {
            "username": "updateduser",
            "therapeutic_preferences": {
                "intensity_level": "high",
                "preferred_approaches": ["mindfulness"],
                "session_duration_preference": 60
            }
        }

        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
&gt;           response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:227:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:583: in put
    return super().put(
.venv/lib/python3.11/site-packages/httpx/_client.py:1194: in put
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_update_player_validation_error" time="0.129"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 249, in test_update_player_validation_error
    |     response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 583, in put
    |     return super().put(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1194, in put
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 249, in test_update_player_validation_error
    response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 583, in put
    return super().put(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1194, in put
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7c4410&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab9ce00d0&gt;, mock_player_manager = &lt;MagicMock id='139684024444560'&gt;
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_update_player_validation_error(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test player update with validation errors."""
        request_data = {
            "username": "ab",  # Too short
            "email": "invalid-email"  # Invalid format
        }

        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
&gt;           response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:249:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:583: in put
    return super().put(
.venv/lib/python3.11/site-packages/httpx/_client.py:1194: in put
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_update_player_username_conflict" time="0.042"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 265, in test_update_player_username_conflict
    |     response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 583, in put
    |     return super().put(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1194, in put
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 265, in test_update_player_username_conflict
    response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 583, in put
    return super().put(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1194, in put
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7c49d0&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab8998310&gt;, mock_player_manager = &lt;MagicMock id='139684023473040'&gt;
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_update_player_username_conflict(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test player update with username conflict."""
        mock_player_manager.update_player_profile.side_effect = PlayerProfileManagerError("Username 'existinguser' already exists")

        request_data = {
            "username": "existinguser"
        }

        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
&gt;           response = client.put(f"/api/v1/players/{sample_player_profile.player_id}", json=request_data, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:265:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:583: in put
    return super().put(
.venv/lib/python3.11/site-packages/httpx/_client.py:1194: in put
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_delete_player_success" time="0.032"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 276, in test_delete_player_success
    |     response = client.delete(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 641, in delete
    |     return super().delete(
    |            ^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1264, in delete
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 276, in test_delete_player_success
    response = client.delete(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 641, in delete
    return super().delete(
           ^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1264, in delete
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7c4fd0&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab895ef10&gt;, mock_player_manager = &lt;MagicMock id='139684021079696'&gt;
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_delete_player_success(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test successful player profile deletion."""
        mock_player_manager.delete_player_profile.return_value = True

        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
&gt;           response = client.delete(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:276:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:641: in delete
    return super().delete(
.venv/lib/python3.11/site-packages/httpx/_client.py:1264: in delete
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_delete_player_not_found" time="0.030"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 291, in test_delete_player_not_found
    |     response = client.delete(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 641, in delete
    |     return super().delete(
    |            ^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1264, in delete
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 291, in test_delete_player_not_found
    response = client.delete(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 641, in delete
    return super().delete(
           ^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1264, in delete
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7c5690&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab809f5d0&gt;, mock_player_manager = &lt;MagicMock id='139684013442064'&gt;
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_delete_player_not_found(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test player deletion when player doesn't exist."""
        mock_player_manager.delete_player_profile.return_value = False

        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
&gt;           response = client.delete(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:291:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:641: in delete
    return super().delete(
.venv/lib/python3.11/site-packages/httpx/_client.py:1264: in delete
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_export_player_data_success" time="0.031"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 314, in test_export_player_data_success
    |     response = client.get(f"/api/v1/players/{sample_player_profile.player_id}/export", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 314, in test_export_player_data_success
    response = client.get(f"/api/v1/players/{sample_player_profile.player_id}/export", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7c5d50&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab8854ed0&gt;, mock_player_manager = &lt;MagicMock id='139684022155472'&gt;
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_export_player_data_success(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test successful player data export."""
        export_data = {
            "player_profile": {
                "player_id": sample_player_profile.player_id,
                "username": sample_player_profile.username,
                "email": sample_player_profile.email,
            },
            "export_metadata": {
                "export_date": datetime.now().isoformat(),
                "export_requested_by": sample_player_profile.player_id,
                "data_format_version": "1.0",
            }
        }
        mock_player_manager.export_player_data.return_value = export_data

        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
&gt;           response = client.get(f"/api/v1/players/{sample_player_profile.player_id}/export", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:314:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_update_therapeutic_preferences_success" time="0.028"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 342, in test_update_therapeutic_preferences_success
    |     response = client.patch(
    |                ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    |     return super().patch(
    |            ^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 342, in test_update_therapeutic_preferences_success
    response = client.patch(
               ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    return super().patch(
           ^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7c6410&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab9c7bb10&gt;, mock_player_manager = &lt;MagicMock id='139684043272848'&gt;
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_update_therapeutic_preferences_success(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test successful therapeutic preferences update."""
        mock_player_manager.update_therapeutic_preferences.return_value = True
        mock_player_manager.get_player_profile.return_value = sample_player_profile

        request_data = {
            "intensity_level": "high",
            "preferred_approaches": ["mindfulness", "acceptance_commitment_therapy"],
            "trigger_warnings": ["violence"],
            "session_duration_preference": 60,
            "reminder_frequency": "daily"
        }

        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
&gt;           response = client.patch(
                f"/api/v1/players/{sample_player_profile.player_id}/therapeutic-preferences",
                json=request_data,
                headers=auth_headers
            )

tests/test_player_management_api.py:342:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:614: in patch
    return super().patch(
.venv/lib/python3.11/site-packages/httpx/_client.py:1231: in patch
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_update_privacy_settings_success" time="0.033"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 368, in test_update_privacy_settings_success
    |     response = client.patch(
    |                ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    |     return super().patch(
    |            ^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 368, in test_update_privacy_settings_success
    response = client.patch(
               ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    return super().patch(
           ^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7c6ad0&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab88a0910&gt;, mock_player_manager = &lt;MagicMock id='139684022460816'&gt;
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_update_privacy_settings_success(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test successful privacy settings update."""
        mock_player_manager.update_privacy_settings.return_value = True
        mock_player_manager.get_player_profile.return_value = sample_player_profile

        request_data = {
            "data_collection_consent": False,
            "research_participation_consent": True,
            "progress_sharing_enabled": False,
            "data_retention_period_days": 180
        }

        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
&gt;           response = client.patch(
                f"/api/v1/players/{sample_player_profile.player_id}/privacy-settings",
                json=request_data,
                headers=auth_headers
            )

tests/test_player_management_api.py:368:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:614: in patch
    return super().patch(
.venv/lib/python3.11/site-packages/httpx/_client.py:1231: in patch
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_privacy_settings_validation_error" time="0.030"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 388, in test_privacy_settings_validation_error
    |     response = client.patch(
    |                ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    |     return super().patch(
    |            ^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 388, in test_privacy_settings_validation_error
    response = client.patch(
               ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    return super().patch(
           ^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7c7190&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab88d4210&gt;, mock_player_manager = &lt;MagicMock id='139684022672208'&gt;
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_privacy_settings_validation_error(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test privacy settings update with validation error."""
        request_data = {
            "data_retention_period_days": 10  # Too short, minimum is 30
        }

        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
&gt;           response = client.patch(
                f"/api/v1/players/{sample_player_profile.player_id}/privacy-settings",
                json=request_data,
                headers=auth_headers
            )

tests/test_player_management_api.py:388:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:614: in patch
    return super().patch(
.venv/lib/python3.11/site-packages/httpx/_client.py:1231: in patch
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_therapeutic_preferences_validation_error" time="0.029"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 407, in test_therapeutic_preferences_validation_error
    |     response = client.patch(
    |                ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    |     return super().patch(
    |            ^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 407, in test_therapeutic_preferences_validation_error
    response = client.patch(
               ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 614, in patch
    return super().patch(
           ^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1231, in patch
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7c7850&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab8b61e10&gt;, mock_player_manager = &lt;MagicMock id='139684025349264'&gt;
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_therapeutic_preferences_validation_error(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test therapeutic preferences update with validation error."""
        request_data = {
            "session_duration_preference": 200,  # Too long, maximum is 120
            "preferred_approaches": ["invalid_approach"]  # Invalid approach
        }

        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
&gt;           response = client.patch(
                f"/api/v1/players/{sample_player_profile.player_id}/therapeutic-preferences",
                json=request_data,
                headers=auth_headers
            )

tests/test_player_management_api.py:407:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:614: in patch
    return super().patch(
.venv/lib/python3.11/site-packages/httpx/_client.py:1231: in patch
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_cross_player_access_denied" time="0.037"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 423, in test_cross_player_access_denied
    |     response = client.get(f"/api/v1/players/{other_player_id}", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 423, in test_cross_player_access_denied
    response = client.get(f"/api/v1/players/{other_player_id}", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7c7f50&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab8ae4550&gt;, mock_player_manager = &lt;MagicMock id='139684024837008'&gt;
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_cross_player_access_denied(self, client, mock_player_manager, auth_headers):
        """Test that players cannot access other players' profiles."""
        # Try to access a different player's profile
        other_player_id = "other-player-456"

&gt;       response = client.get(f"/api/v1/players/{other_player_id}", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:423:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_invalid_token_authentication" time="0.037" /><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_missing_authorization_header" time="0.036" /><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_malformed_authorization_header" time="0.030" /><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_api_documentation_generation" time="0.087" /><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_cors_headers" time="0.035"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 483, in test_cors_headers
    |     response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 483, in test_cors_headers
    response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7c8790&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab8b03fd0&gt;, mock_player_manager = &lt;MagicMock id='139684024993296'&gt;
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_cors_headers(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test that CORS headers are properly set."""
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
            mock_player_manager.get_player_profile.return_value = sample_player_profile

&gt;           response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:483:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_security_headers" time="0.028"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 494, in test_security_headers
    |     response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 494, in test_security_headers
    response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7c8b10&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab878b410&gt;, mock_player_manager = &lt;MagicMock id='139684021316368'&gt;
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_security_headers(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test that security headers are properly set."""
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
            mock_player_manager.get_player_profile.return_value = sample_player_profile

&gt;           response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:494:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_management_api.TestPlayerManagementAPI" name="test_rate_limiting_headers" time="0.031"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 508, in test_rate_limiting_headers
    |     response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_player_management_api.py", line 508, in test_rate_limiting_headers
    response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

self = &lt;tests.test_player_management_api.TestPlayerManagementAPI object at 0x7f0aba7c8e50&gt;
client = &lt;starlette.testclient.TestClient object at 0x7f0ab8762850&gt;, mock_player_manager = &lt;MagicMock id='139684021145616'&gt;
sample_player_profile = PlayerProfile(player_id='test-player-123', username='testuser', email='test@example.com', created_at=datetime.datetime...ost_effective_world_type=None, last_session_date=None, next_recommended_session=None), last_login=None, is_active=True)
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXBsYXllci0xMjMiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIn0.WHz_VK_0gp1D8G4VEJF4UtNfxQQjrN8L08BzotoxPp4'}

    def test_rate_limiting_headers(self, client, mock_player_manager, sample_player_profile, auth_headers):
        """Test that rate limiting headers are properly set."""
        with patch('src.player_experience.api.routers.players.get_player_manager', return_value=mock_player_manager):
            mock_player_manager.get_player_profile.return_value = sample_player_profile

&gt;           response = client.get(f"/api/v1/players/{sample_player_profile.player_id}", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_player_management_api.py:508:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='test-player-123', username='testuser', email='test@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_connect_failure" time="0.002" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_connect_success" time="0.003" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_context_manager" time="0.002" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_create_player_profile_constraints_already_exists" time="0.002" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_create_player_profile_constraints_failure" time="0.003" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_create_player_profile_constraints_success" time="0.002" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_create_player_profile_indexes_success" time="0.003" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_disconnect" time="0.004" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_get_player_schema_version_not_found" time="0.003" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_get_player_schema_version_success" time="0.003" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_is_connected_false_exception" time="0.002" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_is_connected_false_no_driver" time="0.003" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_is_connected_true" time="0.003" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_schema_manager_initialization" time="0.002" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_setup_player_profile_schema_constraint_failure" time="0.005" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_setup_player_profile_schema_success" time="0.005" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_validate_player_profile_schema_missing_constraints" time="0.004" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileSchemaManager" name="test_validate_player_profile_schema_success" time="0.003" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_connect_success" time="0.005" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_context_manager" time="0.003" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_create_player_profile_already_exists" time="0.002" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_create_player_profile_failure" time="0.002" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_create_player_profile_success" time="0.004" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_delete_player_profile_not_found" time="0.097" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_delete_player_profile_success" time="0.003" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_email_exists_false" time="0.005" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_email_exists_true" time="0.003" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_get_player_profile_not_found" time="0.003" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_get_player_profile_success" time="0.003" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_list_active_players" time="0.007" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_repository_initialization" time="0.002" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_serialize_privacy_settings" time="0.002" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_serialize_progress_summary" time="0.002" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_serialize_therapeutic_preferences" time="0.002" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_update_player_profile_not_found" time="0.003" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_update_player_profile_success" time="0.003" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_username_exists_false" time="0.002" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileRepository" name="test_username_exists_true" time="0.002" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileValidation" name="test_player_profile_character_limit" time="0.001" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileValidation" name="test_player_profile_character_management" time="0.000" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileValidation" name="test_player_profile_validation_empty_id" time="0.001" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileValidation" name="test_player_profile_validation_invalid_email" time="0.001" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileValidation" name="test_player_profile_validation_short_username" time="0.001" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileValidation" name="test_privacy_settings_validation" time="0.001" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileValidation" name="test_therapeutic_preferences_validation" time="0.000" /><testcase classname="tests.test_player_profile_database.TestPlayerProfileValidation" name="test_valid_player_profile_creation" time="0.001" /><testcase classname="tests.test_player_profile_database.TestUtilityFunctions" name="test_create_player_profile_repository" time="0.002" /><testcase classname="tests.test_player_profile_database.TestUtilityFunctions" name="test_setup_player_profile_schema_failure" time="0.001" /><testcase classname="tests.test_player_profile_database.TestUtilityFunctions" name="test_setup_player_profile_schema_success" time="0.002" /><testcase classname="tests.test_player_profile_database_param" name="test_schema_manager_setup_parametrized[mock]" time="0.002"><skipped type="pytest.skip" message="Neo4j container not requested; use --neo4j or RUN_NEO4J_TESTS=1">/home/thein/projects/projects/TTA/tests/test_player_profile_database_param.py:10: Neo4j container not requested; use --neo4j or RUN_NEO4J_TESTS=1</skipped></testcase><testcase classname="tests.test_player_profile_database_param" name="test_schema_manager_setup_parametrized[container]" time="0.000"><skipped type="pytest.skip" message="Neo4j container not requested; use --neo4j or RUN_NEO4J_TESTS=1">/home/thein/projects/projects/TTA/tests/test_player_profile_database_param.py:10: Neo4j container not requested; use --neo4j or RUN_NEO4J_TESTS=1</skipped></testcase><testcase classname="tests.test_player_profile_database_param" name="test_repository_crud_parametrized[mock]" time="0.000"><skipped type="pytest.skip" message="Neo4j container not requested; use --neo4j or RUN_NEO4J_TESTS=1">/home/thein/projects/projects/TTA/tests/test_player_profile_database_param.py:37: Neo4j container not requested; use --neo4j or RUN_NEO4J_TESTS=1</skipped></testcase><testcase classname="tests.test_player_profile_database_param" name="test_repository_crud_parametrized[container]" time="0.001"><skipped type="pytest.skip" message="Neo4j container not requested; use --neo4j or RUN_NEO4J_TESTS=1">/home/thein/projects/projects/TTA/tests/test_player_profile_database_param.py:37: Neo4j container not requested; use --neo4j or RUN_NEO4J_TESTS=1</skipped></testcase><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_create_player_profile_duplicate_email" time="0.002" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_create_player_profile_duplicate_username" time="0.002" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_create_player_profile_invalid_email" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_create_player_profile_invalid_privacy_settings" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_create_player_profile_invalid_username" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_create_player_profile_manager_utility" time="0.002" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_create_player_profile_success" time="0.002" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_delete_player_profile_not_found" time="0.002" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_delete_player_profile_success" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_delete_player_profile_unauthorized" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_export_player_data_success" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_export_player_data_unauthorized" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_get_access_log_success" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_get_access_log_unauthorized" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_get_player_by_email" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_get_player_by_username" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_get_player_profile_data_access_restricted" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_get_player_profile_not_found" time="0.002" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_get_player_profile_privacy_filtering" time="0.002" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_get_player_profile_success" time="0.002" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_repository_error_handling" time="0.002" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_update_player_profile_not_found" time="0.002" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_update_player_profile_restricted_fields" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_update_player_profile_success" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_update_player_profile_unauthorized" time="0.002" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_update_privacy_settings" time="0.002" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_update_privacy_settings_invalid" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManager" name="test_update_therapeutic_preferences" time="0.001" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManagerIntegration" name="test_full_profile_lifecycle" time="0.002" /><testcase classname="tests.test_player_profile_manager.TestPlayerProfileManagerIntegration" name="test_privacy_controls_enforcement" time="0.001" /><testcase classname="tests.test_privacy_api.TestPrivacyCompliance" name="test_consent_management_workflow" time="0.001" /><testcase classname="tests.test_privacy_api.TestPrivacyCompliance" name="test_data_anonymization_workflow" time="0.002" /><testcase classname="tests.test_privacy_api.TestPrivacyCompliance" name="test_data_deletion_workflow" time="0.002" /><testcase classname="tests.test_privacy_api.TestPrivacyCompliance" name="test_data_export_workflow" time="0.002" /><testcase classname="tests.test_privacy_api.TestPrivacyCompliance" name="test_data_processing_records_management" time="0.001" /><testcase classname="tests.test_privacy_api.TestPrivacyCompliance" name="test_data_retention_compliance_monitoring" time="0.001" /><testcase classname="tests.test_privacy_api.TestPrivacyCompliance" name="test_gdpr_rights_implementation" time="0.001" /><testcase classname="tests.test_privacy_api.TestPrivacyCompliance" name="test_privacy_by_design_principles" time="0.001" /><testcase classname="tests.test_privacy_api.TestPrivacyCompliance" name="test_privacy_settings_management" time="0.001" /><testcase classname="tests.test_privacy_api.TestPrivacyCompliance" name="test_therapeutic_data_protection_integration" time="0.001" /><testcase classname="tests.test_privacy_service.TestEncryptionService" name="test_decrypt_with_missing_key" time="0.001" /><testcase classname="tests.test_privacy_service.TestEncryptionService" name="test_encrypt_bytes_data" time="0.001" /><testcase classname="tests.test_privacy_service.TestEncryptionService" name="test_encrypt_decrypt_data" time="0.001" /><testcase classname="tests.test_privacy_service.TestEncryptionService" name="test_generate_data_key" time="0.001" /><testcase classname="tests.test_privacy_service.TestEncryptionService" name="test_key_rotation" time="0.001" /><testcase classname="tests.test_privacy_service.TestEncryptionService" name="test_key_rotation_nonexistent_key" time="0.001" /><testcase classname="tests.test_privacy_service.TestAnonymizationService" name="test_anonymize_therapeutic_content" time="0.001" /><testcase classname="tests.test_privacy_service.TestAnonymizationService" name="test_anonymize_user_id" time="0.001" /><testcase classname="tests.test_privacy_service.TestAnonymizationService" name="test_k_anonymize_dataset" time="0.001" /><testcase classname="tests.test_privacy_service.TestAnonymizationService" name="test_k_anonymize_empty_dataset" time="0.001" /><testcase classname="tests.test_privacy_service.TestAnonymizationService" name="test_pseudonymize_user_id" time="0.001" /><testcase classname="tests.test_privacy_service.TestDataPrivacyService" name="test_anonymize_user_data" time="0.001" /><testcase classname="tests.test_privacy_service.TestDataPrivacyService" name="test_check_data_retention_compliance" time="0.001" /><testcase classname="tests.test_privacy_service.TestDataPrivacyService" name="test_check_data_retention_compliance_no_issues" time="0.001" /><testcase classname="tests.test_privacy_service.TestDataPrivacyService" name="test_decrypt_nonexistent_content" time="0.001" /><testcase classname="tests.test_privacy_service.TestDataPrivacyService" name="test_decrypt_therapeutic_content" time="0.001" /><testcase classname="tests.test_privacy_service.TestDataPrivacyService" name="test_delete_user_data" time="0.001" /><testcase classname="tests.test_privacy_service.TestDataPrivacyService" name="test_encrypt_therapeutic_content" time="0.001" /><testcase classname="tests.test_privacy_service.TestDataPrivacyService" name="test_export_user_data" time="0.002" /><testcase classname="tests.test_privacy_service.TestDataPrivacyService" name="test_export_user_data_csv_format" time="0.001" /><testcase classname="tests.test_privacy_service.TestDataPrivacyService" name="test_record_consent" time="0.001" /><testcase classname="tests.test_privacy_service.TestDataPrivacyService" name="test_record_data_processing" time="0.001" /><testcase classname="tests.test_privacy_service.TestDataPrivacyService" name="test_update_privacy_settings" time="0.001" /><testcase classname="tests.test_privacy_service.TestDataPrivacyService" name="test_withdraw_consent" time="0.001" /><testcase classname="tests.test_privacy_service.TestDataPrivacyService" name="test_withdraw_nonexistent_consent" time="0.001" /><testcase classname="tests.test_privacy_service.TestPrivacyServiceIntegration" name="test_automated_decision_making_transparency" time="0.002" /><testcase classname="tests.test_privacy_service.TestPrivacyServiceIntegration" name="test_complete_gdpr_workflow" time="0.002" /><testcase classname="tests.test_privacy_service.TestPrivacyServiceIntegration" name="test_cross_border_data_transfer_compliance" time="0.001" /><testcase classname="tests.test_privacy_service.TestPrivacyServiceIntegration" name="test_privacy_by_design_principles" time="0.001" /><testcase classname="tests.test_process_utils" name="test_run_success_echo" time="0.002" /><testcase classname="tests.test_process_utils" name="test_run_timeout" time="0.503" /><testcase classname="tests.test_process_utils" name="test_run_nonzero_no_check" time="0.009" /><testcase classname="tests.test_process_utils" name="test_run_nonzero_with_check" time="0.007" /><testcase classname="tests.test_process_utils" name="test_no_shell_injection" time="0.000" /><testcase classname="tests.test_progress_tracking_service.TestProgressTrackingService" name="test_comprehensive_milestone_detection" time="0.001"><failure message="AssertionError: False is not true">self = &lt;tests.test_progress_tracking_service.TestProgressTrackingService testMethod=test_comprehensive_milestone_detection&gt;

    def test_comprehensive_milestone_detection(self):
        async def run():
            # Create session summaries for streak detection
            now = datetime.utcnow()
            streak_summaries = []
            for i in range(10):  # 10 consecutive days
                start = now - timedelta(days=i, hours=1)
                end = now - timedelta(days=i)
                streak_summaries.append(
                    SessionSummary(
                        session_id=f"streak_s{i}",
                        character_name="Char",
                        world_name="World",
                        start_time=start,
                        end_time=end,
                        duration_minutes=25,
                        status=SessionStatus.COMPLETED,
                        progress_markers_count=1,
                        therapeutic_interventions_count=2,
                    )
                )

            # Update mock repository with streak data
            self.repo._summaries = streak_summaries

            milestones, highlights = await self.service.detect_and_update_milestones(self.player_id)

            # Should detect multiple milestones for 7+ day streak
            milestone_titles = [m.title for m in milestones]
            self.assertTrue(any("7" in title for title in milestone_titles))

            # Should have celebration highlights
            self.assertGreater(len(highlights), 0)
            highlight_types = [h.highlight_type for h in highlights]
            self.assertIn("milestone", highlight_types)

&gt;       asyncio.run(run())

tests/test_progress_tracking_service.py:217:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/asyncio/runners.py:190: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
tests/test_progress_tracking_service.py:210: in run
    self.assertTrue(any("7" in title for title in milestone_titles))
E   AssertionError: False is not true</failure></testcase><testcase classname="tests.test_progress_tracking_service.TestProgressTrackingService" name="test_compute_progress_summary" time="0.001" /><testcase classname="tests.test_progress_tracking_service.TestProgressTrackingService" name="test_detect_and_update_milestones" time="0.002"><failure message="AssertionError: 0 not greater than 0">self = &lt;tests.test_progress_tracking_service.TestProgressTrackingService testMethod=test_detect_and_update_milestones&gt;

    def test_detect_and_update_milestones(self):
        async def run():
            milestones, highlights = await self.service.detect_and_update_milestones(self.player_id)
            # Skill milestone should trigger
            titles = [m.title for m in milestones]
            self.assertIn("Skill Builder Level 1", titles)
            self.assertGreater(len(highlights), 0)
&gt;       asyncio.run(run())

tests/test_progress_tracking_service.py:86:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/asyncio/runners.py:190: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
tests/test_progress_tracking_service.py:85: in run
    self.assertGreater(len(highlights), 0)
E   AssertionError: 0 not greater than 0</failure></testcase><testcase classname="tests.test_progress_tracking_service.TestProgressTrackingService" name="test_dropout_risk_calculation" time="0.001" /><testcase classname="tests.test_progress_tracking_service.TestProgressTrackingService" name="test_enhanced_progress_insights_generation" time="0.002"><failure message="AssertionError: 1 not greater than 1">self = &lt;tests.test_progress_tracking_service.TestProgressTrackingService testMethod=test_enhanced_progress_insights_generation&gt;

    def test_enhanced_progress_insights_generation(self):
        async def run():
            # Create a scenario with high therapeutic momentum
            high_momentum_summaries = []
            now = datetime.utcnow()
            for i in range(15):  # 15 sessions
                start = now - timedelta(days=i, hours=1)
                end = now - timedelta(days=i)
                high_momentum_summaries.append(
                    SessionSummary(
                        session_id=f"momentum_s{i}",
                        character_name="Char",
                        world_name="World",
                        start_time=start,
                        end_time=end,
                        duration_minutes=35,  # Longer sessions
                        status=SessionStatus.COMPLETED,
                        progress_markers_count=2,
                        therapeutic_interventions_count=3,
                    )
                )

            self.repo._summaries = high_momentum_summaries

            insights = await self.service.generate_progress_insights(self.player_id)

            # Should generate multiple relevant recommendations
            self.assertGreater(len(insights), 0)
            self.assertLessEqual(len(insights), 6)  # Should limit to top 6

            # Recommendations should be sorted by priority
            priorities = [rec.priority for rec in insights]
            self.assertEqual(priorities, sorted(priorities))

            # Should include diverse recommendation types
            rec_types = [rec.recommendation_type for rec in insights]
            self.assertGreater(len(set(rec_types)), 1)  # Multiple types

&gt;       asyncio.run(run())

tests/test_progress_tracking_service.py:257:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/asyncio/runners.py:190: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
tests/test_progress_tracking_service.py:255: in run
    self.assertGreater(len(set(rec_types)), 1)  # Multiple types
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   AssertionError: 1 not greater than 1</failure></testcase><testcase classname="tests.test_progress_tracking_service.TestProgressTrackingService" name="test_enhanced_progress_summary_with_therapeutic_integration" time="0.002" /><testcase classname="tests.test_progress_tracking_service.TestProgressTrackingService" name="test_generate_progress_insights" time="0.001" /><testcase classname="tests.test_progress_tracking_service.TestProgressTrackingService" name="test_get_visualization_data" time="0.001" /><testcase classname="tests.test_progress_tracking_service.TestProgressTrackingService" name="test_milestone_celebration" time="0.001" /><testcase classname="tests.test_progress_tracking_service.TestProgressTrackingService" name="test_streak_calculation_accuracy" time="0.001" /><testcase classname="tests.test_progress_tracking_service.TestProgressTrackingService" name="test_therapeutic_effectiveness_report" time="0.001" /><testcase classname="tests.test_progress_tracking_service.TestProgressTrackingService" name="test_therapeutic_value_assessment" time="0.000" /><testcase classname="tests.test_progress_tracking_service.TestProgressTrackingService" name="test_visualization_data_accuracy" time="0.001" /><testcase classname="tests.test_redis_integration" name="test_redis_container_basic" time="0.000"><skipped type="pytest.skip" message="Redis container not requested; use --redis or RUN_REDIS_TESTS=1">/home/thein/projects/projects/TTA/tests/test_redis_integration.py:5: Redis container not requested; use --redis or RUN_REDIS_TESTS=1</skipped></testcase><testcase classname="tests.test_redis_integration" name="test_redis_container_expiry" time="0.000"><skipped type="pytest.skip" message="Redis container not requested; use --redis or RUN_REDIS_TESTS=1">/home/thein/projects/projects/TTA/tests/test_redis_integration.py:12: Redis container not requested; use --redis or RUN_REDIS_TESTS=1</skipped></testcase><testcase classname="tests.test_session_integration_manager_simple.TestSessionIntegrationManagerCore" name="test_context_switching_logic" time="0.006" /><testcase classname="tests.test_session_integration_manager_simple.TestSessionIntegrationManagerCore" name="test_error_handling" time="0.005" /><testcase classname="tests.test_session_integration_manager_simple.TestSessionIntegrationManagerCore" name="test_progress_marker_addition" time="0.003" /><testcase classname="tests.test_session_integration_manager_simple.TestSessionIntegrationManagerCore" name="test_session_continuity_data" time="0.002" /><testcase classname="tests.test_session_integration_manager_simple.TestSessionIntegrationManagerCore" name="test_session_creation_data_structure" time="0.004" /><testcase classname="tests.test_session_integration_manager_simple.TestSessionIntegrationManagerCore" name="test_session_interaction_updates" time="0.004" /><testcase classname="tests.test_session_integration_manager_simple.TestSessionIntegrationManagerCore" name="test_session_state_preservation" time="0.004" /><testcase classname="tests.test_session_integration_manager_simple.TestSessionIntegrationManagerCore" name="test_therapeutic_settings_update" time="0.004" /><testcase classname="tests.test_session_management.TestSessionRepository" name="test_create_session" time="0.002" /><testcase classname="tests.test_session_management.TestSessionRepository" name="test_deserialize_session_context" time="0.003" /><testcase classname="tests.test_session_management.TestSessionRepository" name="test_end_session" time="0.003" /><testcase classname="tests.test_session_management.TestSessionRepository" name="test_get_session_from_cache" time="0.002" /><testcase classname="tests.test_session_management.TestSessionRepository" name="test_pause_session" time="0.001" /><testcase classname="tests.test_session_management.TestSessionRepository" name="test_serialize_session_context" time="0.002" /><testcase classname="tests.test_session_management.TestSessionIntegrationManager" name="test_add_progress_marker" time="0.002" /><testcase classname="tests.test_session_management.TestSessionIntegrationManager" name="test_create_session" time="0.003" /><testcase classname="tests.test_session_management.TestSessionIntegrationManager" name="test_end_session" time="0.002" /><testcase classname="tests.test_session_management.TestSessionIntegrationManager" name="test_get_session_continuity_data" time="0.003" /><testcase classname="tests.test_session_management.TestSessionIntegrationManager" name="test_pause_session" time="0.002" /><testcase classname="tests.test_session_management.TestSessionIntegrationManager" name="test_resume_session" time="0.003" /><testcase classname="tests.test_session_management.TestSessionIntegrationManager" name="test_switch_character_world_context_existing_session" time="0.002" /><testcase classname="tests.test_session_management.TestSessionIntegrationManager" name="test_switch_character_world_context_new_session" time="0.003" /><testcase classname="tests.test_session_management.TestSessionIntegrationManager" name="test_update_session_interaction" time="0.003" /><testcase classname="tests.test_session_management.TestSessionIntegrationManager" name="test_update_therapeutic_settings" time="0.005" /><testcase classname="tests.test_session_management.TestSessionLifecycleIntegration" name="test_complete_session_lifecycle" time="0.002" /><testcase classname="tests.test_session_narrative_integration.TestSessionNarrativeIntegration" name="test_context_switching_with_narrative_continuity" time="0.084" /><testcase classname="tests.test_session_narrative_integration.TestSessionNarrativeIntegration" name="test_session_continuity_data_includes_narrative_state" time="0.003" /><testcase classname="tests.test_session_narrative_integration.TestSessionNarrativeIntegration" name="test_session_creation_with_narrative_initialization" time="0.002" /><testcase classname="tests.test_session_narrative_integration.TestSessionNarrativeIntegration" name="test_session_ending_with_narrative_finalization" time="0.002" /><testcase classname="tests.test_session_narrative_integration.TestSessionNarrativeIntegration" name="test_session_pause_and_resume_with_state_preservation" time="0.003" /><testcase classname="tests.test_session_narrative_integration.TestSessionNarrativeIntegration" name="test_therapeutic_settings_update_with_narrative_engine" time="0.002" /><testcase classname="tests.test_session_repository_redis_integration" name="test_session_repository_redis_cache_roundtrip" time="0.000"><skipped type="pytest.skip" message="Redis container not requested; use --redis or RUN_REDIS_TESTS=1">/home/thein/projects/projects/TTA/tests/test_session_repository_redis_integration.py:10: Redis container not requested; use --redis or RUN_REDIS_TESTS=1</skipped></testcase><testcase classname="tests.test_therapeutic_effectiveness_integration" name="test_placeholder_integration_runs" time="0.000" /><testcase classname="tests.test_therapeutic_profile_integration.TestTherapeuticProfileIntegrationService" name="test_adapt_content_for_anxious_character" time="0.001" /><testcase classname="tests.test_therapeutic_profile_integration.TestTherapeuticProfileIntegrationService" name="test_adapt_content_for_high_intensity_character" time="0.001" /><testcase classname="tests.test_therapeutic_profile_integration.TestTherapeuticProfileIntegrationService" name="test_adapt_therapeutic_content" time="0.001" /><testcase classname="tests.test_therapeutic_profile_integration.TestTherapeuticProfileIntegrationService" name="test_calculate_readiness_adjustment" time="0.001" /><testcase classname="tests.test_therapeutic_profile_integration.TestTherapeuticProfileIntegrationService" name="test_create_personalization_context" time="0.001" /><testcase classname="tests.test_therapeutic_profile_integration.TestTherapeuticProfileIntegrationService" name="test_create_therapeutic_profile_from_character" time="0.001" /><testcase classname="tests.test_therapeutic_profile_integration.TestTherapeuticProfileIntegrationService" name="test_extract_therapeutic_insights" time="0.000" /><testcase classname="tests.test_therapeutic_profile_integration.TestTherapeuticProfileIntegrationService" name="test_generate_personalization_recommendations" time="0.001" /><testcase classname="tests.test_therapeutic_profile_integration.TestTherapeuticProfileIntegrationService" name="test_generate_therapeutic_goals" time="0.001" /><testcase classname="tests.test_therapeutic_profile_integration.TestTherapeuticProfileIntegrationService" name="test_get_character_adaptations" time="0.001" /><testcase classname="tests.test_therapeutic_profile_integration.TestTherapeuticProfileIntegrationService" name="test_get_character_recommendations" time="0.000" /><testcase classname="tests.test_therapeutic_profile_integration.TestTherapeuticProfileIntegrationService" name="test_recommend_intensity_adjustments" time="0.000" /><testcase classname="tests.test_therapeutic_profile_integration.TestTherapeuticProfileIntegrationService" name="test_recommend_therapeutic_approaches" time="0.000" /><testcase classname="tests.test_therapeutic_profile_integration.TestTherapeuticProfileIntegrationService" name="test_update_adaptation_effectiveness" time="0.000" /><testcase classname="tests.test_therapeutic_settings.TestTherapeuticBoundary" name="test_boundary_auto_id_generation" time="0.000" /><testcase classname="tests.test_therapeutic_settings.TestTherapeuticBoundary" name="test_boundary_creation" time="0.000" /><testcase classname="tests.test_therapeutic_settings.TestTherapeuticBoundary" name="test_boundary_invalid_severity" time="0.001" /><testcase classname="tests.test_therapeutic_settings.TestEnhancedTherapeuticSettings" name="test_add_boundary" time="0.001" /><testcase classname="tests.test_therapeutic_settings.TestEnhancedTherapeuticSettings" name="test_add_preferred_approach" time="0.000" /><testcase classname="tests.test_therapeutic_settings.TestEnhancedTherapeuticSettings" name="test_create_new_version" time="0.000" /><testcase classname="tests.test_therapeutic_settings.TestEnhancedTherapeuticSettings" name="test_get_active_boundaries" time="0.000" /><testcase classname="tests.test_therapeutic_settings.TestEnhancedTherapeuticSettings" name="test_get_all_approaches" time="0.001" /><testcase classname="tests.test_therapeutic_settings.TestEnhancedTherapeuticSettings" name="test_remove_boundary" time="0.001" /><testcase classname="tests.test_therapeutic_settings.TestEnhancedTherapeuticSettings" name="test_remove_preferred_approach" time="0.001" /><testcase classname="tests.test_therapeutic_settings.TestEnhancedTherapeuticSettings" name="test_settings_auto_id_generation" time="0.001" /><testcase classname="tests.test_therapeutic_settings.TestEnhancedTherapeuticSettings" name="test_settings_creation" time="0.001" /><testcase classname="tests.test_therapeutic_settings.TestEnhancedTherapeuticSettings" name="test_settings_validation" time="0.001" /><testcase classname="tests.test_therapeutic_settings.TestEnhancedTherapeuticSettings" name="test_update_intensity" time="0.011" /><testcase classname="tests.test_therapeutic_settings.TestTherapeuticPreferencesValidator" name="test_contradictory_preferences" time="0.001" /><testcase classname="tests.test_therapeutic_settings.TestTherapeuticPreferencesValidator" name="test_intensity_approach_mismatch" time="0.000" /><testcase classname="tests.test_therapeutic_settings.TestTherapeuticPreferencesValidator" name="test_non_resolvable_conflict" time="0.000" /><testcase classname="tests.test_therapeutic_settings.TestTherapeuticPreferencesValidator" name="test_resolve_conflict" time="0.000" /><testcase classname="tests.test_therapeutic_settings.TestTherapeuticPreferencesValidator" name="test_unsafe_combinations" time="0.000" /><testcase classname="tests.test_therapeutic_settings.TestTherapeuticPreferencesValidator" name="test_valid_settings" time="0.000" /><testcase classname="tests.test_therapeutic_settings.TestSettingsMigrationManager" name="test_migrate_float_intensity_conversion" time="0.001" /><testcase classname="tests.test_therapeutic_settings.TestSettingsMigrationManager" name="test_migrate_invalid_approaches_filtering" time="0.000" /><testcase classname="tests.test_therapeutic_settings.TestSettingsMigrationManager" name="test_migrate_to_v1_from_basic_settings" time="0.000" /><testcase classname="tests.test_therapeutic_settings.TestSettingsMigrationManager" name="test_migrate_unsupported_version" time="0.000" /><testcase classname="tests.test_websocket_chat_backend" name="test_ws_rejects_without_token" time="0.031" /><testcase classname="tests.test_websocket_chat_backend" name="test_ws_connects_with_token_and_welcome" time="0.034" /><testcase classname="tests.test_websocket_chat_backend" name="test_user_message_roundtrip" time="0.030"><failure message="starlette.websockets.WebSocketDisconnect">client = &lt;starlette.testclient.TestClient object at 0x7f0aba58b410&gt;

    def test_user_message_roundtrip(client: TestClient) -&gt; None:
        token = _auth_token("player-xyz")
        with client.websocket_connect(f"/ws/chat?token={token}") as ws:
            # consume welcome
            ws.receive_text()
            payload = {
                "type": "user_message",
                "content": {"text": "Hello, I feel okay today."},
                "metadata": {"character_id": "char-1", "world_id": "world-1"},
            }
            ws.send_text(json.dumps(payload))
&gt;           reply = json.loads(ws.receive_text())
                               ^^^^^^^^^^^^^^^^^

tests/test_websocket_chat_backend.py:55:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:187: in receive_text
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = &lt;starlette.testclient.WebSocketTestSession object at 0x7f0aba589c50&gt;
message = {'code': 1011, 'reason': '', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -&gt; None:
        if message["type"] == "websocket.close":
&gt;           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

.venv/lib/python3.11/site-packages/starlette/testclient.py:150: WebSocketDisconnect</failure></testcase><testcase classname="tests.test_websocket_chat_backend" name="test_feedback_processing_ack" time="0.040" /><testcase classname="tests.test_websocket_chat_backend_task8_2" name="test_user_message_includes_recommendations_and_no_crisis_by_default" time="0.033"><failure message="starlette.websockets.WebSocketDisconnect">client = &lt;starlette.testclient.TestClient object at 0x7f0ab9c7ea50&gt;

    def test_user_message_includes_recommendations_and_no_crisis_by_default(client: TestClient) -&gt; None:
        token = _auth_token()
        with client.websocket_connect(f"/ws/chat?token={token}") as ws:
            ws.receive_text()  # welcome
            ws.send_text(json.dumps({
                "type": "user_message",
                "content": {"text": "Hello there, I'd like some gentle support today."}
            }))
&gt;           reply = json.loads(ws.receive_text())
                               ^^^^^^^^^^^^^^^^^

tests/test_websocket_chat_backend_task8_2.py:37:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:187: in receive_text
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = &lt;starlette.testclient.WebSocketTestSession object at 0x7f0ab9c7c510&gt;
message = {'code': 1011, 'reason': '', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -&gt; None:
        if message["type"] == "websocket.close":
&gt;           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

.venv/lib/python3.11/site-packages/starlette/testclient.py:150: WebSocketDisconnect</failure></testcase><testcase classname="tests.test_websocket_chat_backend_task8_2" name="test_crisis_detection_includes_resources" time="0.030"><failure message="starlette.websockets.WebSocketDisconnect">client = &lt;starlette.testclient.TestClient object at 0x7f0aba55ba90&gt;

    def test_crisis_detection_includes_resources(client: TestClient) -&gt; None:
        token = _auth_token("player-crisis")
        with client.websocket_connect(f"/ws/chat?token={token}") as ws:
            ws.receive_text()  # welcome
            ws.send_text(json.dumps({
                "type": "user_message",
                "content": {"text": "I feel like I want to die and can't go on."}
            }))
&gt;           reply = json.loads(ws.receive_text())
                               ^^^^^^^^^^^^^^^^^

tests/test_websocket_chat_backend_task8_2.py:52:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:187: in receive_text
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = &lt;starlette.testclient.WebSocketTestSession object at 0x7f0ab8740d50&gt;
message = {'code': 1011, 'reason': '', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -&gt; None:
        if message["type"] == "websocket.close":
&gt;           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

.venv/lib/python3.11/site-packages/starlette/testclient.py:150: WebSocketDisconnect</failure></testcase><testcase classname="tests.test_websocket_chat_backend_task8_2" name="test_feedback_triggers_recommendations" time="0.031" /><testcase classname="tests.test_websocket_chat_interactive" name="test_interactive_buttons_suggested_on_anxiety" time="0.032"><failure message="starlette.websockets.WebSocketDisconnect">client = &lt;starlette.testclient.TestClient object at 0x7f0aaa95ffd0&gt;

    def test_interactive_buttons_suggested_on_anxiety(client: TestClient) -&gt; None:
        token = _auth_token("player-anxious")
        with client.websocket_connect(f"/ws/chat?token={token}") as ws:
            _recv_json(ws)  # welcome
            ws.send_text(json.dumps({
                "type": "user_message",
                "content": {"text": "I'm feeling very anxious and overwhelmed"},
            }))
&gt;           reply = _recv_json(ws)
                    ^^^^^^^^^^^^^^

tests/test_websocket_chat_interactive.py:41:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
tests/test_websocket_chat_interactive.py:30: in _recv_json
    return json.loads(ws.receive_text())
                      ^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:187: in receive_text
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = &lt;starlette.testclient.WebSocketTestSession object at 0x7f0aaa95d610&gt;
message = {'code': 1011, 'reason': '', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -&gt; None:
        if message["type"] == "websocket.close":
&gt;           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

.venv/lib/python3.11/site-packages/starlette/testclient.py:150: WebSocketDisconnect</failure></testcase><testcase classname="tests.test_websocket_chat_interactive" name="test_guided_exercise_flow_records_progress" time="0.031" /><testcase classname="tests.test_websocket_chat_typing_and_metrics" name="test_typing_events_emitted_when_opt_in" time="0.033"><failure message="starlette.websockets.WebSocketDisconnect">client = &lt;starlette.testclient.TestClient object at 0x7f0aaad78190&gt;

    def test_typing_events_emitted_when_opt_in(client: TestClient) -&gt; None:
        reset_metrics()
        token = _auth_token()
        with client.websocket_connect(f"/ws/chat?token={token}&amp;typing=1") as ws:
            ws.receive_text()  # welcome
            ws.send_text(json.dumps({"type": "user_message", "content": {"text": "Hello"}}))
            first = json.loads(ws.receive_text())
            # first event should be typing start
            assert first["content"].get("event") == "typing"
            assert first["content"].get("status") == "start"
            # then assistant reply
&gt;           reply = json.loads(ws.receive_text())
                               ^^^^^^^^^^^^^^^^^

tests/test_websocket_chat_typing_and_metrics.py:41:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:187: in receive_text
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = &lt;starlette.testclient.WebSocketTestSession object at 0x7f0ab8065510&gt;
message = {'code': 1011, 'reason': '', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -&gt; None:
        if message["type"] == "websocket.close":
&gt;           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

.venv/lib/python3.11/site-packages/starlette/testclient.py:150: WebSocketDisconnect</failure></testcase><testcase classname="tests.test_websocket_chat_typing_and_metrics" name="test_metrics_incremented" time="0.036"><failure message="starlette.websockets.WebSocketDisconnect">client = &lt;starlette.testclient.TestClient object at 0x7f0ab8629c90&gt;

    def test_metrics_incremented(client: TestClient) -&gt; None:
        reset_metrics()
        token = _auth_token("player-metrics")
        with client.websocket_connect(f"/ws/chat?token={token}") as ws:
            ws.receive_text()  # welcome
            before = dict(METRICS)
            ws.send_text(json.dumps({"type": "user_message", "content": {"text": "check"}}))
&gt;           json.loads(ws.receive_text())  # assistant
                       ^^^^^^^^^^^^^^^^^

tests/test_websocket_chat_typing_and_metrics.py:56:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:187: in receive_text
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = &lt;starlette.testclient.WebSocketTestSession object at 0x7f0ab862b350&gt;
message = {'code': 1011, 'reason': '', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -&gt; None:
        if message["type"] == "websocket.close":
&gt;           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

.venv/lib/python3.11/site-packages/starlette/testclient.py:150: WebSocketDisconnect</failure></testcase><testcase classname="tests.test_world_management_api" name="test_worlds_root_requires_auth" time="0.029" /><testcase classname="tests.test_world_management_api" name="test_get_world_requires_auth" time="0.030" /><testcase classname="tests.test_world_management_api" name="test_check_compatibility_requires_auth" time="0.029" /><testcase classname="tests.test_world_management_api" name="test_customize_requires_auth" time="0.029" /><testcase classname="tests.test_world_management_api" name="test_list_worlds_happy_path" time="0.031"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 52, in test_list_worlds_happy_path
    |     resp = client.get("/api/v1/worlds/?limit=1&amp;offset=0", headers=auth_headers)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 52, in test_list_worlds_happy_path
    resp = client.get("/api/v1/worlds/?limit=1&amp;offset=0", headers=auth_headers)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = &lt;starlette.testclient.TestClient object at 0x7f0ab86b7910&gt;
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_list_worlds_happy_path(client: TestClient, auth_headers: Dict[str, str]) -&gt; None:
&gt;       resp = client.get("/api/v1/worlds/?limit=1&amp;offset=0", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_world_management_api.py:52:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_world_management_api" name="test_get_world_details_happy_path" time="0.031"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 61, in test_get_world_details_happy_path
    |     resp = client.get("/api/v1/worlds/world_mindfulness_garden", headers=auth_headers)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 61, in test_get_world_details_happy_path
    resp = client.get("/api/v1/worlds/world_mindfulness_garden", headers=auth_headers)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = &lt;starlette.testclient.TestClient object at 0x7f0ab9cb7ed0&gt;
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_get_world_details_happy_path(client: TestClient, auth_headers: Dict[str, str]) -&gt; None:
&gt;       resp = client.get("/api/v1/worlds/world_mindfulness_garden", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_world_management_api.py:61:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_world_management_api" name="test_compatibility_happy_path" time="0.032"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 69, in test_compatibility_happy_path
    |     resp = client.get(
    |            ^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 69, in test_compatibility_happy_path
    resp = client.get(
           ^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = &lt;starlette.testclient.TestClient object at 0x7f0ab8a67750&gt;
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_compatibility_happy_path(client: TestClient, auth_headers: Dict[str, str]) -&gt; None:
&gt;       resp = client.get(
            "/api/v1/worlds/world_mindfulness_garden/compatibility/char-xyz",
            headers=auth_headers,
        )

tests/test_world_management_api.py:69:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_world_management_api" name="test_customize_world_happy_path" time="0.032"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 81, in test_customize_world_happy_path
    |     resp = client.post(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 81, in test_customize_world_happy_path
    resp = client.post(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = &lt;starlette.testclient.TestClient object at 0x7f0aa8355ed0&gt;
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_customize_world_happy_path(client: TestClient, auth_headers: Dict[str, str]) -&gt; None:
        payload = {"therapeutic_intensity": 0.7, "session_length_preference": 45}
&gt;       resp = client.post(
            "/api/v1/worlds/world_mindfulness_garden/customize",
            headers=auth_headers,
            json=payload,
        )

tests/test_world_management_api.py:81:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.11/site-packages/httpx/_client.py:1157: in post
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_world_management_api" name="test_get_world_not_found" time="0.114"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 95, in test_get_world_not_found
    |     resp = client.get("/api/v1/worlds/does-not-exist", headers=auth_headers)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 95, in test_get_world_not_found
    resp = client.get("/api/v1/worlds/does-not-exist", headers=auth_headers)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = &lt;starlette.testclient.TestClient object at 0x7f0ab87adf10&gt;
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_get_world_not_found(client: TestClient, auth_headers: Dict[str, str]) -&gt; None:
&gt;       resp = client.get("/api/v1/worlds/does-not-exist", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_world_management_api.py:95:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_world_management_api" name="test_customize_world_not_found" time="0.035"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 100, in test_customize_world_not_found
    |     resp = client.post(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 100, in test_customize_world_not_found
    resp = client.post(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = &lt;starlette.testclient.TestClient object at 0x7f0ab8b503d0&gt;
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_customize_world_not_found(client: TestClient, auth_headers: Dict[str, str]) -&gt; None:
&gt;       resp = client.post(
            "/api/v1/worlds/does-not-exist/customize",
            headers=auth_headers,
            json={},
        )

tests/test_world_management_api.py:100:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.11/site-packages/httpx/_client.py:1157: in post
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_world_management_api" name="test_customize_world_invalid_params" time="0.030"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 111, in test_customize_world_invalid_params
    |     resp = client.post(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 111, in test_customize_world_invalid_params
    resp = client.post(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1157, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = &lt;starlette.testclient.TestClient object at 0x7f0ab8048e50&gt;
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_customize_world_invalid_params(client: TestClient, auth_headers: Dict[str, str]) -&gt; None:
        # invalid session length &lt; 10
        payload = {"session_length_preference": 5}
&gt;       resp = client.post(
            "/api/v1/worlds/world_mindfulness_garden/customize",
            headers=auth_headers,
            json=payload,
        )

tests/test_world_management_api.py:111:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.11/site-packages/httpx/_client.py:1157: in post
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_world_management_api" name="test_list_worlds_pagination" time="0.032"><failure message="AttributeError: 'TokenData' object has no attribute 'get'">+ Exception Group Traceback (most recent call last):
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 120, in test_list_worlds_pagination
    |     resp_all = client.get("/api/v1/worlds/", headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    |     request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
    |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'TokenData' object has no attribute 'get'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/thein/projects/projects/TTA/tests/test_world_management_api.py", line 120, in test_list_worlds_pagination
    resp_all = client.get("/api/v1/worlds/", headers=auth_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1066, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 837, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 926, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 954, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 991, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1027, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 326, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/home/thein/.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/src/player_experience/api/middleware.py", line 125, in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/thein/projects/projects/TTA/.venv/lib/python3.11/site-packages/pydantic/main.py", line 991, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'TokenData' object has no attribute 'get'

During handling of the above exception, another exception occurred:

client = &lt;starlette.testclient.TestClient object at 0x7f0ab8636690&gt;
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwbGF5ZXItMSIsInVzZXJuYW1lIjoidGVzdCIsImVtYWlsIjoidEBleGFtcGxlLmNvbSJ9.DE2WW7UOZIloq5961SRTHMfz32kGgx09aLEhRoYZBrQ'}

    def test_list_worlds_pagination(client: TestClient, auth_headers: Dict[str, str]) -&gt; None:
&gt;       resp_all = client.get("/api/v1/worlds/", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_world_management_api.py:120:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.11/site-packages/starlette/testclient.py:479: in get
    return super().get(
.venv/lib/python3.11/site-packages/httpx/_client.py:1066: in get
    return self.request(
.venv/lib/python3.11/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.11/site-packages/httpx/_client.py:837: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:926: in send
    response = self._send_handling_auth(
.venv/lib/python3.11/site-packages/httpx/_client.py:954: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.11/site-packages/httpx/_client.py:991: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/httpx/_client.py:1027: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.11/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.11/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.11/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:326: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
.venv/lib/python3.11/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.11/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/player_experience/api/middleware.py:125: in dispatch
    request_id, endpoint, method, user_id=getattr(request.state, 'current_player', {}).get('player_id')
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = TokenData(player_id='player-1', username='test', email='t@example.com', exp=None), item = 'get'

    def __getattr__(self, item: str) -&gt; Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore

            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None

            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
&gt;                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'TokenData' object has no attribute 'get'

.venv/lib/python3.11/site-packages/pydantic/main.py:991: AttributeError</failure></testcase><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_advanced_compatibility_checking_with_character_object" time="0.001" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_assess_world_suitability_for_character" time="0.001" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_assess_world_suitability_nonexistent_world" time="0.001" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_basic_compatibility_score_calculation" time="0.000" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_check_world_compatibility_existing_world" time="0.000" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_check_world_compatibility_nonexistent_world" time="0.001" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_compatibility_factors_calculation" time="0.001" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_customize_world_parameters_invalid_parameters" time="0.000" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_customize_world_parameters_invalid_world" time="0.001" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_customize_world_parameters_valid" time="0.000" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_get_available_worlds_with_character" time="0.001" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_get_available_worlds_without_character" time="0.000" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_get_world_details_existing_world" time="0.001" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_get_world_details_nonexistent_world" time="0.001" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_get_world_recommendations" time="0.001" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_initialization" time="0.001" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_initialize_character_in_world_basic" time="0.001" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_initialize_character_in_world_nonexistent_world" time="0.001" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_initialize_character_in_world_with_parameters" time="0.001" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_initialize_character_with_external_components" time="0.002" /><testcase classname="tests.test_world_management_module.TestWorldManagementModule" name="test_world_parameters_validation" time="0.001" /></testsuite></testsuites>
