

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.components.agent_orchestration_component &mdash; TTA - Therapeutic Text Adventure 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=c5250a58" />


      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=30646c52"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">mermaid.initialize({startOnLoad:true});</script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
</head>

<body class="wy-body-for-nav">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >



          <a href="../../../index.html" class="icon icon-home">
            TTA - Therapeutic Text Adventure
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Platform Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">src</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development/index.html">Development Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/index.html">Testing Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deployment/index.html">Deployment Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing to TTA</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TTA - Therapeutic Text Adventure</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">src.components.agent_orchestration_component</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <h1>Source code for src.components.agent_orchestration_component</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Agent Orchestration Component</span>

<span class="sd">Provides a lightweight entrypoint component that will host workflow management,</span>
<span class="sd">message coordination, and agent proxy registration in subsequent tasks.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.orchestration.component</span><span class="w"> </span><span class="kn">import</span> <span class="n">Component</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.orchestration.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_entry_exit</span><span class="p">,</span> <span class="n">timing_decorator</span>

<span class="c1"># Utility to parse memory-size strings like &quot;4GB&quot; into bytes</span>
<span class="n">_DEF_UNITS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;kb&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="s2">&quot;mb&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;gb&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;tb&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_parse_bytes</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">suf</span><span class="p">,</span> <span class="n">mul</span> <span class="ow">in</span> <span class="n">_DEF_UNITS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suf</span><span class="p">):</span>
                <span class="n">num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">suf</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span> <span class="o">*</span> <span class="n">mul</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="c1"># For now we only rely on configuration and the base component lifecycle.</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="AgentOrchestrationComponent">
<a class="viewcode-back" href="../../../api/src.components.agent_orchestration_component.html#src.components.AgentOrchestrationComponent">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AgentOrchestrationComponent</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Component that initializes the Agent Orchestration Service.</span>

<span class="sd">    Dependencies are kept minimal for Task 1. Downstream tasks will introduce</span>
<span class="sd">    Redis, Neo4j, and LLM dependencies as concrete backends are implemented.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;agent_orchestration&quot;</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;redis&quot;</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># expect redis availability</span>

        <span class="c1"># Validate agent orchestration configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validated_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_configuration</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.port&quot;</span><span class="p">,</span> <span class="mi">8503</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized Agent Orchestration component on port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message_coordinator</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># optional registry for discovery/health</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_manager</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># workflow management</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orchestration_service</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># main orchestration service</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_callable_registry</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate agent orchestration configuration using schema validation.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.config_schema</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">validate_agent_orchestration_config</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Extract agent orchestration config section</span>
            <span class="n">ao_config_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;enabled&quot;</span><span class="p">,</span>
                <span class="s2">&quot;port&quot;</span><span class="p">,</span>
                <span class="s2">&quot;max_concurrent_workflows&quot;</span><span class="p">,</span>
                <span class="s2">&quot;workflow_timeout&quot;</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">,</span>
                <span class="s2">&quot;resources&quot;</span><span class="p">,</span>
                <span class="s2">&quot;messaging&quot;</span><span class="p">,</span>
                <span class="s2">&quot;monitoring&quot;</span><span class="p">,</span>
                <span class="s2">&quot;diagnostics&quot;</span><span class="p">,</span>
                <span class="s2">&quot;realtime&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;agent_orchestration.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ao_config_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="c1"># If no config found, use defaults</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ao_config_dict</span><span class="p">:</span>
                <span class="n">ao_config_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

            <span class="c1"># Validate configuration</span>
            <span class="n">validated_config</span> <span class="o">=</span> <span class="n">validate_agent_orchestration_config</span><span class="p">(</span><span class="n">ao_config_dict</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Agent orchestration configuration validated successfully&quot;</span><span class="p">)</span>

            <span class="c1"># Log security-relevant settings</span>
            <span class="k">if</span> <span class="n">validated_config</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">auto_register</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Global auto-registration is ENABLED - ensure this is intended for your environment&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Global auto-registration is disabled (secure default)&quot;</span><span class="p">)</span>

            <span class="c1"># Check per-agent auto-registration</span>
            <span class="n">enabled_agents</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">agent_type</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;input_processor&quot;</span><span class="p">,</span>
                <span class="s2">&quot;world_builder&quot;</span><span class="p">,</span>
                <span class="s2">&quot;narrative_generator&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">if</span> <span class="n">validated_config</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">is_auto_registration_enabled</span><span class="p">(</span><span class="n">agent_type</span><span class="p">):</span>
                    <span class="n">enabled_agents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_type</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">enabled_agents</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Per-agent auto-registration enabled for: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">enabled_agents</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Per-agent auto-registration disabled for all agents (secure default)&quot;</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">validated_config</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration validation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Return None to indicate validation failure, but don&#39;t crash the component</span>
            <span class="c1"># The component will use raw config values as fallback</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Async-friendly wrappers to satisfy tests that `await comp.start()/stop()`</span>
<div class="viewcode-block" id="AgentOrchestrationComponent.start">
<a class="viewcode-back" href="../../../api/src.components.agent_orchestration_component.html#src.components.AgentOrchestrationComponent.start">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>  <span class="c1"># type: ignore[override]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="AgentOrchestrationComponent.stop">
<a class="viewcode-back" href="../../../api/src.components.agent_orchestration_component.html#src.components.AgentOrchestrationComponent.stop">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>  <span class="c1"># type: ignore[override]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">stop</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


    <span class="nd">@log_entry_exit</span>
    <span class="nd">@timing_decorator</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_start_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the orchestration service and perform message auto-recovery.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Initialize Redis client (async) and coordinator lazily when needed</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">redis.asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">aioredis</span>

            <span class="n">redis_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;player_experience.api.redis_url&quot;</span><span class="p">,</span> <span class="s2">&quot;redis://localhost:6379/0&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span> <span class="o">=</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">redis_url</span><span class="p">)</span>

            <span class="c1"># Defer import to avoid circulars</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.coordinators</span><span class="w"> </span><span class="kn">import</span> <span class="n">RedisMessageCoordinator</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_message_coordinator</span> <span class="o">=</span> <span class="n">RedisMessageCoordinator</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="p">,</span> <span class="n">key_prefix</span><span class="o">=</span><span class="s2">&quot;ao&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Initialize workflow error handling/monitoring (gated)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.error_handling.enabled&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.state_validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateValidator</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.workflow_monitor</span><span class="w"> </span><span class="kn">import</span> <span class="n">WorkflowMonitor</span>

                    <span class="n">tt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.workflow.timeouts.total_seconds&quot;</span><span class="p">,</span> <span class="mf">300.0</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">st</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.workflow.timeouts.per_step_seconds&quot;</span><span class="p">,</span>
                            <span class="mf">60.0</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">ard</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.workflow.audit_retention_days&quot;</span><span class="p">,</span> <span class="mi">30</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_monitor</span> <span class="o">=</span> <span class="n">WorkflowMonitor</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="p">,</span>
                        <span class="n">key_prefix</span><span class="o">=</span><span class="s2">&quot;ao&quot;</span><span class="p">,</span>
                        <span class="n">default_total_timeout_s</span><span class="o">=</span><span class="n">tt</span><span class="p">,</span>
                        <span class="n">default_step_timeout_s</span><span class="o">=</span><span class="n">st</span><span class="p">,</span>
                        <span class="n">audit_retention_days</span><span class="o">=</span><span class="n">ard</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># Background timeout checks</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_aio</span>

                    <span class="n">loop</span> <span class="o">=</span> <span class="n">_aio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_wf_timeout_task</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_monitor</span><span class="o">.</span><span class="n">check_timeouts_once</span><span class="p">()</span>
                        <span class="p">)</span>  <span class="c1"># one-shot kickoff</span>
                    <span class="c1"># Start periodic background checks only if explicitly enabled (default off for tests)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">iv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.workflow.timeout_check_interval_s&quot;</span><span class="p">,</span>
                                <span class="mf">1.0</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">iv</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.workflow.background_checks_enabled&quot;</span><span class="p">,</span>
                            <span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_monitor</span><span class="o">.</span><span class="n">start_background_checks</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="c1"># Periodic state validation</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_validator</span> <span class="o">=</span> <span class="n">StateValidator</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="p">,</span> <span class="n">key_prefix</span><span class="o">=</span><span class="s2">&quot;ao&quot;</span>
                    <span class="p">)</span>
                    <span class="n">svi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.workflow.state_validation_interval_s&quot;</span><span class="p">,</span>
                            <span class="mf">10.0</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="c1"># Periodic validation disabled in this component; tests call validator directly</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Attach router to coordinator</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.router</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentRouter</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_agent_router</span> <span class="o">=</span> <span class="n">AgentRouter</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="p">,</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_tool_policy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="c1"># Router configuration from component config</span>
                <span class="n">rcfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.router&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">wq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight_queue&quot;</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">))</span>
                <span class="n">wh</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight_heartbeat&quot;</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">))</span>
                <span class="n">ws</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight_success&quot;</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">))</span>
                <span class="n">hf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;heartbeat_fresh_seconds&quot;</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_agent_router</span> <span class="o">=</span> <span class="n">AgentRouter</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="p">,</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_tool_policy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">heartbeat_fresh_s</span><span class="o">=</span><span class="n">hf</span><span class="p">,</span>
                    <span class="n">w_queue</span><span class="o">=</span><span class="n">wq</span><span class="p">,</span>
                    <span class="n">w_heartbeat</span><span class="o">=</span><span class="n">wh</span><span class="p">,</span>
                    <span class="n">w_success</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Configure sliding window on agents if provided</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">win</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.router.success_window_size&quot;</span><span class="p">,</span> <span class="mi">100</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">reg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_agent_registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">reg</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">reg</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">_metrics</span><span class="o">.</span><span class="n">set_window_size</span><span class="p">(</span><span class="n">win</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Auto-recovery: reclaim expired reservations across agents (opt-in)</span>
            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;agent_orchestration.workflow.auto_recover_on_start&quot;</span><span class="p">,</span> <span class="kc">False</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>

                <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_message_coordinator</span><span class="o">.</span><span class="n">recover_pending</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Auto-recovery scheduled asynchronously&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">recovered</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_message_coordinator</span><span class="o">.</span><span class="n">recover_pending</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Auto-recovery reclaimed </span><span class="si">%s</span><span class="s2"> messages in total&quot;</span><span class="p">,</span> <span class="n">recovered</span>
                    <span class="p">)</span>

            <span class="c1"># Start background polling task for queue lengths and DLQ gauges (gated)</span>
            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;agent_orchestration.metrics.background_polling_enabled&quot;</span><span class="p">,</span> <span class="kc">False</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metrics_task</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_poll_queue_metrics</span><span class="p">())</span>

            <span class="c1"># Initialize agent registry and start health checks if configured</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentRegistry</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span> <span class="o">=</span> <span class="n">AgentRegistry</span><span class="p">()</span>
                <span class="n">health_iv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;agent_orchestration.monitoring.health_check_interval&quot;</span><span class="p">,</span> <span class="mi">15</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">start_periodic_health_checks</span><span class="p">(</span><span class="n">health_iv</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Initialize ResourceManager and start background monitoring</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.resources</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResourceManager</span>

            <span class="n">rm</span> <span class="o">=</span> <span class="n">ResourceManager</span><span class="p">(</span>
                <span class="n">gpu_memory_limit_fraction</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;agent_orchestration.resources.gpu_memory_limit&quot;</span><span class="p">,</span> <span class="mf">0.8</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="n">cpu_thread_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;agent_orchestration.resources.cpu_thread_limit&quot;</span><span class="p">,</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="n">memory_limit_bytes</span><span class="o">=</span><span class="n">_parse_bytes</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.resources.memory_limit&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">warn_cpu_percent</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.monitoring.cpu_warn&quot;</span><span class="p">,</span> <span class="mi">85</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">warn_mem_percent</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.monitoring.mem_warn&quot;</span><span class="p">,</span> <span class="mi">85</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">crit_cpu_percent</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.monitoring.cpu_crit&quot;</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">crit_mem_percent</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.monitoring.mem_crit&quot;</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">redis_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="p">,</span>
                <span class="n">redis_prefix</span><span class="o">=</span><span class="s2">&quot;ao&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span> <span class="o">=</span> <span class="n">rm</span>

            <span class="c1"># Initialize WorkflowManager for workflow orchestration</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.workflow_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">WorkflowManager</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_manager</span> <span class="o">=</span> <span class="n">WorkflowManager</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;WorkflowManager initialized successfully&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize WorkflowManager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_manager</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Initialize therapeutic safety service (config-driven)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.therapeutic_safety</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">SafetyRulesProvider</span><span class="p">,</span>
                    <span class="n">SafetyService</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">key_prefix</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.tools.redis_key_prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;ao&quot;</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_tools_cfg&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">dict</span><span class="p">)</span>
                    <span class="k">else</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.tools&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;redis_key_prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;ao&quot;</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">redis_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key_prefix</span><span class="si">}</span><span class="s2">:safety:rules&quot;</span>
                <span class="n">enabled</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.safety.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">provider</span> <span class="o">=</span> <span class="n">SafetyRulesProvider</span><span class="p">(</span>
                    <span class="n">redis_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="p">,</span> <span class="n">redis_key</span><span class="o">=</span><span class="n">redis_key</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_safety_service</span> <span class="o">=</span> <span class="n">SafetyService</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="n">enabled</span><span class="p">,</span> <span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rm</span><span class="o">.</span><span class="n">start_background_monitoring</span><span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.monitoring.metrics_interval&quot;</span><span class="p">,</span> <span class="mi">30</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Initialize event publisher for real-time communication</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_event_publisher</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.realtime.events.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.realtime.event_publisher</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                        <span class="n">EventPublisher</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_event_publisher</span> <span class="o">=</span> <span class="n">EventPublisher</span><span class="p">(</span>
                        <span class="n">redis_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="p">,</span>
                        <span class="n">channel_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.realtime.events.redis_channel_prefix&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;ao:events&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">buffer_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.realtime.events.buffer_size&quot;</span><span class="p">,</span> <span class="mi">1000</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">broadcast_agent_status</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.realtime.events.broadcast_agent_status&quot;</span><span class="p">,</span>
                                <span class="kc">True</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">broadcast_workflow_progress</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.realtime.events.broadcast_workflow_progress&quot;</span><span class="p">,</span>
                                <span class="kc">True</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">broadcast_system_metrics</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.realtime.events.broadcast_system_metrics&quot;</span><span class="p">,</span>
                                <span class="kc">False</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Event publisher initialized for real-time communication&quot;</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize event publisher: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Initialize progressive feedback manager</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_feedback_manager</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;agent_orchestration.realtime.progressive_feedback.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.realtime.progressive_feedback</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                        <span class="n">ProgressiveFeedbackManager</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_feedback_manager</span> <span class="o">=</span> <span class="n">ProgressiveFeedbackManager</span><span class="p">(</span>
                        <span class="n">event_publisher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_publisher</span><span class="p">,</span>
                        <span class="n">update_interval</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.realtime.progressive_feedback.update_interval&quot;</span><span class="p">,</span>
                                <span class="mf">1.0</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">max_updates_per_operation</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.realtime.progressive_feedback.max_updates_per_workflow&quot;</span><span class="p">,</span>
                                <span class="mi">100</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">stream_intermediate_results</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.realtime.progressive_feedback.stream_intermediate_results&quot;</span><span class="p">,</span>
                                <span class="kc">True</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Progressive feedback manager initialized&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to initialize progressive feedback manager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Initialize workflow progress tracker</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_tracker</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.realtime.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.realtime.workflow_progress</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                        <span class="n">WorkflowProgressTracker</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_tracker</span> <span class="o">=</span> <span class="n">WorkflowProgressTracker</span><span class="p">(</span>
                        <span class="n">event_publisher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_publisher</span><span class="p">,</span>
                        <span class="n">update_interval</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.realtime.progressive_feedback.update_interval&quot;</span><span class="p">,</span>
                                <span class="mf">2.0</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">auto_publish_updates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Workflow progress tracker initialized&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to initialize workflow progress tracker: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Initialize response time optimization engine</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response_time_collector</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_engine</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_performance_analytics</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.optimization.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.optimization</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                        <span class="n">OptimizationEngine</span><span class="p">,</span>
                        <span class="n">OptimizationStrategy</span><span class="p">,</span>
                        <span class="n">PerformanceAnalytics</span><span class="p">,</span>
                        <span class="n">ResponseTimeCollector</span><span class="p">,</span>
                        <span class="n">WorkflowResourceManager</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Initialize response time collector</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_response_time_collector</span> <span class="o">=</span> <span class="n">ResponseTimeCollector</span><span class="p">(</span>
                        <span class="n">max_metrics_per_operation</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.optimization.max_metrics_per_operation&quot;</span><span class="p">,</span>
                                <span class="mi">1000</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">cleanup_interval</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.optimization.cleanup_interval&quot;</span><span class="p">,</span>
                                <span class="mf">300.0</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">metric_retention_hours</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.optimization.metric_retention_hours&quot;</span><span class="p">,</span>
                                <span class="mf">24.0</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                    <span class="c1"># Initialize optimization engine</span>
                    <span class="n">enabled_strategies_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;agent_orchestration.optimization.enabled_strategies&quot;</span><span class="p">,</span>
                        <span class="p">[</span><span class="s2">&quot;conservative&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="n">enabled_strategies</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">OptimizationStrategy</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">enabled_strategies_config</span>
                    <span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_engine</span> <span class="o">=</span> <span class="n">OptimizationEngine</span><span class="p">(</span>
                        <span class="n">response_time_collector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_response_time_collector</span><span class="p">,</span>
                        <span class="n">event_publisher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_publisher</span><span class="p">,</span>
                        <span class="n">optimization_interval</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.optimization.optimization_interval&quot;</span><span class="p">,</span>
                                <span class="mf">300.0</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">enabled_strategies</span><span class="o">=</span><span class="n">enabled_strategies</span><span class="p">,</span>
                        <span class="n">max_adjustments_per_cycle</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.optimization.max_adjustments_per_cycle&quot;</span><span class="p">,</span>
                                <span class="mi">3</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                    <span class="c1"># Initialize workflow resource manager</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span> <span class="o">=</span> <span class="n">WorkflowResourceManager</span><span class="p">(</span>
                        <span class="n">workflow_tracker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_workflow_tracker</span><span class="p">,</span>
                        <span class="n">response_time_collector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_response_time_collector</span><span class="p">,</span>
                        <span class="n">event_publisher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_publisher</span><span class="p">,</span>
                        <span class="n">max_concurrent_workflows</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.optimization.max_concurrent_workflows&quot;</span><span class="p">,</span>
                                <span class="mi">10</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">resource_monitoring_interval</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.optimization.resource_monitoring_interval&quot;</span><span class="p">,</span>
                                <span class="mf">30.0</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                    <span class="c1"># Initialize performance analytics</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_performance_analytics</span> <span class="o">=</span> <span class="n">PerformanceAnalytics</span><span class="p">(</span>
                        <span class="n">response_time_collector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_response_time_collector</span><span class="p">,</span>
                        <span class="n">optimization_engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_optimization_engine</span><span class="p">,</span>
                        <span class="n">resource_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="p">,</span>
                        <span class="n">analytics_interval</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.optimization.analytics_interval&quot;</span><span class="p">,</span>
                                <span class="mf">60.0</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Response time optimization engine initialized&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize optimization engine: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Initialize agent registry and start health checks if configured</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentRegistry</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.registries</span><span class="w"> </span><span class="kn">import</span> <span class="n">RedisAgentRegistry</span>

                <span class="n">ttl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.agents.heartbeat_ttl&quot;</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">hb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;agent_orchestration.agents.heartbeat_interval&quot;</span><span class="p">,</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="n">hb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hb</span><span class="p">)</span> <span class="k">if</span> <span class="n">hb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="c1"># Enable event broadcasting if realtime events are enabled</span>
                <span class="n">enable_events</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;agent_orchestration.realtime.events.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span> <span class="o">=</span> <span class="n">RedisAgentRegistry</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="p">,</span>
                    <span class="n">key_prefix</span><span class="o">=</span><span class="s2">&quot;ao&quot;</span><span class="p">,</span>
                    <span class="n">heartbeat_ttl_s</span><span class="o">=</span><span class="n">ttl</span><span class="p">,</span>
                    <span class="n">heartbeat_interval_s</span><span class="o">=</span><span class="n">hb</span><span class="p">,</span>
                    <span class="n">enable_events</span><span class="o">=</span><span class="n">enable_events</span><span class="p">,</span>
                    <span class="n">event_publisher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_publisher</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">health_iv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;agent_orchestration.monitoring.health_check_interval&quot;</span><span class="p">,</span> <span class="mi">15</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">start_periodic_health_checks</span><span class="p">(</span><span class="n">health_iv</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">start_heartbeats</span><span class="p">()</span>

                <span class="c1"># Start progressive feedback and workflow tracking services</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_feedback_manager&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feedback_manager</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feedback_manager</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Progressive feedback manager started&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to start progressive feedback manager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_workflow_tracker&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_tracker</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workflow_tracker</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Workflow progress tracker started&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to start workflow progress tracker: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                <span class="c1"># Start optimization services</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_response_time_collector&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_time_collector</span>
                <span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response_time_collector</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Response time collector started&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to start response time collector: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_optimization_engine&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_engine</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_optimization_engine</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Optimization engine started&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to start optimization engine: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_resource_manager&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Workflow resource manager started&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to start resource manager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_performance_analytics&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_performance_analytics</span>
                <span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_performance_analytics</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performance analytics started&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to start performance analytics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Register optimization parameters</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_optimization_engine&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_engine</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_register_optimization_parameters</span><span class="p">()</span>

                <span class="c1"># Configure restart and fallback callbacks for failure detection</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>

                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_restart_agent</span><span class="p">(</span><span class="n">agent</span><span class="p">:</span> <span class="n">Agent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">restore_state_if_available</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_restarts_total</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_restarts_total&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                    <span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span>
                                <span class="p">)</span>
                            <span class="p">):</span>
                                <span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_t</span>

                                <span class="n">ev</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">_t</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;restart&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;agent&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                                <span class="p">}</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_ao_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_ao_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ao_events</span><span class="p">[</span><span class="o">-</span><span class="mi">500</span><span class="p">:]</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Agent restart failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">set_restart_callback</span><span class="p">(</span><span class="n">_restart_agent</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_fallback_route</span><span class="p">(</span><span class="n">unhealthy</span><span class="p">:</span> <span class="n">Agent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># choose any other healthy agent of same type</span>
                        <span class="n">backups</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">a</span>
                            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">agent_id</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">unhealthy</span><span class="o">.</span><span class="n">agent_id</span><span class="o">.</span><span class="n">type</span>
                            <span class="ow">and</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">unhealthy</span>
                            <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">_running</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">_degraded</span>
                        <span class="p">]</span>  <span class="c1"># type: ignore</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">backups</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>
                        <span class="n">unhealthy</span><span class="o">.</span><span class="n">set_degraded</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_fallbacks_total</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_fallbacks_total&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                    <span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span>
                                <span class="p">)</span>
                            <span class="p">):</span>
                                <span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_t</span>

                                <span class="n">ev</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">_t</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;fallback&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">unhealthy</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                                    <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">backups</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                                <span class="p">}</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_ao_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_ao_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ao_events</span><span class="p">[</span><span class="o">-</span><span class="mi">500</span><span class="p">:]</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">set_fallback_callback</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">:</span> <span class="n">_fallback_route</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="n">fd_enabled</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;agent_orchestration.monitoring.failure_detection_enabled&quot;</span><span class="p">,</span> <span class="kc">True</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">fd_interval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;agent_orchestration.monitoring.failure_detection_interval&quot;</span><span class="p">,</span>
                        <span class="nb">max</span><span class="p">(</span>
                            <span class="mf">5.0</span><span class="p">,</span>
                            <span class="nb">float</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                    <span class="s2">&quot;agent_orchestration.monitoring.health_check_interval&quot;</span><span class="p">,</span>
                                    <span class="mi">15</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">),</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">fd_enabled</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fd_task</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_failure_detection_loop</span><span class="p">(</span><span class="n">fd_interval</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Fallback to in-memory registry if Redis registry fails</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentRegistry</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span> <span class="o">=</span> <span class="n">AgentRegistry</span><span class="p">()</span>
                    <span class="n">health_iv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.monitoring.health_check_interval&quot;</span><span class="p">,</span> <span class="mi">15</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">start_periodic_health_checks</span><span class="p">(</span><span class="n">health_iv</span><span class="p">)</span>

                    <span class="c1"># Configure restart callback and periodic failure detection</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.agents</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>  <span class="c1"># type: ignore</span>
                        <span class="n">Agent</span><span class="p">,</span>
                        <span class="n">AgentRegistry</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_restart_agent</span><span class="p">(</span><span class="n">agent</span><span class="p">:</span> <span class="n">Agent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;Concrete restart logic: stop-&gt;start the agent in place, restore state via Redis registry when available.</span>
<span class="sd">                        Returns True on success.</span>
<span class="sd">                        &quot;&quot;&quot;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                            <span class="c1"># Audit event: restart</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                        <span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span>
                                    <span class="p">)</span>
                                <span class="p">):</span>
                                    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_t</span>

                                    <span class="n">ev</span> <span class="o">=</span> <span class="p">{</span>
                                        <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">_t</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;restart&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;agent&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                                    <span class="p">}</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_ao_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_ao_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ao_events</span><span class="p">[</span><span class="o">-</span><span class="mi">500</span><span class="p">:]</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                            <span class="c1"># If Redis registry, attempt state restore again</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.registries</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                                    <span class="n">RedisAgentRegistry</span><span class="p">,</span>
                                <span class="p">)</span>

                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="p">,</span> <span class="n">RedisAgentRegistry</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                                    <span class="k">await</span> <span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">restore_state_if_available</span><span class="p">(</span>
                                            <span class="n">agent</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>  <span class="c1"># type: ignore</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="c1"># Record restart metric</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_restarts_total</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_restarts_total&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>

                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;Agent restart attempted: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">),</span>
                            <span class="p">)</span>
                            <span class="k">return</span> <span class="kc">True</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Agent restart failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                            <span class="k">return</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="p">,</span> <span class="n">AgentRegistry</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">set_restart_callback</span><span class="p">(</span><span class="n">_restart_agent</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

                    <span class="c1"># Fallback routing (capability-based placeholder: same agent type)</span>
                    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_fallback_route</span><span class="p">(</span><span class="n">unhealthy</span><span class="p">:</span> <span class="n">Agent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;Select a healthy backup of same AgentType and mark degraded if used.</span>
<span class="sd">                            # Audit event: fallback</span>
<span class="sd">                            try:</span>
<span class="sd">                                if bool(self.config.get(&quot;agent_orchestration.diagnostics.enabled&quot;, False)):</span>
<span class="sd">                                    import time as _t</span>
<span class="sd">                                    ev = {&quot;ts&quot;: _t.time(), &quot;event&quot;: &quot;fallback&quot;, &quot;from&quot;: getattr(unhealthy, &quot;name&quot;, None), &quot;to&quot;: getattr(backup, &quot;name&quot;, None)}</span>
<span class="sd">                                    self._ao_events.append(ev); self._ao_events = self._ao_events[-500:]</span>
<span class="sd">                            except Exception:</span>
<span class="sd">                                pass</span>

<span class="sd">                        Returns True if a fallback path was found.</span>
<span class="sd">                        &quot;&quot;&quot;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentRegistry</span>

                            <span class="n">reg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_agent_registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">AgentRegistry</span><span class="p">):</span>
                                <span class="k">return</span> <span class="kc">False</span>
                            <span class="c1"># Find healthy agents of same type excluding same instance</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">unhealthy</span><span class="o">.</span><span class="n">agent_id</span><span class="o">.</span><span class="n">type</span>
                            <span class="n">backups</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="n">a</span>
                                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">reg</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">agent_id</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">t</span>
                                <span class="ow">and</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">unhealthy</span>
                                <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">_running</span>
                                <span class="ow">and</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">_degraded</span>
                            <span class="p">]</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">backups</span><span class="p">:</span>
                                <span class="k">return</span> <span class="kc">False</span>
                            <span class="c1"># Pick first backup; mark degraded path on unhealthy agent</span>
                            <span class="n">backup</span> <span class="o">=</span> <span class="n">backups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">unhealthy</span><span class="o">.</span><span class="n">set_degraded</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                            <span class="c1"># Record fallback metric</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_fallbacks_total</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_fallbacks_total&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s2">&quot;Fallback activated for </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">unhealthy</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="n">backup</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="k">return</span> <span class="kc">True</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="p">,</span> <span class="n">AgentRegistry</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">set_fallback_callback</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">_fallback_route</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                        <span class="p">)</span>  <span class="c1"># type: ignore</span>

                    <span class="c1"># Periodic failure detection scheduling (configurable)</span>
                    <span class="n">fd_enabled</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.monitoring.failure_detection_enabled&quot;</span><span class="p">,</span>
                            <span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">fd_interval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.monitoring.failure_detection_interval&quot;</span><span class="p">,</span>
                            <span class="nb">max</span><span class="p">(</span>
                                <span class="mf">5.0</span><span class="p">,</span>
                                <span class="nb">float</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                        <span class="s2">&quot;agent_orchestration.monitoring.health_check_interval&quot;</span><span class="p">,</span>
                                        <span class="mi">15</span><span class="p">,</span>
                                    <span class="p">)</span>
                                <span class="p">),</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">diag_enabled</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">fd_enabled</span> <span class="ow">and</span> <span class="n">diag_enabled</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_failure_detection_loop</span><span class="p">(</span><span class="n">fd_interval</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Auto-register built-in proxies if enabled</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use validated config if available, otherwise fall back to raw config</span>
                <span class="n">auto_register_enabled</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validated_config</span><span class="p">:</span>
                    <span class="n">auto_register_enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validated_config</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">auto_register</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">auto_register_enabled</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.agents.auto_register&quot;</span><span class="p">,</span> <span class="kc">False</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">auto_register_enabled</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

                    <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.proxies</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                        <span class="n">InputProcessorAgentProxy</span><span class="p">,</span>
                        <span class="n">NarrativeGeneratorAgentProxy</span><span class="p">,</span>
                        <span class="n">WorldBuilderAgentProxy</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">def</span><span class="w"> </span><span class="nf">_inst</span><span class="p">(</span><span class="n">agent_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;Get instance name for agent, using validated config if available.&quot;&quot;&quot;</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validated_config</span><span class="p">:</span>
                            <span class="n">agent_config</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_validated_config</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">get_agent_config</span><span class="p">(</span>
                                    <span class="n">agent_type</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">agent_config</span> <span class="ow">and</span> <span class="n">agent_config</span><span class="o">.</span><span class="n">instance</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">agent_config</span><span class="o">.</span><span class="n">instance</span>

                        <span class="c1"># Fallback to raw config</span>
                        <span class="n">explicit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;agent_orchestration.agents.</span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">.instance&quot;</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">explicit</span><span class="p">:</span>
                            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">explicit</span><span class="p">)</span>

                        <span class="c1"># Auto-generate instance name</span>
                        <span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
                        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
                        <span class="n">sid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
                        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="k">def</span><span class="w"> </span><span class="nf">_should_register_agent</span><span class="p">(</span><span class="n">agent_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;Check if agent should be auto-registered based on validated config.&quot;&quot;&quot;</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validated_config</span><span class="p">:</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validated_config</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">is_auto_registration_enabled</span><span class="p">(</span>
                                <span class="n">agent_type</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Fallback to raw config - both enabled and auto_register_enabled must be true</span>
                            <span class="n">enabled</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;agent_orchestration.agents.</span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">.enabled&quot;</span><span class="p">,</span>
                                    <span class="kc">False</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            <span class="n">auto_reg</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;agent_orchestration.agents.</span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">.auto_register_enabled&quot;</span><span class="p">,</span>
                                    <span class="kc">False</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            <span class="k">return</span> <span class="n">enabled</span> <span class="ow">and</span> <span class="n">auto_reg</span>

                    <span class="c1"># Register Input Processor Agent</span>
                    <span class="k">if</span> <span class="n">_should_register_agent</span><span class="p">(</span><span class="s2">&quot;input_processor&quot;</span><span class="p">):</span>
                        <span class="n">ipa</span> <span class="o">=</span> <span class="n">InputProcessorAgentProxy</span><span class="p">(</span>
                            <span class="n">coordinator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_message_coordinator</span><span class="p">,</span>
                            <span class="n">instance</span><span class="o">=</span><span class="n">_inst</span><span class="p">(</span><span class="s2">&quot;input_processor&quot;</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                            <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">ipa</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ipa</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">ipa</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ipa</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Auto-registered Input Processor Agent&quot;</span><span class="p">)</span>

                    <span class="c1"># Register World Builder Agent</span>
                    <span class="k">if</span> <span class="n">_should_register_agent</span><span class="p">(</span><span class="s2">&quot;world_builder&quot;</span><span class="p">):</span>
                        <span class="n">wba</span> <span class="o">=</span> <span class="n">WorldBuilderAgentProxy</span><span class="p">(</span>
                            <span class="n">coordinator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_message_coordinator</span><span class="p">,</span>
                            <span class="n">instance</span><span class="o">=</span><span class="n">_inst</span><span class="p">(</span><span class="s2">&quot;world_builder&quot;</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                            <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">wba</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">wba</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">wba</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">wba</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Auto-registered World Builder Agent&quot;</span><span class="p">)</span>

                    <span class="c1"># Register Narrative Generator Agent</span>
                    <span class="k">if</span> <span class="n">_should_register_agent</span><span class="p">(</span><span class="s2">&quot;narrative_generator&quot;</span><span class="p">):</span>
                        <span class="n">nga</span> <span class="o">=</span> <span class="n">NarrativeGeneratorAgentProxy</span><span class="p">(</span>
                            <span class="n">coordinator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_message_coordinator</span><span class="p">,</span>
                            <span class="n">instance</span><span class="o">=</span><span class="n">_inst</span><span class="p">(</span><span class="s2">&quot;narrative_generator&quot;</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                            <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">nga</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">nga</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">nga</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">nga</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Auto-registered Narrative Generator Agent&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Auto-registration of agents failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

            <span class="c1"># Initialize the main AgentOrchestrationService</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentOrchestrationService</span>

                <span class="c1"># Get therapeutic validator if available</span>
                <span class="n">therapeutic_validator</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_safety_service&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="c1"># Get optimization engine if available</span>
                <span class="n">optimization_engine</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_optimization_engine&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="c1"># Initialize the service with all components</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_orchestration_service</span> <span class="o">=</span> <span class="n">AgentOrchestrationService</span><span class="p">(</span>
                    <span class="n">workflow_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_workflow_manager</span><span class="p">,</span>
                    <span class="n">message_coordinator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_message_coordinator</span><span class="p">,</span>
                    <span class="n">agent_registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="p">,</span>
                    <span class="n">therapeutic_validator</span><span class="o">=</span><span class="n">therapeutic_validator</span><span class="p">,</span>
                    <span class="n">resource_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="p">,</span>
                    <span class="n">optimization_engine</span><span class="o">=</span><span class="n">optimization_engine</span><span class="p">,</span>
                    <span class="n">neo4j_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># TODO: Add Neo4j manager when available</span>
                <span class="p">)</span>

                <span class="c1"># Initialize the service asynchronously</span>
                <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orchestration_service</span><span class="o">.</span><span class="n">initialize</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orchestration_service</span><span class="o">.</span><span class="n">initialize</span><span class="p">())</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;AgentOrchestrationService initialized successfully&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize AgentOrchestrationService: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_orchestration_service</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Start diagnostics HTTP endpoint only if explicitly requested</span>
            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">)</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.start_server&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_start_diagnostics_server</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Diagnostics enabled; server not started (agent_orchestration.diagnostics.start_server=false)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Diagnostics server disabled via config (agent_orchestration.diagnostics.enabled=false)&quot;</span>
                <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Agent Orchestration component started; auto-recovery executed&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent Orchestration startup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@log_entry_exit</span>
    <span class="nd">@timing_decorator</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_stop_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop the orchestration service.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>

            <span class="c1"># Cancel metrics task if running</span>
            <span class="n">mt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_metrics_task&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mt</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mt</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="c1"># Stop diagnostics server if started</span>
            <span class="n">server</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_diag_server&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">server</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">server</span><span class="o">.</span><span class="n">should_exit</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type: ignore[attr-defined]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="c1"># Stop resource monitoring</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_resource_manager&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">stop_background_monitoring</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Deregister locally registered agents and stop health/heartbeats</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">reg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_agent_registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reg</span><span class="p">:</span>
                    <span class="c1"># Attempt to gracefully stop each known local agent, then deregister and delete Redis keys</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_asyncio</span>

                        <span class="n">agents_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">loop</span> <span class="o">=</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                            <span class="n">loop</span> <span class="o">=</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
                            <span class="n">_asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
                        <span class="c1"># Stop agents</span>
                        <span class="k">if</span> <span class="n">agents_list</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                                <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents_list</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">fut</span> <span class="o">=</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span>
                                            <span class="n">agent</span><span class="o">.</span><span class="n">stop</span><span class="p">(),</span> <span class="n">loop</span>
                                        <span class="p">)</span>
                                        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                        <span class="k">pass</span>
                                <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                        <span class="k">pass</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents_list</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">stop</span><span class="p">())</span>
                                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                        <span class="k">pass</span>
                        <span class="c1"># Deregister and ensure Redis deletion when applicable</span>
                        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents_list</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">reg</span><span class="o">.</span><span class="n">deregister</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">agent_id</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.registries</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                                <span class="n">RedisAgentRegistry</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                            <span class="p">)</span>

                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RedisAgentRegistry</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                                <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents_list</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                                            <span class="n">fut</span> <span class="o">=</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span>
                                                <span class="n">reg</span><span class="o">.</span><span class="n">_delete</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">agent_id</span><span class="p">),</span> <span class="n">loop</span>
                                            <span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                                <span class="k">pass</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span>
                                                <span class="n">reg</span><span class="o">.</span><span class="n">_delete</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">agent_id</span><span class="p">)</span>
                                            <span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
                                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                        <span class="k">pass</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="c1"># Stop health checks and heartbeats (Redis)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">reg</span><span class="o">.</span><span class="n">stop_periodic_health_checks</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.registries</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                            <span class="n">RedisAgentRegistry</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RedisAgentRegistry</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                            <span class="n">reg</span><span class="o">.</span><span class="n">stop_heartbeats</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Shutdown the orchestration service</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_orchestration_service&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orchestration_service</span>
                <span class="p">):</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                        <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orchestration_service</span><span class="o">.</span><span class="n">shutdown</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orchestration_service</span><span class="o">.</span><span class="n">shutdown</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;AgentOrchestrationService shutdown complete&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error shutting down orchestration service: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Close Redis client</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                        <span class="c1"># Schedule close and wait briefly</span>
                        <span class="n">fut</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="o">.</span><span class="n">aclose</span><span class="p">(),</span> <span class="n">loop</span>
                        <span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="o">.</span><span class="n">aclose</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Agent Orchestration component stopped&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="AgentOrchestrationComponent.get_service">
<a class="viewcode-back" href="../../../api/src.components.agent_orchestration_component.html#src.components.AgentOrchestrationComponent.get_service">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_service</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the main AgentOrchestrationService instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            AgentOrchestrationService: The main orchestration service, or None if not initialized</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_orchestration_service&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_poll_queue_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run periodic polling loop (5s) to update gauges and perform threshold checks.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poll_queue_metrics_once</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Queue metrics polling encountered an error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_poll_queue_metrics_once</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Single-cycle polling to update metrics and run threshold checks.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentType</span>

        <span class="n">coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_coordinator</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">coord</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Thresholds (basic foundation)</span>
        <span class="n">dlq_warn_threshold</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.metrics.dlq_warn_threshold&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">retry_spike_warn_threshold</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;agent_orchestration.metrics.retry_spike_warn_threshold&quot;</span><span class="p">,</span> <span class="mi">20</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">prev_snapshot</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_prev_metrics_snapshot&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Scan instances and update gauges</span>
        <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="p">(</span><span class="n">AgentType</span><span class="o">.</span><span class="n">IPA</span><span class="p">,</span> <span class="n">AgentType</span><span class="o">.</span><span class="n">WBA</span><span class="p">,</span> <span class="n">AgentType</span><span class="o">.</span><span class="n">NGA</span><span class="p">):</span>
            <span class="c1"># 1) Queue audit lists pattern</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="o">.</span><span class="n">scan_iter</span><span class="p">(</span>
                <span class="n">match</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ao:queue:</span><span class="si">{</span><span class="n">at</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">:*&quot;</span>
            <span class="p">):</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">))</span> <span class="k">else</span> <span class="n">key</span>
                <span class="n">inst</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">agent_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">at</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">inst</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="c1"># Audit list overall length (priority 0)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">qlen</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="o">.</span><span class="n">llen</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">coord</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">set_queue_length</span><span class="p">(</span>
                        <span class="n">agent_key</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">qlen</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># DLQ gauge</span>
                <span class="n">dlq_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ao:dlq:</span><span class="si">{</span><span class="n">at</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">inst</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dlq_len</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="o">.</span><span class="n">llen</span><span class="p">(</span><span class="n">dlq_key</span><span class="p">)</span>
                    <span class="n">coord</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">set_dlq_length</span><span class="p">(</span><span class="n">agent_key</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">dlq_len</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">dlq_len</span> <span class="ow">and</span> <span class="n">dlq_len</span> <span class="o">&gt;=</span> <span class="n">dlq_warn_threshold</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;DLQ length threshold exceeded for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> &gt;= </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">agent_key</span><span class="p">,</span>
                            <span class="n">dlq_len</span><span class="p">,</span>
                            <span class="n">dlq_warn_threshold</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="c1"># 2) Per-priority ready queue sizes (zsets)  independent scan in case audit list absent</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">skey_b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="o">.</span><span class="n">scan_iter</span><span class="p">(</span>
                <span class="n">match</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ao:sched:</span><span class="si">{</span><span class="n">at</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">:*:prio:*&quot;</span>
            <span class="p">):</span>
                <span class="n">skey</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">skey_b</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">skey_b</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">))</span>
                    <span class="k">else</span> <span class="n">skey_b</span>
                <span class="p">)</span>
                <span class="c1"># skey format: ao:sched:{type}:{inst}:prio:{prio}</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">skey</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">inst</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">prio</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">agent_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">at</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">inst</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">plen</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="o">.</span><span class="n">zcard</span><span class="p">(</span><span class="n">skey</span><span class="p">)</span>
                        <span class="n">coord</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">set_queue_length</span><span class="p">(</span>
                            <span class="n">agent_key</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">prio</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">plen</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

        <span class="c1"># Retry spike detection based on total retries scheduled delta</span>
        <span class="n">snap</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">prev_snapshot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prev_retries</span> <span class="o">=</span> <span class="n">prev_snapshot</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;retry&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;total_retries_scheduled&quot;</span><span class="p">,</span> <span class="mi">0</span>
            <span class="p">)</span>
            <span class="n">cur_retries</span> <span class="o">=</span> <span class="n">snap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;retry&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_retries_scheduled&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cur_retries</span> <span class="o">-</span> <span class="n">prev_retries</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">retry_spike_warn_threshold</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Retry spike detected: +</span><span class="si">%s</span><span class="s2"> &gt;= </span><span class="si">%s</span><span class="s2"> in last interval&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">cur_retries</span> <span class="o">-</span> <span class="n">prev_retries</span><span class="p">),</span>
                    <span class="n">retry_spike_warn_threshold</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prev_metrics_snapshot</span> <span class="o">=</span> <span class="n">snap</span>
        <span class="c1"># Simple audit log of restart/fallback events (diagnostics-gated)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ao_events</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_diagnostics_app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a simple FastAPI app for diagnostics and metrics.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">WebSocket</span><span class="p">,</span> <span class="n">WebSocketDisconnect</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Agent Orchestration Diagnostics&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;0.1.0&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize tools configuration; lazily create Redis clients per-request to avoid cross-loop issues</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

            <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.policy_config</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">load_tool_policy_config</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_tools_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.tools&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="c1"># Provide a registry for programmatic use (same loop as caller)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">redis.asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">aioredis</span>

            <span class="n">redis_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;player_experience.api.redis_url&quot;</span><span class="p">,</span> <span class="s2">&quot;redis://localhost:6379/0&quot;</span>
            <span class="p">)</span>
            <span class="n">rclient</span> <span class="o">=</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">redis_url</span><span class="p">)</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.coordinator</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolCoordinator</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolPolicy</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.redis_tool_registry</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">RedisToolRegistry</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_tool_registry</span> <span class="o">=</span> <span class="n">RedisToolRegistry</span><span class="p">(</span>
                <span class="n">rclient</span><span class="p">,</span>
                <span class="n">key_prefix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tools_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;redis_key_prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;ao&quot;</span><span class="p">)),</span>
                <span class="n">cache_ttl_s</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tools_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache_ttl_s&quot;</span><span class="p">,</span> <span class="mf">300.0</span><span class="p">)),</span>
                <span class="n">cache_max_items</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tools_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache_max_items&quot;</span><span class="p">,</span> <span class="mi">512</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="c1"># Build policy from centralized loader (file/env), merging allowed_callables from tools cfg for back-compat</span>
            <span class="n">base_cfg</span> <span class="o">=</span> <span class="n">load_tool_policy_config</span><span class="p">()</span>
            <span class="n">extra_allow</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tools_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_callables&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="n">extra_allow</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">merged</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">base_cfg</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                    <span class="n">merged_allow</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">set</span><span class="p">((</span><span class="n">merged</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;callable_allowlist&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span> <span class="o">+</span> <span class="n">extra_allow</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;callable_allowlist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_allow</span>
                    <span class="c1"># Reconstruct model</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.policy_config</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                        <span class="n">ToolPolicyConfig</span> <span class="k">as</span> <span class="n">_TPC</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">base_cfg</span> <span class="o">=</span> <span class="n">_TPC</span><span class="p">(</span><span class="o">**</span><span class="n">merged</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span> <span class="o">=</span> <span class="n">ToolPolicy</span><span class="p">(</span>
                <span class="n">config</span><span class="o">=</span><span class="n">base_cfg</span><span class="p">,</span>
                <span class="n">max_schema_depth</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tools_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_schema_depth&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tool_coordinator</span> <span class="o">=</span> <span class="n">ToolCoordinator</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tool_registry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span>
            <span class="p">)</span>
            <span class="c1"># Policy live-reload watcher setup (optional)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_policy_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_policy_reload_audit</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of {ts, ok, source, error?}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_policy_cfg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TTA_TOOL_POLICY_CONFIG&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_policy_cfg_mtime</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy_cfg_path</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;agent_orchestration.diagnostics.policy_live_reload_enabled&quot;</span><span class="p">,</span> <span class="kc">False</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_t</span>

                    <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.policy_config</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                        <span class="n">ToolPolicyConfig</span> <span class="k">as</span> <span class="n">_TPC</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.policy_config</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                        <span class="n">_load_from_file</span><span class="p">,</span>
                        <span class="n">validate_tool_policy_config</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">def</span><span class="w"> </span><span class="nf">_watcher</span><span class="p">():</span>
                        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">_t</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span>
                                    <span class="nb">float</span><span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                            <span class="s2">&quot;agent_orchestration.diagnostics.policy_live_reload_interval_s&quot;</span><span class="p">,</span>
                                            <span class="mf">2.0</span><span class="p">,</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_policy_cfg_path</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="n">mtime</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">if</span> <span class="n">mtime</span> <span class="ow">and</span> <span class="n">mtime</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy_cfg_mtime</span><span class="p">:</span>
                                    <span class="c1"># attempt reload with validation</span>
                                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">raw</span> <span class="o">=</span> <span class="n">_load_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_policy_cfg_path</span><span class="p">)</span>
                                        <span class="n">v_ok</span><span class="p">,</span> <span class="n">v_err</span> <span class="o">=</span> <span class="n">validate_tool_policy_config</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">v_ok</span><span class="p">:</span>
                                            <span class="n">err</span> <span class="o">=</span> <span class="n">v_err</span> <span class="ow">or</span> <span class="s2">&quot;validation_failed&quot;</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">new_cfg</span> <span class="o">=</span> <span class="n">_TPC</span><span class="p">(</span><span class="o">**</span><span class="n">raw</span><span class="p">)</span>
                                            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy_lock</span><span class="p">:</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">new_cfg</span>
                                                <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_policy_cfg_mtime</span> <span class="o">=</span> <span class="n">mtime</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                        <span class="n">err</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                                    <span class="c1"># audit (rate-limited logging)</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_policy_reload_audit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                            <span class="p">{</span>
                                                <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">_t</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                                                <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="n">ok</span><span class="p">,</span>
                                                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy_cfg_path</span><span class="p">,</span>
                                                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">err</span><span class="p">,</span>
                                            <span class="p">}</span>
                                        <span class="p">)</span>
                                        <span class="c1"># keep last 10</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_policy_reload_audit</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_policy_reload_audit</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>
                                        <span class="p">)</span>
                                        <span class="c1"># log at most once per change to avoid noisy loops on malformed files</span>
                                        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                                <span class="s2">&quot;Policy live-reload applied from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_policy_cfg_path</span><span class="p">,</span>
                                            <span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="c1"># do not spam warnings repeatedly for same mtime; single audit is enough</span>
                                            <span class="k">pass</span>
                                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                        <span class="k">pass</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="c1"># swallow to keep thread alive</span>
                                <span class="k">continue</span>

                    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_watcher</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tool_registry</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tool_coordinator</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_make_request_local_registry</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">redis.asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">aioredis</span>

                <span class="n">redis_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;player_experience.api.redis_url&quot;</span><span class="p">,</span> <span class="s2">&quot;redis://localhost:6379/0&quot;</span>
                <span class="p">)</span>
                <span class="n">rclient</span> <span class="o">=</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">redis_url</span><span class="p">)</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.redis_tool_registry</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">RedisToolRegistry</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">return</span> <span class="n">RedisToolRegistry</span><span class="p">(</span>
                    <span class="n">rclient</span><span class="p">,</span>
                    <span class="n">key_prefix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tools_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;redis_key_prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;ao&quot;</span><span class="p">)),</span>
                    <span class="n">cache_ttl_s</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tools_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache_ttl_s&quot;</span><span class="p">,</span> <span class="mf">300.0</span><span class="p">)),</span>
                    <span class="n">cache_max_items</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tools_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache_max_items&quot;</span><span class="p">,</span> <span class="mi">512</span><span class="p">)),</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Create a shared invocation service for app usage</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.callable_registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">CallableRegistry</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.invocation_service</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">ToolInvocationService</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">_call_registry</span> <span class="o">=</span> <span class="n">CallableRegistry</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_callable_registry</span> <span class="o">=</span> <span class="n">_call_registry</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">default_resolver</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">_call_registry</span><span class="o">.</span><span class="n">resolve_callable</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_tool_invocation</span> <span class="o">=</span> <span class="n">ToolInvocationService</span><span class="p">(</span>
                <span class="n">registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_registry</span><span class="p">,</span>
                <span class="n">coordinator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_coordinator</span><span class="p">,</span>
                <span class="n">policy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">,</span>
                <span class="n">callable_resolver</span><span class="o">=</span><span class="n">default_resolver</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tool_invocation</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">ready</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_coordinator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span> <span class="k">if</span> <span class="n">ready</span> <span class="k">else</span> <span class="s2">&quot;initializing&quot;</span><span class="p">,</span>
                <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;agent_orchestration&quot;</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/metrics&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">metrics</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_coordinator</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">coord</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;coordinator not initialized&quot;</span><span class="p">}</span>
            <span class="n">snap</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">snap</span><span class="p">}</span>
            <span class="c1"># Back-compat: expose top-level delivery/retry/gauges keys for simple checks</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;delivery&quot;</span><span class="p">:</span> <span class="n">snap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;delivery&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                        <span class="s2">&quot;retry&quot;</span><span class="p">:</span> <span class="n">snap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;retry&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                        <span class="s2">&quot;gauges&quot;</span><span class="p">:</span> <span class="n">snap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gauges&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Add workflow failure/rollback/state validation metrics when enabled</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="p">)</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.error_handling.enabled&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_workflow_monitor&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="c1"># Ensure most up-to-date counters by performing a one-shot timeout scan</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_monitor</span><span class="o">.</span><span class="n">check_timeouts_once</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">wf_metrics</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_monitor</span><span class="o">.</span><span class="n">metrics_snapshot</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;workflow&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wf_metrics</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Add policy snapshot (redacted)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.policy_config</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">redact_policy_config_dict</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">pol_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pol_cfg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">redact_policy_config_dict</span><span class="p">(</span><span class="n">pol_cfg</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># legacy fields only</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">redact_policy_config_dict</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;callable_allowlist&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">,</span> <span class="s2">&quot;allowed_callables&quot;</span><span class="p">,</span> <span class="p">[])</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;allow_network_tools&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">,</span> <span class="s2">&quot;allow_network_tools&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;allow_filesystem_tools&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span>
                                <span class="nb">getattr</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">,</span> <span class="s2">&quot;allow_filesystem_tools&quot;</span><span class="p">,</span> <span class="kc">False</span>
                                <span class="p">)</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;allow_process_tools&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">,</span> <span class="s2">&quot;allow_process_tools&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                            <span class="p">),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Aggregate performance metrics (per-agent step stats)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.performance</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_step_aggregator</span>

                <span class="n">perf_snap</span> <span class="o">=</span> <span class="n">get_step_aggregator</span><span class="p">()</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;performance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">perf_snap</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Tools summary and metrics</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">reg</span> <span class="o">=</span> <span class="n">_make_request_local_registry</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_tool_registry&quot;</span><span class="p">,</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">reg</span><span class="p">:</span>
                    <span class="n">tool_ids</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reg</span><span class="o">.</span><span class="n">list_tool_ids</span><span class="p">()</span>
                    <span class="n">cache_stats</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reg</span><span class="o">.</span><span class="n">cache_stats</span><span class="p">()</span>
                    <span class="c1"># summarize status counts</span>
                    <span class="n">active</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">deprecated</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">tool_ids</span><span class="p">:</span>
                        <span class="n">nm</span><span class="p">,</span> <span class="n">ver</span> <span class="o">=</span> <span class="n">tid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">st</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reg</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">st</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">:</span>
                            <span class="n">active</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">deprecated</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;tools&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">tool_ids</span><span class="p">),</span>
                        <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">active</span><span class="p">,</span>
                        <span class="s2">&quot;deprecated&quot;</span><span class="p">:</span> <span class="n">deprecated</span><span class="p">,</span>
                        <span class="s2">&quot;cache&quot;</span><span class="p">:</span> <span class="n">cache_stats</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="c1"># attach per-tool execution stats</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                            <span class="n">get_tool_metrics</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;tool_exec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_tool_metrics</span><span class="p">()</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Resource usage snapshot</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_resource_manager&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">rep</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="o">.</span><span class="n">monitor_usage</span><span class="p">()</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">rep</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                        <span class="s2">&quot;usage&quot;</span><span class="p">:</span> <span class="n">rep</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span>
                        <span class="s2">&quot;thresholds&quot;</span><span class="p">:</span> <span class="n">rep</span><span class="o">.</span><span class="n">thresholds_exceeded</span><span class="p">,</span>
                    <span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Agent registry snapshot if available (sync)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentRegistry</span>  <span class="c1"># type: ignore</span>

                <span class="n">reg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_agent_registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reg</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">AgentRegistry</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/agents&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">agents</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Agent registry snapshot with derived performance and heartbeat age.</span>
<span class="sd">            Returns merged local and Redis-discovered agents when RedisAgentRegistry is used.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_agent_registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reg</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;agent registry not initialized&quot;</span><span class="p">}</span>
            <span class="c1"># Gather base snapshot</span>
            <span class="n">local_snap</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
            <span class="n">redis_index</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.registries</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">RedisAgentRegistry</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RedisAgentRegistry</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                    <span class="n">redis_index</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reg</span><span class="o">.</span><span class="n">list_registered</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Attach recent failure/recovery events if diagnostics enabled</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">events</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_ao_events&quot;</span><span class="p">,</span> <span class="p">[]))</span>
                    <span class="n">local_snap</span><span class="p">[</span><span class="s2">&quot;_events&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Derived perf metrics from aggregator keyed by type:instance</span>
            <span class="n">perf</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.performance</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_step_aggregator</span>

                <span class="n">perf</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">get_step_aggregator</span><span class="p">()</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
                <span class="p">)</span>  <span class="c1"># { &quot;ipa:worker-1&quot;: {p50,p95,avg,error_rate}, ... }</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Attach perf metrics to local agents</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">local_snap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">agent_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;agent_id&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;agent_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instance&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">agent_key</span> <span class="o">=</span> <span class="n">name</span>
                <span class="k">if</span> <span class="n">agent_key</span> <span class="ow">in</span> <span class="n">perf</span><span class="p">:</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;performance&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="n">agent_key</span><span class="p">])</span>
            <span class="c1"># Add last_heartbeat_age to redis_index entries</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">redis_index</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_heartbeat&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;last_heartbeat_age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">now</span> <span class="o">-</span> <span class="n">hb</span><span class="p">)</span>
                    <span class="c1"># merge perf if available</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">aid</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_id&quot;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="n">ak</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">aid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">aid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instance&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">if</span> <span class="n">ak</span> <span class="ow">in</span> <span class="n">perf</span><span class="p">:</span>
                            <span class="n">entry</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;performance&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="n">ak</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;last_heartbeat_age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;local&quot;</span><span class="p">:</span> <span class="n">local_snap</span><span class="p">,</span> <span class="s2">&quot;redis_index&quot;</span><span class="p">:</span> <span class="n">redis_index</span><span class="p">}</span>

        <span class="c1"># Place metrics-prom endpoint late, but not last; tests will refer to it explicitly when applicable</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/metrics-prom&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">metrics_prometheus</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Export Prometheus metrics.&quot;&quot;&quot;</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_coordinator</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">coord</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;# coordinator not initialized</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">prometheus_client</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">CollectorRegistry</span><span class="p">,</span>
                    <span class="n">Counter</span><span class="p">,</span>
                    <span class="n">Gauge</span><span class="p">,</span>
                    <span class="n">Histogram</span><span class="p">,</span>
                    <span class="n">Summary</span><span class="p">,</span>
                    <span class="n">generate_latest</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;# prometheus_client not available</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="c1"># Create a registry and map our metrics</span>
            <span class="n">prom_reg</span> <span class="o">=</span> <span class="n">CollectorRegistry</span><span class="p">()</span>
            <span class="c1"># Counters</span>
            <span class="n">c_ok</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
                <span class="s2">&quot;agent_orchestration_messages_delivered_total&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Total successful deliveries&quot;</span><span class="p">,</span>
                <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">c_err</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
                <span class="s2">&quot;agent_orchestration_messages_delivery_errors_total&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Total delivery errors&quot;</span><span class="p">,</span>
                <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">c_retry</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
                <span class="s2">&quot;agent_orchestration_message_retries_total&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Total retries scheduled&quot;</span><span class="p">,</span>
                <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">c_perm</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
                <span class="s2">&quot;agent_orchestration_message_permanent_failures_total&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Total permanent failures&quot;</span><span class="p">,</span>
                <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Gauges</span>
            <span class="n">g_queue</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
                <span class="s2">&quot;agent_orchestration_queue_length&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Queue length&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="s2">&quot;priority&quot;</span><span class="p">],</span>
                <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">g_dlq</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
                <span class="s2">&quot;agent_orchestration_dlq_length&quot;</span><span class="p">,</span>
                <span class="s2">&quot;DLQ length&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="s2">&quot;agent&quot;</span><span class="p">],</span>
                <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Summary for backoff delays</span>
            <span class="n">s_backoff</span> <span class="o">=</span> <span class="n">Summary</span><span class="p">(</span>
                <span class="s2">&quot;agent_orchestration_backoff_seconds&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Backoff delay seconds&quot;</span><span class="p">,</span>
                <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Performance metrics: histogram for durations, gauge for error rate</span>
            <span class="n">h_step_duration</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
                <span class="s2">&quot;agent_orchestration_step_duration_ms&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Workflow step duration in ms&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="s2">&quot;agent&quot;</span><span class="p">],</span>
                <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
                <span class="n">buckets</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">3200</span><span class="p">,</span> <span class="mi">6400</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">g_step_error_rate</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
                <span class="s2">&quot;agent_orchestration_step_error_rate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Workflow step error rate (0..1)&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="s2">&quot;agent&quot;</span><span class="p">],</span>
                <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Agent health metrics (gated by diagnostics)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.agents</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                        <span class="n">AgentRegistry</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                    <span class="p">)</span>

                    <span class="n">reg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_agent_registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">unhealthy</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">reg</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">AgentRegistry</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                        <span class="n">snap_agents</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
                        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">snap_agents</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">snap_agents</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">st</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;IDLE&quot;</span><span class="p">,</span> <span class="s2">&quot;BUSY&quot;</span><span class="p">,</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span> <span class="s2">&quot;initializing&quot;</span><span class="p">):</span>
                                <span class="n">unhealthy</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># Expose as a gauge</span>
                    <span class="n">g_unhealthy</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
                        <span class="s2">&quot;agent_orchestration_agents_unhealthy&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Number of unhealthy agents&quot;</span><span class="p">,</span>
                        <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">g_unhealthy</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">unhealthy</span><span class="p">)</span>
                    <span class="c1"># Counters for restarts/fallbacks would be incremented where events occur; we expose here if tracked.</span>
                    <span class="c1"># For now, we store totals on self and increment when restart/fallback happen.</span>
                    <span class="n">restarts_total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_restarts_total&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">fallbacks_total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_fallbacks_total&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">c_restarts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
                        <span class="s2">&quot;agent_orchestration_agents_restarts_total&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Total agent restarts attempted&quot;</span><span class="p">,</span>
                        <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">c_fallbacks</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
                        <span class="s2">&quot;agent_orchestration_agents_fallbacks_total&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Total agent fallbacks attempted&quot;</span><span class="p">,</span>
                        <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># Increment to absolute values (counter inc by delta)</span>
                    <span class="n">last_rf</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_prom_last_rf&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;restarts&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fallbacks&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                    <span class="p">)</span>
                    <span class="n">inc_r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">restarts_total</span> <span class="o">-</span> <span class="n">last_rf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restarts&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">inc_f</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fallbacks_total</span> <span class="o">-</span> <span class="n">last_rf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fallbacks&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">inc_r</span><span class="p">:</span>
                        <span class="n">c_restarts</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">inc_r</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">inc_f</span><span class="p">:</span>
                        <span class="n">c_fallbacks</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">inc_f</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prom_last_rf</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;restarts&quot;</span><span class="p">:</span> <span class="n">restarts_total</span><span class="p">,</span>
                        <span class="s2">&quot;fallbacks&quot;</span><span class="p">:</span> <span class="n">fallbacks_total</span><span class="p">,</span>
                    <span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Message metrics</span>
            <span class="n">snap</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>

            <span class="c1"># Tool metrics</span>
            <span class="n">tool_exec</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tool_cache</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;misses&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_tool_metrics</span>

                <span class="n">tool_exec</span> <span class="o">=</span> <span class="n">get_tool_metrics</span><span class="p">()</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">reg</span> <span class="o">=</span> <span class="n">_make_request_local_registry</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_tool_registry&quot;</span><span class="p">,</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">reg</span><span class="p">:</span>
                    <span class="n">tool_cache</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reg</span><span class="o">.</span><span class="n">cache_stats</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Set counters (note: prometheus_client counters can only inc; we inc to target absolute on first pass)</span>
            <span class="n">last</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_prom_last&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{</span>
                <span class="s2">&quot;delivery&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;delivered_ok&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;delivered_error&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="s2">&quot;retry&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;total_retries_scheduled&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;total_permanent_failures&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
            <span class="p">}</span>
            <span class="n">inc_ok</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span> <span class="n">snap</span><span class="p">[</span><span class="s2">&quot;delivery&quot;</span><span class="p">][</span><span class="s2">&quot;delivered_ok&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">last</span><span class="p">[</span><span class="s2">&quot;delivery&quot;</span><span class="p">][</span><span class="s2">&quot;delivered_ok&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">inc_err</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">snap</span><span class="p">[</span><span class="s2">&quot;delivery&quot;</span><span class="p">][</span><span class="s2">&quot;delivered_error&quot;</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">last</span><span class="p">[</span><span class="s2">&quot;delivery&quot;</span><span class="p">][</span><span class="s2">&quot;delivered_error&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">inc_retry</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">snap</span><span class="p">[</span><span class="s2">&quot;retry&quot;</span><span class="p">][</span><span class="s2">&quot;total_retries_scheduled&quot;</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">last</span><span class="p">[</span><span class="s2">&quot;retry&quot;</span><span class="p">][</span><span class="s2">&quot;total_retries_scheduled&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">inc_perm</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">snap</span><span class="p">[</span><span class="s2">&quot;retry&quot;</span><span class="p">][</span><span class="s2">&quot;total_permanent_failures&quot;</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">last</span><span class="p">[</span><span class="s2">&quot;retry&quot;</span><span class="p">][</span><span class="s2">&quot;total_permanent_failures&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">inc_ok</span><span class="p">:</span>
                <span class="n">c_ok</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">inc_ok</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inc_err</span><span class="p">:</span>
                <span class="n">c_err</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">inc_err</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inc_retry</span><span class="p">:</span>
                <span class="n">c_retry</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">inc_retry</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inc_perm</span><span class="p">:</span>
                <span class="n">c_perm</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">inc_perm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prom_last</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;delivery&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;delivered_ok&quot;</span><span class="p">:</span> <span class="n">snap</span><span class="p">[</span><span class="s2">&quot;delivery&quot;</span><span class="p">][</span><span class="s2">&quot;delivered_ok&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;delivered_error&quot;</span><span class="p">:</span> <span class="n">snap</span><span class="p">[</span><span class="s2">&quot;delivery&quot;</span><span class="p">][</span><span class="s2">&quot;delivered_error&quot;</span><span class="p">],</span>
                <span class="p">},</span>
                <span class="s2">&quot;retry&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;total_retries_scheduled&quot;</span><span class="p">:</span> <span class="n">snap</span><span class="p">[</span><span class="s2">&quot;retry&quot;</span><span class="p">][</span><span class="s2">&quot;total_retries_scheduled&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;total_permanent_failures&quot;</span><span class="p">:</span> <span class="n">snap</span><span class="p">[</span><span class="s2">&quot;retry&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;total_permanent_failures&quot;</span>
                    <span class="p">],</span>
                <span class="p">},</span>
            <span class="p">}</span>
            <span class="c1"># Gauges: set absolute values</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">snap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gauges&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;queue_lengths&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">agent</span><span class="p">,</span> <span class="n">prio</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                <span class="n">g_queue</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">prio</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">agent</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">snap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gauges&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dlq_lengths&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">g_dlq</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="c1"># Summary: observe last backoff</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s_backoff</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">snap</span><span class="p">[</span><span class="s2">&quot;retry&quot;</span><span class="p">][</span><span class="s2">&quot;last_backoff_seconds&quot;</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Performance metrics from aggregator</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.performance</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_step_aggregator</span>

                <span class="n">perf</span> <span class="o">=</span> <span class="n">get_step_aggregator</span><span class="p">()</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">agent</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">perf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># Observe p95 (approx) and p50 (approx) into histogram; prometheus client will bucket</span>
                    <span class="c1"># Also set error rate gauge per agent</span>
                    <span class="n">g_step_error_rate</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_rate&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="c1"># Observing avg is ok to represent load</span>
                    <span class="n">h_step_duration</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">h_step_duration</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p50&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">h_step_duration</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p95&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Export tool metrics as well (per-tool labels)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">prometheus_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">Histogram</span>

                <span class="n">tool_inv</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
                    <span class="s2">&quot;agent_orchestration_tool_invocations_total&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Tool invocations&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="s2">&quot;tool&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">],</span>
                    <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">tool_ok</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
                    <span class="s2">&quot;agent_orchestration_tool_success_total&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Tool successes&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="s2">&quot;tool&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">],</span>
                    <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">tool_err</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
                    <span class="s2">&quot;agent_orchestration_tool_failure_total&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Tool failures&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="s2">&quot;tool&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">],</span>
                    <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">tool_dur</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
                    <span class="s2">&quot;agent_orchestration_tool_duration_seconds&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Tool execution duration in seconds&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="s2">&quot;tool&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">],</span>
                    <span class="n">registry</span><span class="o">=</span><span class="n">prom_reg</span><span class="p">,</span>
                    <span class="n">buckets</span><span class="o">=</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="c1"># Limit cardinality if configured</span>
                <span class="n">max_tools</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tools_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_prometheus_tools&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_tools_cfg&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="mi">200</span>
                <span class="p">)</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">tool_exec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">max_tools</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;successes&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;failures&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="n">ok</span> <span class="o">+</span> <span class="n">err</span>
                    <span class="c1"># increment counters</span>
                    <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
                        <span class="n">tool_inv</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                        <span class="n">tool_ok</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">tool_err</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="c1"># approximate duration via buckets distribution</span>
                    <span class="n">buckets</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buckets&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">midpoint</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;&lt;10&quot;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>
                        <span class="s2">&quot;10-50&quot;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span>
                        <span class="s2">&quot;50-200&quot;</span><span class="p">:</span> <span class="mf">0.125</span><span class="p">,</span>
                        <span class="s2">&quot;200-1000&quot;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span>
                        <span class="s2">&quot;&gt;=1000&quot;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">buckets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
                            <span class="n">tool_dur</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">midpoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">return</span> <span class="n">generate_latest</span><span class="p">(</span><span class="n">prom_reg</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/routing/preview&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">routing_preview</span><span class="p">(</span>
            <span class="n">agent_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">exclude_degraded</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">show_all_candidates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;diagnostics disabled&quot;</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentType</span>

                <span class="n">at</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">at</span> <span class="o">=</span> <span class="n">AgentType</span><span class="p">(</span><span class="n">agent_type</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># Permit common names</span>
                    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;input_processor&quot;</span><span class="p">:</span> <span class="n">AgentType</span><span class="o">.</span><span class="n">IPA</span><span class="p">,</span>
                        <span class="s2">&quot;world_builder&quot;</span><span class="p">:</span> <span class="n">AgentType</span><span class="o">.</span><span class="n">WBA</span><span class="p">,</span>
                        <span class="s2">&quot;narrative_generator&quot;</span><span class="p">:</span> <span class="n">AgentType</span><span class="o">.</span><span class="n">NGA</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">at</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_type</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid agent_type&quot;</span><span class="p">}</span>
                <span class="n">router</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_agent_router&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">router</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;router not initialized&quot;</span><span class="p">}</span>
                <span class="n">preview</span> <span class="o">=</span> <span class="k">await</span> <span class="n">router</span><span class="o">.</span><span class="n">preview</span><span class="p">(</span>
                    <span class="n">at</span><span class="p">,</span>
                    <span class="n">exclude_degraded</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">exclude_degraded</span><span class="p">),</span>
                    <span class="n">show_all_candidates</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">show_all_candidates</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="c1"># Include configured weights/thresholds for transparency</span>
                <span class="n">rcfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.router&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">preview</span><span class="p">[</span><span class="s2">&quot;configured_weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;queue&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">rcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight_queue&quot;</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">)),</span>
                    <span class="s2">&quot;heartbeat&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">rcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight_heartbeat&quot;</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">)),</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">rcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight_success&quot;</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">)),</span>
                <span class="p">}</span>
                <span class="n">preview</span><span class="p">[</span><span class="s2">&quot;configured_heartbeat_fresh_seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="n">rcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;heartbeat_fresh_seconds&quot;</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># Candidate filtering summary</span>
                <span class="n">reg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_agent_registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">total_agents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="k">if</span> <span class="n">reg</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">total_agents</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">preview</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">preview</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">][</span><span class="s2">&quot;total_agents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_agents</span>
                <span class="c1"># The preview already filters according to exclude_degraded; rest filled by router</span>
                <span class="k">return</span> <span class="n">preview</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="c1"># Admin endpoints for policy management</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Header</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/policy&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">policy_snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.policy_config</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">redact_policy_config_dict</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">pol_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">snap</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;policy&quot;</span><span class="p">:</span> <span class="n">redact_policy_config_dict</span><span class="p">(</span>
                        <span class="n">pol_cfg</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">pol_cfg</span>
                        <span class="k">else</span> <span class="p">{</span>
                            <span class="s2">&quot;callable_allowlist&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">,</span> <span class="s2">&quot;allowed_callables&quot;</span><span class="p">,</span> <span class="p">[])</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;allow_network_tools&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">,</span> <span class="s2">&quot;allow_network_tools&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;allow_filesystem_tools&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span>
                                <span class="nb">getattr</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">,</span> <span class="s2">&quot;allow_filesystem_tools&quot;</span><span class="p">,</span> <span class="kc">False</span>
                                <span class="p">)</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;allow_process_tools&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">,</span> <span class="s2">&quot;allow_process_tools&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                            <span class="p">),</span>
                        <span class="p">}</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;max_params&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tools_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_params&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)),</span>
                        <span class="s2">&quot;max_schema_depth&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_tools_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_schema_depth&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
                        <span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">}</span>
                <span class="c1"># attach audit log</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">snap</span><span class="p">[</span><span class="s2">&quot;reload_audit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_policy_reload_audit&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">return</span> <span class="n">snap</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/policy/reload&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">policy_reload</span><span class="p">(</span>
            <span class="n">x_ao_diag_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;X-AO-DIAG-KEY&quot;</span><span class="p">),</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;diagnostics disabled&quot;</span><span class="p">}</span>
            <span class="c1"># Optional admin key to guard mutation</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.admin_api_key&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_ao_diag_key</span> <span class="o">!=</span> <span class="n">api_key</span><span class="p">):</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>  <span class="c1"># type: ignore</span>

                <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;unauthorized&quot;</span><span class="p">},</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.policy_config</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">ToolPolicyConfig</span> <span class="k">as</span> <span class="n">_TPC</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.policy_config</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">load_tool_policy_config</span><span class="p">,</span>
                    <span class="n">load_tool_policy_config_from</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">cfg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TTA_TOOL_POLICY_CONFIG&quot;</span><span class="p">)</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">cfg_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">):</span>
                    <span class="n">new_cfg</span> <span class="o">=</span> <span class="n">load_tool_policy_config_from</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_cfg</span> <span class="o">=</span> <span class="n">load_tool_policy_config</span><span class="p">()</span>
                <span class="k">with</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_policy_lock&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_cfg</span><span class="p">,</span> <span class="n">_TPC</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">new_cfg</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_policy_cfg_mtime</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">cfg_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">)</span>
                                <span class="k">else</span> <span class="kc">None</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_policy_reload_audit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                            <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="n">ok</span><span class="p">,</span>
                            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">cfg_path</span> <span class="ow">or</span> <span class="s2">&quot;env&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">err</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_policy_reload_audit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy_reload_audit</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">:]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="n">ok</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">cfg_path</span> <span class="ow">or</span> <span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">err</span><span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/policy/validate&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">policy_validate</span><span class="p">(</span>
            <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">x_ao_diag_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;X-AO-DIAG-KEY&quot;</span><span class="p">),</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;diagnostics disabled&quot;</span><span class="p">}</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.admin_api_key&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_ao_diag_key</span> <span class="o">!=</span> <span class="n">api_key</span><span class="p">):</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>  <span class="c1"># type: ignore</span>

                <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;unauthorized&quot;</span><span class="p">},</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.policy_config</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">validate_tool_policy_config</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">ok</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">validate_tool_policy_config</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">payload</span> <span class="ow">or</span> <span class="p">{}))</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="n">ok</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="c1"># --- Workflow rollback endpoints ---</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Header</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/workflows/</span><span class="si">{run_id}</span><span class="s2">/rollback&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">workflows_rollback</span><span class="p">(</span>
            <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">x_ao_diag_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;X-AO-DIAG-KEY&quot;</span><span class="p">),</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="c1"># Respect diagnostics flag and optional admin key</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;diagnostics disabled&quot;</span><span class="p">}</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.admin_api_key&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_ao_diag_key</span> <span class="o">!=</span> <span class="n">api_key</span><span class="p">):</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>  <span class="c1"># type: ignore</span>

                <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;unauthorized&quot;</span><span class="p">},</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.error_handling.enabled&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;error_handling_disabled&quot;</span><span class="p">}</span>
                <span class="n">sp</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">sp</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;savepoint&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sp</span><span class="p">:</span>
                    <span class="n">sp</span> <span class="o">=</span> <span class="s2">&quot;start&quot;</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">redis.asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">aioredis</span>

                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.workflow_transaction</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">WorkflowTransaction</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">redis_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;player_experience.api.redis_url&quot;</span><span class="p">,</span> <span class="s2">&quot;redis://localhost:6379/0&quot;</span>
                <span class="p">)</span>
                <span class="n">rclient</span> <span class="o">=</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">redis_url</span><span class="p">)</span>
                <span class="n">tx</span> <span class="o">=</span> <span class="n">WorkflowTransaction</span><span class="p">(</span>
                    <span class="n">rclient</span><span class="p">,</span>
                    <span class="n">key_prefix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.tools.redis_key_prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;ao&quot;</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tx</span><span class="o">.</span><span class="n">rollback_to</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
                <span class="c1"># Record in audit</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_workflow_monitor&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_monitor</span><span class="o">.</span><span class="n">record_rollback_audit</span><span class="p">(</span>
                            <span class="n">run_id</span><span class="p">,</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;manual_rollback&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;savepoint&quot;</span><span class="p">:</span> <span class="n">sp</span><span class="p">,</span>
                                <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">return</span> <span class="n">res</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/workflows/</span><span class="si">{run_id}</span><span class="s2">/rollback-history&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">workflows_rollback_history</span><span class="p">(</span>
            <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">x_ao_diag_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;X-AO-DIAG-KEY&quot;</span><span class="p">),</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;diagnostics disabled&quot;</span><span class="p">}</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.admin_api_key&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_ao_diag_key</span> <span class="o">!=</span> <span class="n">api_key</span><span class="p">):</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>  <span class="c1"># type: ignore</span>

                <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;unauthorized&quot;</span><span class="p">},</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_workflow_monitor&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">hist</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_monitor</span><span class="o">.</span><span class="n">get_rollback_history</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="n">hist</span><span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="c1"># Safety diagnostics endpoints (optional)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_safety</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_safety_service&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_safety</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.therapeutic_safety</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">get_global_safety_service</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">_safety</span> <span class="o">=</span> <span class="n">get_global_safety_service</span><span class="p">()</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/safety&quot;</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">safety_snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_json</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_t</span>

                    <span class="n">svc</span> <span class="o">=</span> <span class="n">_safety</span>
                    <span class="n">prov</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">svc</span><span class="p">,</span> <span class="s2">&quot;_provider&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">cfg</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="c1"># Compute redis key explicitly from config to avoid provider-key mismatches</span>
                    <span class="n">key_prefix</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;agent_orchestration.tools.redis_key_prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;ao&quot;</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_tools_cfg&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">dict</span><span class="p">)</span>
                        <span class="k">else</span> <span class="nb">str</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.tools&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s2">&quot;redis_key_prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;ao&quot;</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">redis_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key_prefix</span><span class="si">}</span><span class="s2">:safety:rules&quot;</span>
                    <span class="c1"># Use a request-local Redis client bound to the current loop</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">redis.asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">aioredis</span>

                        <span class="n">redis_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;player_experience.api.redis_url&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;redis://localhost:6379/0&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">rclient</span> <span class="o">=</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">redis_url</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">rclient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redis_key</span><span class="p">)</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">await</span> <span class="n">rclient</span><span class="o">.</span><span class="n">aclose</span><span class="p">()</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
                            <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">))</span>
                                <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                            <span class="p">)</span>
                            <span class="n">cfg</span> <span class="o">=</span> <span class="n">_json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                            <span class="c1"># update provider cache for status visibility</span>
                            <span class="k">if</span> <span class="n">prov</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">prov</span><span class="o">.</span><span class="n">_cached_raw</span> <span class="o">=</span> <span class="n">raw</span>
                                    <span class="n">prov</span><span class="o">.</span><span class="n">_cached_at</span> <span class="o">=</span> <span class="n">_t</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                                    <span class="n">prov</span><span class="o">.</span><span class="n">_last_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;redis:</span><span class="si">{</span><span class="n">redis_key</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="k">pass</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">cfg</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="p">:</span>
                        <span class="c1"># Fallback: provider-managed load (invalidate TTL)</span>
                        <span class="k">if</span> <span class="n">prov</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prov</span><span class="p">,</span> <span class="s2">&quot;invalidate&quot;</span><span class="p">):</span>
                            <span class="n">prov</span><span class="o">.</span><span class="n">invalidate</span><span class="p">()</span>
                        <span class="n">cfg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">prov</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span> <span class="k">if</span> <span class="n">prov</span> <span class="k">else</span> <span class="p">{}</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">prov</span><span class="o">.</span><span class="n">status</span><span class="p">()</span> <span class="k">if</span> <span class="n">prov</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prov</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
                    <span class="c1"># Redact content minimally (no secrets expected in rules)</span>
                    <span class="k">return</span> <span class="p">{</span>
                        <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">svc</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">()),</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                        <span class="s2">&quot;rules&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/safety/reload&quot;</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">safety_reload</span><span class="p">(</span>
                <span class="n">x_ao_diag_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;X-AO-DIAG-KEY&quot;</span><span class="p">),</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;diagnostics disabled&quot;</span><span class="p">}</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;agent_orchestration.diagnostics.admin_api_key&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_ao_diag_key</span> <span class="o">!=</span> <span class="n">api_key</span><span class="p">):</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>  <span class="c1"># type: ignore</span>

                    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;unauthorized&quot;</span><span class="p">},</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span>
                    <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_asyncio</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_json</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_t</span>

                    <span class="n">prov</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_safety</span><span class="p">,</span> <span class="s2">&quot;_provider&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_do_reload</span><span class="p">():</span>
                        <span class="c1"># Invalidate TTL cache</span>
                        <span class="k">if</span> <span class="n">prov</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prov</span><span class="p">,</span> <span class="s2">&quot;invalidate&quot;</span><span class="p">):</span>
                            <span class="n">prov</span><span class="o">.</span><span class="n">invalidate</span><span class="p">()</span>
                        <span class="c1"># Read Redis directly and inject into provider cache using explicit key</span>
                        <span class="n">key_prefix</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                    <span class="s2">&quot;agent_orchestration.tools.redis_key_prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;ao&quot;</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_tools_cfg&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">dict</span><span class="p">)</span>
                            <span class="k">else</span> <span class="nb">str</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.tools&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                    <span class="s2">&quot;redis_key_prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;ao&quot;</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">redis_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key_prefix</span><span class="si">}</span><span class="s2">:safety:rules&quot;</span>
                        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_redis_client&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redis_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redis_key</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
                                <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">))</span>
                                    <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                                <span class="p">)</span>
                                <span class="n">_json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                                <span class="n">prov</span><span class="o">.</span><span class="n">_cached_raw</span> <span class="o">=</span> <span class="n">raw</span>
                                <span class="n">prov</span><span class="o">.</span><span class="n">_cached_at</span> <span class="o">=</span> <span class="n">_t</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                                <span class="n">prov</span><span class="o">.</span><span class="n">_last_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;redis:</span><span class="si">{</span><span class="n">redis_key</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="c1"># Force-rebuild validator on next use</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">_safety</span><span class="o">.</span><span class="n">_validator</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>

                    <span class="c1"># Bound the entire reload to 2s</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">_do_reload</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># Timeout or other error: still return ok=True to avoid test hangs; subsequent GET will load lazily</span>
                        <span class="k">pass</span>
                    <span class="c1"># Return immediately without additional awaits</span>
                    <span class="k">return</span> <span class="p">{</span>
                        <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prov</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">{})()</span> <span class="k">if</span> <span class="n">prov</span> <span class="k">else</span> <span class="p">{},</span>
                    <span class="p">}</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># On unexpected errors, keep endpoint stable and non-blocking</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/policy/status&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">policy_status</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pol_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">src</span> <span class="o">=</span> <span class="s2">&quot;env&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

                    <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TTA_TOOL_POLICY_CONFIG&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                        <span class="n">src</span> <span class="o">=</span> <span class="n">p</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">src</span><span class="p">,</span>
                    <span class="s2">&quot;last_reload_ts&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_policy_reload_audit&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[{}])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;ts&quot;</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_policy_reload_audit&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;live_reload&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;agent_orchestration.diagnostics.policy_live_reload_enabled&quot;</span><span class="p">,</span>
                            <span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                <span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/tools&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">tools_endpoint</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="n">_make_request_local_registry</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_tool_registry&quot;</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reg</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;tool registry not initialized&quot;</span><span class="p">}</span>
            <span class="n">tool_ids</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reg</span><span class="o">.</span><span class="n">list_tool_ids</span><span class="p">()</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">tool_ids</span><span class="p">:</span>
                <span class="n">nm</span><span class="p">,</span> <span class="n">ver</span> <span class="o">=</span> <span class="n">tid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">st</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reg</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reg</span><span class="o">.</span><span class="n">get_tool</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">ver</span><span class="p">,</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span>
                        <span class="s2">&quot;last_used_at&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;last_used_at&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">spec</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="n">cache_stats</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reg</span><span class="o">.</span><span class="n">cache_stats</span><span class="p">()</span>
            <span class="n">usage</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_tool_metrics</span>

                <span class="n">usage</span> <span class="o">=</span> <span class="n">get_tool_metrics</span><span class="p">()</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="n">items</span><span class="p">,</span> <span class="s2">&quot;cache&quot;</span><span class="p">:</span> <span class="n">cache_stats</span><span class="p">,</span> <span class="s2">&quot;usage&quot;</span><span class="p">:</span> <span class="n">usage</span><span class="p">}</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/tools/summary&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">tools_summary</span><span class="p">(</span>
            <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
            <span class="n">status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">name_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">sort_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;last_used_at&quot;</span><span class="p">,</span>
            <span class="n">order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;desc&quot;</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="n">_make_request_local_registry</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_tool_registry&quot;</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reg</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;tool registry not initialized&quot;</span><span class="p">}</span>
            <span class="c1"># paging</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">limit</span><span class="p">)))</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
            <span class="n">tool_ids</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reg</span><span class="o">.</span><span class="n">list_tool_ids</span><span class="p">()</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">tool_ids</span><span class="p">:</span>
                <span class="n">nm</span><span class="p">,</span> <span class="n">ver</span> <span class="o">=</span> <span class="n">tid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name_prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">nm</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">name_prefix</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">st</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reg</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">status</span> <span class="ow">and</span> <span class="n">st</span> <span class="o">!=</span> <span class="n">status</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reg</span><span class="o">.</span><span class="n">get_tool</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span>
                <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">nm</span><span class="p">,</span>
                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">ver</span><span class="p">,</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span>
                        <span class="s2">&quot;last_used_at&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;last_used_at&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">spec</span> <span class="k">else</span> <span class="mf">0.0</span>
                        <span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="n">reverse</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;asc&quot;</span>
            <span class="k">if</span> <span class="n">sort_by</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;last_used_at&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">):</span>
                <span class="n">tools</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sort_by</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">limit</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">limit</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">tools</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
            <span class="c1"># summary stats</span>
            <span class="n">active</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">)</span>
            <span class="n">deprecated</span> <span class="o">=</span> <span class="n">total</span> <span class="o">-</span> <span class="n">active</span>
            <span class="n">usage</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_tool_metrics</span>

                <span class="n">usage</span> <span class="o">=</span> <span class="n">get_tool_metrics</span><span class="p">()</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># naive most/least used by successes+failures in usage</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">usage_count</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                <span class="n">k</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">usage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;successes&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;failures&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="n">most_used</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">usage_count</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">least_used</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">usage_count</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
                <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span>
                <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
                <span class="s2">&quot;counts&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">active</span><span class="p">,</span> <span class="s2">&quot;deprecated&quot;</span><span class="p">:</span> <span class="n">deprecated</span><span class="p">},</span>
                <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="n">items</span><span class="p">,</span>
                <span class="s2">&quot;most_used&quot;</span><span class="p">:</span> <span class="n">most_used</span><span class="p">,</span>
                <span class="s2">&quot;least_used&quot;</span><span class="p">:</span> <span class="n">least_used</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="c1"># Tool execution endpoint (diagnostics only, gated by config)</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;agent_orchestration.diagnostics.allow_tool_execution&quot;</span><span class="p">,</span> <span class="kc">False</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Header</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/tools/execute&quot;</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">tools_execute</span><span class="p">(</span>
                <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                <span class="n">x_ao_diag_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;X-AO-DIAG-KEY&quot;</span><span class="p">),</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="c1"># Authentication: optional API key</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">api_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;agent_orchestration.diagnostics.tool_exec_api_key&quot;</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">api_key</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_ao_diag_key</span> <span class="o">!=</span> <span class="n">api_key</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;/tools/execute unauthorized attempt&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>  <span class="c1"># type: ignore</span>

                        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                            <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;unauthorized&quot;</span><span class="p">},</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>  <span class="c1"># type: ignore</span>

                    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;unauthorized&quot;</span><span class="p">},</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span>
                    <span class="p">)</span>
                <span class="c1"># If allowed and authorized, execute tool via invocation service which resolves callables</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_name&quot;</span><span class="p">))</span>
                    <span class="n">version</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arguments&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;tool_name required&quot;</span><span class="p">}</span>
                    <span class="n">svc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_tool_invocation&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">svc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Build ephemeral service if needed</span>
                        <span class="n">reg</span> <span class="o">=</span> <span class="n">_make_request_local_registry</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span>
                            <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_tool_registry&quot;</span><span class="p">,</span> <span class="kc">None</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;tool registry unavailable&quot;</span><span class="p">}</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.coordinator</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                            <span class="n">ToolCoordinator</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.invocation_service</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                            <span class="n">ToolInvocationService</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="n">coord</span> <span class="o">=</span> <span class="n">ToolCoordinator</span><span class="p">(</span><span class="n">registry</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">)</span>

                        <span class="k">def</span><span class="w"> </span><span class="nf">_resolver</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callable_registry</span><span class="o">.</span><span class="n">resolve_callable</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

                        <span class="n">svc</span> <span class="o">=</span> <span class="n">ToolInvocationService</span><span class="p">(</span>
                            <span class="n">registry</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span>
                            <span class="n">coordinator</span><span class="o">=</span><span class="n">coord</span><span class="p">,</span>
                            <span class="n">policy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">,</span>
                            <span class="n">callable_resolver</span><span class="o">=</span><span class="n">_resolver</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">svc</span><span class="o">.</span><span class="n">invoke_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">}</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_tools_request</span><span class="p">(</span><span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="c1"># Basic per-process soft rate limit</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_t</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">_t</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">window</span> <span class="o">=</span> <span class="mf">60.0</span>
            <span class="n">max_calls</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;agent_orchestration.diagnostics.max_tool_exec_per_min&quot;</span><span class="p">,</span> <span class="mi">30</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_exec_hist&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">hist</span> <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">window</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_calls</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;rate_limited&quot;</span><span class="p">}</span>
            <span class="n">hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exec_hist</span> <span class="o">=</span> <span class="n">hist</span>
            <span class="c1"># Validate payload</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_name&quot;</span><span class="p">))</span>
                <span class="n">version</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arguments&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;tool_name required&quot;</span><span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid payload&quot;</span><span class="p">}</span>
            <span class="c1"># Resolve and invoke with timeout using request-local Redis client to avoid cross-loop issues</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_asyncio</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">timeout_s</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;agent_orchestration.diagnostics.tool_exec_timeout_s&quot;</span><span class="p">,</span> <span class="mf">10.0</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">started</span> <span class="o">=</span> <span class="n">_t</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="c1"># Build per-request registry/coordinator and service</span>
                <span class="n">reg</span> <span class="o">=</span> <span class="n">_make_request_local_registry</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_tool_registry&quot;</span><span class="p">,</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;tool registry not initialized&quot;</span><span class="p">}</span>
                <span class="c1"># Validate against allowed tools patterns, if configured</span>
                <span class="n">allowed</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.allowed_tools&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="p">[]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">allowed</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">fnmatch</span><span class="w"> </span><span class="kn">import</span> <span class="n">fnmatch</span>

                    <span class="n">full</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">version</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="n">fnmatch</span><span class="p">(</span><span class="n">full</span><span class="p">,</span> <span class="n">patt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fnmatch</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:*&quot;</span><span class="p">,</span> <span class="n">patt</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">patt</span> <span class="ow">in</span> <span class="n">allowed</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;tool not allowed&quot;</span><span class="p">}</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.coordinator</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolCoordinator</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.invocation_service</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">ToolInvocationService</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">coord</span> <span class="o">=</span> <span class="n">ToolCoordinator</span><span class="p">(</span><span class="n">registry</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">)</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">_resolver</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callable_registry</span><span class="o">.</span><span class="n">resolve_callable</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

                <span class="n">svc</span> <span class="o">=</span> <span class="n">ToolInvocationService</span><span class="p">(</span>
                    <span class="n">registry</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span>
                    <span class="n">coordinator</span><span class="o">=</span><span class="n">coord</span><span class="p">,</span>
                    <span class="n">policy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_policy</span><span class="p">,</span>
                    <span class="n">callable_resolver</span><span class="o">=</span><span class="n">_resolver</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                    <span class="n">svc</span><span class="o">.</span><span class="n">invoke_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span>
                <span class="p">)</span>
                <span class="n">dur_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">_t</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">started</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.tools.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_tool_metrics</span>

                <span class="n">usage</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">get_tool_metrics</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">version</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;latest&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">,</span>
                    <span class="s2">&quot;duration_ms&quot;</span><span class="p">:</span> <span class="n">dur_ms</span><span class="p">,</span>
                    <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">usage</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">except</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;timeout&quot;</span><span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="c1"># Put /events as the very last route only when WBA is enabled (test expectations)</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.agents.wba.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/events&quot;</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">events</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;diagnostics disabled&quot;</span><span class="p">}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;events&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_ao_events&quot;</span><span class="p">,</span> <span class="p">[]))[</span><span class="o">-</span><span class="mi">500</span><span class="p">:]}</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="c1"># WebSocket endpoints for real-time communication (gated by realtime.enabled)</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.realtime.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.realtime.websocket.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># Initialize WebSocket connection manager</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_ws_connection_manager&quot;</span><span class="p">):</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">src.agent_orchestration.realtime.websocket_manager</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">WebSocketConnectionManager</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_ws_connection_manager</span> <span class="o">=</span> <span class="n">WebSocketConnectionManager</span><span class="p">(</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                    <span class="n">agent_registry</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_agent_registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">redis_client</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_redis_client&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="c1"># Connect event publisher with WebSocket manager</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_event_publisher&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_publisher</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_event_publisher</span><span class="o">.</span><span class="n">add_websocket_manager</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ws_connection_manager</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connected event publisher with WebSocket manager&quot;</span><span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">websocket</span><span class="p">(</span><span class="s2">&quot;/ws&quot;</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">websocket_endpoint</span><span class="p">(</span><span class="n">websocket</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;WebSocket endpoint for real-time agent orchestration communication.&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="mi">1008</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;diagnostics disabled&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_connection_manager</span><span class="o">.</span><span class="n">handle_connection</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">WebSocketDisconnect</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WebSocket error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="mi">1011</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;internal error&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/ws-status&quot;</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">websocket_status</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Get WebSocket connection status.&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.diagnostics.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;diagnostics disabled&quot;</span><span class="p">}</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_ws_connection_manager&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_connection_manager</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;websocket manager not initialized&quot;</span><span class="p">}</span>

        <span class="c1"># Ensure /metrics-prom is the last route when WBA is disabled (some tests rely on last route to be metrics-prom)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.agents.wba.enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">app</span><span class="o">.</span><span class="n">add_api_route</span><span class="p">(</span><span class="s2">&quot;/metrics-prom&quot;</span><span class="p">,</span> <span class="n">metrics_prometheus</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_failure_detection_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval_s</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Periodically run detect_and_recover on the registry.</span>
<span class="sd">            Gated implicitly by component lifecycle; background task created only if diagnostics enabled.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval_s</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">reg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_agent_registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">reg</span><span class="o">.</span><span class="n">detect_and_recover</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="k">return</span> <span class="n">app</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_start_diagnostics_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to start a lightweight diagnostics server on self.port.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;uvicorn not available; skipping diagnostics HTTP server startup&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_diagnostics_app</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;FastAPI unavailable; skipping diagnostics server&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">uvicorn</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span>
            <span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span>
        <span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">uvicorn</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_diag_server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">server</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_register_optimization_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register system parameters for optimization.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_engine</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Register message queue parameters</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_message_coordinator&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_engine</span><span class="o">.</span><span class="n">register_parameter</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;message_queue_size&quot;</span><span class="p">,</span>
                    <span class="n">current_value</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_message_coordinator</span><span class="p">,</span> <span class="s2">&quot;_queue_size&quot;</span><span class="p">,</span> <span class="mi">10000</span>
                    <span class="p">),</span>
                    <span class="n">min_value</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">max_value</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>
                    <span class="n">step_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">parameter_type</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">,</span>
                    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;message_coordinator&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum size of message queues&quot;</span><span class="p">,</span>
                    <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_message_queue_size</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Register heartbeat parameters</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_agent_registry&quot;</span><span class="p">):</span>
                <span class="n">heartbeat_ttl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_orchestration.agents.heartbeat_ttl&quot;</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_engine</span><span class="o">.</span><span class="n">register_parameter</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;heartbeat_interval&quot;</span><span class="p">,</span>
                    <span class="n">current_value</span><span class="o">=</span><span class="n">heartbeat_ttl</span><span class="p">,</span>
                    <span class="n">min_value</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
                    <span class="n">max_value</span><span class="o">=</span><span class="mf">120.0</span><span class="p">,</span>
                    <span class="n">step_size</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
                    <span class="n">parameter_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">,</span>
                    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;agent_registry&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Agent heartbeat interval in seconds&quot;</span><span class="p">,</span>
                    <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_heartbeat_interval</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Registered optimization parameters&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to register optimization parameters: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_message_queue_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update message queue size parameter.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_message_coordinator</span><span class="p">,</span> <span class="s2">&quot;_queue_size&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_message_coordinator</span><span class="o">.</span><span class="n">_queue_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated </span><span class="si">{</span><span class="n">parameter_name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update </span><span class="si">{</span><span class="n">parameter_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_heartbeat_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update heartbeat interval parameter.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># This would require updating the agent registry configuration</span>
            <span class="c1"># For now, just log the change</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Optimization suggests updating </span><span class="si">{</span><span class="n">parameter_name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_value</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update </span><span class="si">{</span><span class="n">parameter_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, TTA Development Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

</body>
</html>
