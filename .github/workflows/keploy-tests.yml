name: Automated API Testing with Keploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  keploy-api-tests:
    name: Keploy API Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Sync dependencies
        run: uv sync --all-extras

      - name: Pull Keploy Docker image
        run: docker pull ghcr.io/keploy/keploy:latest

      - name: Start Test API
        run: |
          uv run python simple_test_api.py > /tmp/api.log 2>&1 &
          sleep 5

      - name: Run Keploy automated tests
        run: |
          chmod +x run-keploy-tests.py
          uv run python run-keploy-tests.py

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: keploy-test-results
          path: keploy/tests/
          retention-days: 30

      - name: Upload API logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: api-logs
          path: /tmp/api.log
          retention-days: 7

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const testCount = fs.readdirSync('keploy/tests').filter(f => f.endsWith('.yaml')).length;
            const body = `## ðŸŽ¯ Keploy Automated API Tests

            âœ… **All tests passed!**

            ðŸ“Š **Coverage**: ${testCount} automated test scenarios

            ðŸš€ **Benefits**:
            - Zero manual test writing
            - Real API behavior validation
            - Instant regression detection

            Generated from real API interactions with Keploy automation.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Sync dependencies
        run: uv sync --all-extras

      - name: Run unit tests
        run: uv run pytest tests/unit/ -v --cov=src --cov-branch --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: keploy-unit
          name: keploy-unit-tests
          fail_ci_if_error: false
