<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenRouter Authentication Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-4">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">
            üîê OpenRouter Authentication Test
        </h1>

        <!-- Authentication Status -->
        <div id="authStatus" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Authentication Status</h2>
            <div id="statusContent" class="text-gray-600">
                <div class="spinner inline-block mr-2"></div>
                Checking authentication status...
            </div>
        </div>

        <!-- Authentication Form -->
        <div id="authForm" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">OpenRouter Authentication</h2>

            <!-- Tab Navigation -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="flex space-x-8">
                    <button id="apiKeyTab" class="py-2 px-1 border-b-2 font-medium text-sm transition-colors duration-200 border-blue-500 text-blue-600">
                        üîë API Key
                    </button>
                    <button id="oauthTab" class="py-2 px-1 border-b-2 font-medium text-sm transition-colors duration-200 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        üåê OAuth
                    </button>
                </nav>
            </div>

            <!-- API Key Tab Content -->
            <div id="apiKeyContent" class="space-y-4">
                <div>
                    <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-2">
                        OpenRouter API Key
                    </label>
                    <input
                        type="password"
                        id="apiKey"
                        placeholder="sk-or-..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-sm text-gray-500 mt-1">
                        Enter your OpenRouter API key. For testing, use "sk-or-test123"
                    </p>
                </div>
                <button
                    id="validateApiKey"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200"
                >
                    Validate API Key
                </button>
            </div>

            <!-- OAuth Tab Content -->
            <div id="oauthContent" class="space-y-4 hidden">
                <div class="text-center">
                    <p class="text-gray-600 mb-4">
                        Sign in with your OpenRouter account using OAuth 2.0
                    </p>
                    <button
                        id="oauthLogin"
                        class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg transition-colors duration-200"
                    >
                        Sign in with OpenRouter
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div id="testResults" class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div id="resultsContent" class="text-gray-600">
                No tests run yet.
            </div>
        </div>

        <!-- Logout Button -->
        <div id="logoutSection" class="text-center mt-6 hidden">
            <button
                id="logoutBtn"
                class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200"
            >
                Logout
            </button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';

        // DOM elements
        const apiKeyTab = document.getElementById('apiKeyTab');
        const oauthTab = document.getElementById('oauthTab');
        const apiKeyContent = document.getElementById('apiKeyContent');
        const oauthContent = document.getElementById('oauthContent');
        const apiKeyInput = document.getElementById('apiKey');
        const validateApiKeyBtn = document.getElementById('validateApiKey');
        const oauthLoginBtn = document.getElementById('oauthLogin');
        const statusContent = document.getElementById('statusContent');
        const resultsContent = document.getElementById('resultsContent');
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutSection = document.getElementById('logoutSection');

        // Tab switching
        apiKeyTab.addEventListener('click', () => switchTab('apiKey'));
        oauthTab.addEventListener('click', () => switchTab('oauth'));

        function switchTab(tab) {
            if (tab === 'apiKey') {
                apiKeyTab.className = 'py-2 px-1 border-b-2 font-medium text-sm transition-colors duration-200 border-blue-500 text-blue-600';
                oauthTab.className = 'py-2 px-1 border-b-2 font-medium text-sm transition-colors duration-200 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
                apiKeyContent.classList.remove('hidden');
                oauthContent.classList.add('hidden');
            } else {
                oauthTab.className = 'py-2 px-1 border-b-2 font-medium text-sm transition-colors duration-200 border-blue-500 text-blue-600';
                apiKeyTab.className = 'py-2 px-1 border-b-2 font-medium text-sm transition-colors duration-200 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
                oauthContent.classList.remove('hidden');
                apiKeyContent.classList.add('hidden');
            }
        }

        // API functions
        async function checkAuthStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/openrouter/auth/status`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.authenticated) {
                    statusContent.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <span class="font-medium text-green-700">Authenticated</span>
                        </div>
                        <div class="mt-2 text-sm">
                            <p><strong>Method:</strong> ${data.auth_method}</p>
                            <p><strong>User:</strong> ${data.user.name} (${data.user.email})</p>
                            <p><strong>Credits:</strong> ${data.user.credits}</p>
                        </div>
                    `;
                    logoutSection.classList.remove('hidden');
                } else {
                    statusContent.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <span class="font-medium text-red-700">Not Authenticated</span>
                        </div>
                    `;
                    logoutSection.classList.add('hidden');
                }
            } catch (error) {
                statusContent.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                        <span class="font-medium text-yellow-700">Error checking status</span>
                    </div>
                    <div class="mt-2 text-sm text-red-600">${error.message}</div>
                `;
            }
        }

        async function validateApiKey() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                addTestResult('‚ùå Please enter an API key', 'error');
                return;
            }

            validateApiKeyBtn.disabled = true;
            validateApiKeyBtn.innerHTML = '<div class="spinner inline-block mr-2"></div>Validating...';

            try {
                const response = await fetch(`${API_BASE}/api/v1/openrouter/auth/validate-key`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        api_key: apiKey,
                        validate_only: false
                    })
                });

                const data = await response.json();

                if (data.valid) {
                    addTestResult('‚úÖ API key validation successful!', 'success');
                    addTestResult(`üë§ User: ${data.user.name} (${data.user.email})`, 'info');
                    addTestResult(`üí∞ Credits: ${data.user.credits}`, 'info');
                    await checkAuthStatus();
                } else {
                    addTestResult(`‚ùå API key validation failed: ${data.error}`, 'error');
                }
            } catch (error) {
                addTestResult(`‚ùå Error validating API key: ${error.message}`, 'error');
            } finally {
                validateApiKeyBtn.disabled = false;
                validateApiKeyBtn.innerHTML = 'Validate API Key';
            }
        }

        async function initiateOAuth() {
            oauthLoginBtn.disabled = true;
            oauthLoginBtn.innerHTML = '<div class="spinner inline-block mr-2"></div>Initiating...';

            try {
                const response = await fetch(`${API_BASE}/api/v1/openrouter/auth/oauth/initiate`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.auth_url) {
                    addTestResult('üåê OAuth flow initiated successfully!', 'success');
                    addTestResult(`üîó Auth URL: ${data.auth_url}`, 'info');

                    // Open OAuth URL in new window
                    window.open(data.auth_url, 'oauth', 'width=600,height=700');
                } else {
                    addTestResult('‚ùå Failed to initiate OAuth flow', 'error');
                }
            } catch (error) {
                addTestResult(`‚ùå Error initiating OAuth: ${error.message}`, 'error');
            } finally {
                oauthLoginBtn.disabled = false;
                oauthLoginBtn.innerHTML = 'Sign in with OpenRouter';
            }
        }

        async function logout() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/openrouter/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    addTestResult('‚úÖ Logged out successfully', 'success');
                    await checkAuthStatus();
                } else {
                    addTestResult('‚ùå Logout failed', 'error');
                }
            } catch (error) {
                addTestResult(`‚ùå Error during logout: ${error.message}`, 'error');
            }
        }

        function addTestResult(message, type) {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'success' ? 'text-green-600' :
                              type === 'error' ? 'text-red-600' : 'text-blue-600';

            const resultDiv = document.createElement('div');
            resultDiv.className = `border-l-4 pl-4 py-2 mb-2 ${
                type === 'success' ? 'border-green-500 bg-green-50' :
                type === 'error' ? 'border-red-500 bg-red-50' : 'border-blue-500 bg-blue-50'
            }`;
            resultDiv.innerHTML = `
                <div class="${colorClass} font-medium">${message}</div>
                <div class="text-xs text-gray-500 mt-1">${timestamp}</div>
            `;

            if (resultsContent.textContent === 'No tests run yet.') {
                resultsContent.innerHTML = '';
            }

            resultsContent.insertBefore(resultDiv, resultsContent.firstChild);
        }

        // Event listeners
        validateApiKeyBtn.addEventListener('click', validateApiKey);
        oauthLoginBtn.addEventListener('click', initiateOAuth);
        logoutBtn.addEventListener('click', logout);

        // Initialize
        checkAuthStatus();
    </script>
</body>
</html>
